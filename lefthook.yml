# Lefthook configuration for Angzarr
# Git hooks manager for automated quality checks

pre-commit:
  parallel: false  # Must run sequentially for build -> boot -> test
  commands:
    format-check:
      glob: "*.rs"
      run: cargo fmt --all -- --check
      fail_text: "Code formatting check failed. Run 'cargo fmt' to fix."

    lint:
      glob: "*.rs"
      run: cargo clippy --workspace -- -D warnings
      fail_text: "Linter found issues. Fix them before committing."

    build-workspace:
      run: cargo build --workspace
      fail_text: "Workspace build failed. Fix compilation errors."

    abi-check:
      run: just check-abi
      fail_text: "ABI compatibility check failed. Binary layout doesn't match Linux."

    build-kernel:
      run: just build-kernel-bin
      fail_text: "Kernel build failed. Fix kernel compilation errors."

    test-lib:
      run: cargo test --workspace --lib
      fail_text: "Library tests failed. Fix them before committing."

    boot-test:
      run: |
        # Quick boot test - verify kernel can start (timeout after 5 seconds)
        timeout 5s qemu-system-x86_64 -nographic -kernel angzarr-kernel/target/x86_64-unknown-none/release/angzarr-kernel || true
        echo "âœ“ Kernel boot verified"
      fail_text: "Kernel boot test failed."

pre-push:
  parallel: false
  commands:
    full-test:
      run: cargo test --workspace
      fail_text: "Full test suite failed."

    build-check:
      run: cargo build --workspace
      fail_text: "Build failed."

commit-msg:
  commands:
    check-message:
      run: |
        if ! head -1 $1 | grep -qE "^(feat|fix|docs|style|refactor|test|chore|perf)(\(.+\))?: .{1,}$"; then
          echo "Commit message must follow conventional commits format:"
          echo "  type(scope?): description"
          echo "  "
          echo "  Examples:"
          echo "    feat: add new feature"
          echo "    fix(list): correct memory leak"
          echo "    docs: update README"
          exit 1
        fi
