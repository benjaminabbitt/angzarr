# Kind cluster configuration for angzarr-rs development
# Create cluster: kind create cluster --config kind-config.yaml --name angzarr
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
# Configure containerd to use local registry
containerdConfigPatches:
  - |-
    [plugins."io.containerd.grpc.v1.cri".registry]
      config_path = "/etc/containerd/certs.d"
nodes:
  - role: control-plane
    extraMounts:
      - hostPath: .kind-registry-config
        containerPath: /etc/containerd/certs.d
    kubeadmConfigPatches:
      - |
        kind: InitConfiguration
        nodeRegistration:
          kubeletExtraArgs:
            node-labels: "ingress-ready=true"
      - |
        kind: KubeletConfiguration
        # Allow more pods and increase resource headroom
        maxPods: 200
        systemReserved:
          cpu: "500m"
          memory: "512Mi"
        kubeReserved:
          cpu: "500m"
          memory: "512Mi"
    extraPortMappings:
      # Ingress HTTP (for gRPC via nginx-ingress)
      - containerPort: 80
        hostPort: 8080
        protocol: TCP
      # Ingress HTTPS
      - containerPort: 443
        hostPort: 8443
        protocol: TCP
      # Angzarr command handler (NodePort fallback)
      - containerPort: 30051
        hostPort: 50051
        protocol: TCP
      # Angzarr event query (NodePort fallback)
      - containerPort: 30052
        hostPort: 50052
        protocol: TCP
      # Angzarr gateway (NodePort fallback)
      - containerPort: 30053
        hostPort: 50053
        protocol: TCP
      # Angzarr stream (NodePort fallback)
      - containerPort: 30054
        hostPort: 50054
        protocol: TCP
      # RabbitMQ AMQP
      - containerPort: 30672
        hostPort: 5672
        protocol: TCP
      # RabbitMQ Management UI
      - containerPort: 31672
        hostPort: 15672
        protocol: TCP
      # Redis
      - containerPort: 30379
        hostPort: 6379
        protocol: TCP
