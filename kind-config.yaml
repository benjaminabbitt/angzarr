# Kind cluster configuration for angzarr-rs development
# Create cluster: kind create cluster --config kind-config.yaml --name angzarr
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
# Configure containerd to use local registry
containerdConfigPatches:
  - |-
    [plugins."io.containerd.grpc.v1.cri".registry]
      config_path = "/etc/containerd/certs.d"
nodes:
  - role: control-plane
    extraMounts:
      - hostPath: .kind-registry-config
        containerPath: /etc/containerd/certs.d
    kubeadmConfigPatches:
      - |
        kind: InitConfiguration
        nodeRegistration:
          kubeletExtraArgs:
            node-labels: "ingress-ready=true"
      - |
        kind: KubeletConfiguration
        # Allow more pods and increase resource headroom
        maxPods: 200
        systemReserved:
          cpu: "500m"
          memory: "512Mi"
        kubeReserved:
          cpu: "500m"
          memory: "512Mi"
    extraPortMappings:
      # Ingress HTTP (for gRPC via nginx-ingress)
      - containerPort: 80
        hostPort: 8080
        protocol: TCP
      # Ingress HTTPS
      - containerPort: 443
        hostPort: 8443
        protocol: TCP
      # =============================================================================
      # Angzarr Port Scheme (10-port ranges per component)
      # x0: sidecar gRPC      x5: business gRPC
      # x1: sidecar debug     x6: business debug
      # =============================================================================
      # Gateway (1350-1359) - primary entry point
      - containerPort: 31350
        hostPort: 1350
        protocol: TCP
      # Stream (1340-1349)
      - containerPort: 31340
        hostPort: 1340
        protocol: TCP
      # Aggregate sidecar (1310-1319)
      - containerPort: 31310
        hostPort: 1310
        protocol: TCP
      # RabbitMQ AMQP
      - containerPort: 30672
        hostPort: 5672
        protocol: TCP
      # RabbitMQ Management UI
      - containerPort: 31672
        hostPort: 15672
        protocol: TCP
      # Redis
      - containerPort: 30379
        hostPort: 6379
        protocol: TCP
