name: Integration Tests (Matrix)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      language:
        description: 'Language to test (or "all")'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - rust
          - go
          - python

env:
  CARGO_TERM_COLOR: always
  KIND_VERSION: v0.20.0
  KUBECTL_VERSION: v1.28.0
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/angzarr

permissions:
  contents: read
  packages: write

jobs:
  # Build base image (always on push, cache makes it fast)
  build-base-image:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push base image
        uses: docker/build-push-action@v5
        with:
          context: build/images/base
          file: build/images/base/Containerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-base:latest
          cache-from: type=gha,scope=base
          cache-to: type=gha,mode=max,scope=base

  # Build rust image (always on push, cache makes it fast)
  build-rust-image:
    needs: build-base-image
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push rust image
        uses: docker/build-push-action@v5
        with:
          context: build/images/rust
          file: build/images/rust/Containerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-rust:latest
          build-args: |
            BASE_IMAGE=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-base:latest
          cache-from: type=gha,scope=rust
          cache-to: type=gha,mode=max,scope=rust

  # Build core framework (shared by all language tests)
  build-framework:
    needs: build-rust-image
    if: always() && (needs.build-rust-image.result == 'success' || needs.build-rust-image.result == 'skipped')
    runs-on: ubuntu-latest
    container: ghcr.io/${{ github.repository_owner }}/angzarr-rust:latest
    steps:
      - uses: actions/checkout@v4

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build framework
        run: cargo build --release --bin angzarr-standalone --features "standalone,amqp"

      - name: Upload framework binary
        uses: actions/upload-artifact@v4
        with:
          name: framework-binary
          path: target/release/angzarr-standalone
          retention-days: 1

  # Matrix test for each language
  integration-test:
    needs: build-framework
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        language: [rust, go, python]
        exclude:
          - language: ${{ github.event.inputs.language != 'all' && github.event.inputs.language != 'rust' && 'rust' || '' }}
          - language: ${{ github.event.inputs.language != 'all' && github.event.inputs.language != 'go' && 'go' || '' }}
          - language: ${{ github.event.inputs.language != 'all' && github.event.inputs.language != 'python' && 'python' || '' }}

    steps:
      - uses: actions/checkout@v4

      - name: Download framework binary
        uses: actions/download-artifact@v4
        with:
          name: framework-binary
          path: target/release/

      - name: Make binary executable
        run: chmod +x target/release/angzarr-standalone

      - name: Install Kind
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/${{ env.KIND_VERSION }}/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/${{ env.KUBECTL_VERSION }}/bin/linux/amd64/kubectl"
          chmod +x ./kubectl
          sudo mv ./kubectl /usr/local/bin/kubectl

      - name: Install just
        uses: extractions/setup-just@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Language-specific setup (needs Docker access, can't use container)
      - name: Set up Rust
        if: matrix.language == 'rust'
        uses: dtolnay/rust-toolchain@stable

      - name: Install mold linker (Rust)
        if: matrix.language == 'rust'
        run: |
          sudo apt-get update
          sudo apt-get install -y mold

      - name: Set up Go
        if: matrix.language == 'go'
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Set up Python
        if: matrix.language == 'python'
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # Create Kind cluster
      - name: Create Kind cluster
        run: |
          kind create cluster --config kind-config.yaml --name angzarr
          kubectl cluster-info

      # Build and load images for the specific language
      - name: Build ${{ matrix.language }} images
        run: just images-build-${{ matrix.language }}

      - name: Load images into Kind
        run: just images-load-${{ matrix.language }}

      # Deploy infrastructure
      - name: Deploy infrastructure
        run: |
          just images-pull-infra
          just images-load-infra
          kubectl apply -f k8s/base/namespace.yaml
          kubectl apply -f k8s/base/secrets.yaml
          kubectl apply -f k8s/base/redis.yaml
          kubectl apply -f k8s/base/rabbitmq.yaml
          kubectl apply -f k8s/base/mongodb.yaml

      # Deploy language-specific services
      - name: Deploy ${{ matrix.language }} services
        run: |
          just k8s-apply-${{ matrix.language }}
          kubectl wait --for=condition=ready pod -l app=angzarr -n angzarr --timeout=180s || true

      # Run integration tests
      - name: Run integration tests
        run: |
          ANGZARR_TEST_MODE=container cargo test --test acceptance -- --test-threads=1
        env:
          TEST_LANGUAGE: ${{ matrix.language }}

      # Collect logs on failure
      - name: Collect logs on failure
        if: failure()
        run: |
          kubectl logs -n angzarr -l app=angzarr --tail=100 || true
          kubectl describe pods -n angzarr || true

      # Cleanup
      - name: Delete Kind cluster
        if: always()
        run: kind delete cluster --name angzarr || true

  # Aggregate results
  test-results:
    needs: integration-test
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.integration-test.result }}" == "failure" ]; then
            echo "Some integration tests failed"
            exit 1
          fi
          echo "All integration tests passed"
