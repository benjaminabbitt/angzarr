name: Client Libraries Release

on:
  push:
    tags:
      - 'client-rust/v*.*.*'
      - 'client-python/v*.*.*'
      - 'client/go/v*.*.*'
      - 'client-java/v*.*.*'
      - 'client-csharp/v*.*.*'
      - 'client-cpp/v*.*.*'

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/angzarr

permissions:
  contents: write
  id-token: write
  packages: write

jobs:
  # Determine which client(s) to release based on the tag
  detect:
    runs-on: ubuntu-latest
    outputs:
      rust: ${{ steps.check.outputs.rust }}
      python: ${{ steps.check.outputs.python }}
      go: ${{ steps.check.outputs.go }}
      java: ${{ steps.check.outputs.java }}
      csharp: ${{ steps.check.outputs.csharp }}
      cpp: ${{ steps.check.outputs.cpp }}
      version: ${{ steps.check.outputs.version }}
    steps:
      - name: Detect release type
        id: check
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "Tag: $TAG"

          if [[ "$TAG" == client-rust/v* ]]; then
            echo "rust=true" >> $GITHUB_OUTPUT
            echo "version=${TAG#client-rust/v}" >> $GITHUB_OUTPUT
          elif [[ "$TAG" == client-python/v* ]]; then
            echo "python=true" >> $GITHUB_OUTPUT
            echo "version=${TAG#client-python/v}" >> $GITHUB_OUTPUT
          elif [[ "$TAG" == client/go/v* ]]; then
            echo "go=true" >> $GITHUB_OUTPUT
            echo "version=${TAG#client/go/v}" >> $GITHUB_OUTPUT
          elif [[ "$TAG" == client-java/v* ]]; then
            echo "java=true" >> $GITHUB_OUTPUT
            echo "version=${TAG#client-java/v}" >> $GITHUB_OUTPUT
          elif [[ "$TAG" == client-csharp/v* ]]; then
            echo "csharp=true" >> $GITHUB_OUTPUT
            echo "version=${TAG#client-csharp/v}" >> $GITHUB_OUTPUT
          elif [[ "$TAG" == client-cpp/v* ]]; then
            echo "cpp=true" >> $GITHUB_OUTPUT
            echo "version=${TAG#client-cpp/v}" >> $GITHUB_OUTPUT
          fi

  # Publish Rust client to crates.io
  rust:
    needs: detect
    if: needs.detect.outputs.rust == 'true'
    runs-on: ubuntu-latest
    container:
      image: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-rust:latest
    steps:
      - uses: actions/checkout@v4

      - name: Verify version matches
        working-directory: client/rust
        run: |
          CARGO_VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          TAG_VERSION=${{ needs.detect.outputs.version }}
          if [ "$CARGO_VERSION" != "$TAG_VERSION" ]; then
            echo "ERROR: Cargo.toml version ($CARGO_VERSION) does not match tag ($TAG_VERSION)"
            exit 1
          fi

      - name: Build and test
        working-directory: client/rust
        run: just --justfile justfile.container build && just --justfile justfile.container test

      # TODO: Re-enable when ready to publish
      # - name: Publish to crates.io
      #   working-directory: client/rust
      #   run: just --justfile justfile.container publish
      #   env:
      #     CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

  # Publish Python client to PyPI
  python:
    needs: detect
    if: needs.detect.outputs.python == 'true'
    runs-on: ubuntu-latest
    container:
      image: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-python:latest
    steps:
      - uses: actions/checkout@v4

      - name: Verify version matches
        working-directory: client/python
        run: |
          PYPROJECT_VERSION=$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          TAG_VERSION=${{ needs.detect.outputs.version }}
          if [ "$PYPROJECT_VERSION" != "$TAG_VERSION" ]; then
            echo "ERROR: pyproject.toml version ($PYPROJECT_VERSION) does not match tag ($TAG_VERSION)"
            exit 1
          fi

      - name: Build and test
        working-directory: client/python
        run: just --justfile justfile.container build && just --justfile justfile.container test

      # TODO: Re-enable when ready to publish
      # - name: Publish to PyPI
      #   working-directory: client/python
      #   run: just --justfile justfile.container publish
      #   env:
      #     TWINE_USERNAME: __token__
      #     TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}

  # Go releases via tags - Go modules auto-discover from tags
  go:
    needs: detect
    if: needs.detect.outputs.go == 'true'
    runs-on: ubuntu-latest
    container:
      image: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-go:latest
    steps:
      - uses: actions/checkout@v4

      - name: Build and test
        working-directory: client/go
        run: just --justfile justfile.container build && just --justfile justfile.container test

      - name: Create release notes
        run: |
          VERSION=${{ needs.detect.outputs.version }}
          cat << EOF > release-notes.md
          ## Go Client v${VERSION}

          ### Installation

          \`\`\`bash
          go get github.com/${{ github.repository }}/client/go@v${VERSION}
          \`\`\`

          ### Usage

          \`\`\`go
          import angzarr "github.com/${{ github.repository }}/client/go"

          client, err := angzarr.NewClient("localhost:1310")
          if err != nil {
              log.Fatal(err)
          }
          defer client.Close()
          \`\`\`
          EOF

      # TODO: Re-enable when ready to publish
      # - name: Create GitHub Release
      #   uses: softprops/action-gh-release@v1
      #   with:
      #     body_path: release-notes.md
      #     draft: false
      #     prerelease: ${{ contains(needs.detect.outputs.version, '-') }}
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Publish Java client to GitHub Packages
  java:
    needs: detect
    if: needs.detect.outputs.java == 'true'
    runs-on: ubuntu-latest
    container:
      image: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-java:latest
    steps:
      - uses: actions/checkout@v4

      - name: Verify version matches
        working-directory: client/java
        run: |
          BUILD_VERSION=$(grep '^version = ' build.gradle.kts | head -1 | sed 's/.*version = "\(.*\)".*/\1/')
          TAG_VERSION=${{ needs.detect.outputs.version }}
          if [ "$BUILD_VERSION" != "$TAG_VERSION" ]; then
            echo "ERROR: build.gradle.kts version ($BUILD_VERSION) does not match tag ($TAG_VERSION)"
            exit 1
          fi

      - name: Build and test
        working-directory: client/java
        run: just --justfile justfile.container build && just --justfile justfile.container test

      # TODO: Re-enable when ready to publish
      # - name: Publish to GitHub Packages
      #   working-directory: client/java
      #   run: just --justfile justfile.container publish
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #     GITHUB_ACTOR: ${{ github.actor }}

  # Publish C# client to NuGet
  csharp:
    needs: detect
    if: needs.detect.outputs.csharp == 'true'
    runs-on: ubuntu-latest
    container:
      image: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-csharp:latest
    steps:
      - uses: actions/checkout@v4

      - name: Verify version matches
        working-directory: client/csharp/Angzarr.Client
        run: |
          CSPROJ_VERSION=$(grep '<Version>' Angzarr.Client.csproj | sed 's/.*<Version>\(.*\)<\/Version>.*/\1/')
          TAG_VERSION=${{ needs.detect.outputs.version }}
          if [ "$CSPROJ_VERSION" != "$TAG_VERSION" ]; then
            echo "ERROR: Angzarr.Client.csproj version ($CSPROJ_VERSION) does not match tag ($TAG_VERSION)"
            exit 1
          fi

      - name: Build, test, and pack
        working-directory: client/csharp
        run: |
          just --justfile justfile.container build
          just --justfile justfile.container test
          just --justfile justfile.container pack

      # TODO: Re-enable when ready to publish
      # - name: Publish to NuGet
      #   working-directory: client/csharp
      #   run: just --justfile justfile.container publish
      #   env:
      #     NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}

  # Publish C++ client as GitHub Release with source archive
  cpp:
    needs: detect
    if: needs.detect.outputs.cpp == 'true'
    runs-on: ubuntu-latest
    container:
      image: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-cpp:latest
    steps:
      - uses: actions/checkout@v4

      - name: Verify version matches
        working-directory: client/cpp
        run: |
          CMAKE_VERSION=$(grep 'project(angzarr-client VERSION' CMakeLists.txt | sed 's/.*VERSION \([0-9.]*\).*/\1/')
          TAG_VERSION=${{ needs.detect.outputs.version }}
          if [ "$CMAKE_VERSION" != "$TAG_VERSION" ]; then
            echo "ERROR: CMakeLists.txt version ($CMAKE_VERSION) does not match tag ($TAG_VERSION)"
            exit 1
          fi

      - name: Build and test
        working-directory: client/cpp
        run: |
          just --justfile justfile.container build
          just --justfile justfile.container test

      - name: Create archive
        working-directory: client/cpp
        run: just --justfile justfile.container archive ${{ needs.detect.outputs.version }}

      - name: Create release notes
        run: |
          VERSION=${{ needs.detect.outputs.version }}
          cat << 'EOF' > release-notes.md
          ## C++ Client v${{ needs.detect.outputs.version }}

          ### Installation via vcpkg

          Add to your `vcpkg-configuration.json`:
          ```json
          {
            "registries": [
              {
                "kind": "git",
                "repository": "https://github.com/angzarr-io/vcpkg-registry",
                "baseline": "<commit-sha>",
                "packages": ["angzarr-client"]
              }
            ]
          }
          ```

          Then install:
          ```bash
          vcpkg install angzarr-client
          ```

          ### Manual Installation

          Download the source archive and build with CMake:
          ```bash
          tar xzf angzarr-client-cpp-${{ needs.detect.outputs.version }}.tar.gz
          cd angzarr-client-cpp-${{ needs.detect.outputs.version }}
          cmake -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build
          cmake --install build --prefix /usr/local
          ```
          EOF

      # TODO: Re-enable when ready to publish
      # - name: Create GitHub Release
      #   uses: softprops/action-gh-release@v1
      #   with:
      #     body_path: release-notes.md
      #     files: |
      #       client/cpp/angzarr-client-cpp-${{ needs.detect.outputs.version }}.tar.gz
      #       client/cpp/angzarr-client-cpp-${{ needs.detect.outputs.version }}.tar.gz.sha512
      #     draft: false
      #     prerelease: ${{ contains(needs.detect.outputs.version, '-') }}
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
