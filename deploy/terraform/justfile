# Terraform infrastructure commands for angzarr
# Deploys backing services: databases (PostgreSQL/MongoDB) and messaging (RabbitMQ/Kafka)

set shell := ["bash", "-c"]

TOP := `git rev-parse --show-toplevel`
TF_DIR := TOP + "/deploy/terraform"

# Show available commands
default:
    @just --list

# === Terraform Primitives ===

# Initialize Terraform for an environment (local, staging, prod)
init ENV:
    cd "{{TF_DIR}}/environments/{{ENV}}" && terraform init

# Plan Terraform changes for an environment
plan ENV:
    cd "{{TF_DIR}}/environments/{{ENV}}" && terraform plan

# Apply Terraform changes for an environment
apply ENV:
    cd "{{TF_DIR}}/environments/{{ENV}}" && terraform apply

# Apply Terraform changes (auto-approve) for an environment
apply-auto ENV:
    cd "{{TF_DIR}}/environments/{{ENV}}" && terraform apply -auto-approve

# Destroy Terraform resources for an environment
destroy ENV:
    cd "{{TF_DIR}}/environments/{{ENV}}" && terraform destroy

# Destroy Terraform resources (auto-approve) for an environment
destroy-auto ENV:
    cd "{{TF_DIR}}/environments/{{ENV}}" && terraform destroy -auto-approve

# Show Terraform outputs for an environment
output ENV:
    cd "{{TF_DIR}}/environments/{{ENV}}" && terraform output

# Validate Terraform configuration for an environment
validate ENV:
    cd "{{TF_DIR}}/environments/{{ENV}}" && terraform validate

# Format all Terraform files
fmt:
    terraform fmt -recursive "{{TF_DIR}}"
