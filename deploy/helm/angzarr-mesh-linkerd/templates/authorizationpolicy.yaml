{{- /* AuthorizationPolicy for each aggregate service */ -}}
{{- range .Values.aggregates.domains }}
---
apiVersion: policy.linkerd.io/v1alpha1
kind: AuthorizationPolicy
metadata:
  name: {{ .service }}
  namespace: {{ $.Values.angzarrNamespace }}
  labels:
    app.kubernetes.io/name: angzarr-mesh-linkerd
    app.kubernetes.io/component: authorizationpolicy
spec:
  targetRef:
    group: policy.linkerd.io
    kind: Server
    name: {{ .service }}
  requiredAuthenticationRefs:
    {{- if $.Values.authorization.mtls }}
    - name: mesh-tls
      kind: MeshTLSAuthentication
      group: policy.linkerd.io
    {{- end }}
    {{- if $.Values.authorization.allowUnauthenticated }}
    - name: allow-all
      kind: NetworkAuthentication
      group: policy.linkerd.io
    {{- end }}
{{- end }}
{{- /* AuthorizationPolicy for stream service */ -}}
{{- if .Values.stream.enabled }}
---
apiVersion: policy.linkerd.io/v1alpha1
kind: AuthorizationPolicy
metadata:
  name: {{ .Values.stream.service }}
  namespace: {{ .Values.angzarrNamespace }}
  labels:
    app.kubernetes.io/name: angzarr-mesh-linkerd
    app.kubernetes.io/component: authorizationpolicy
spec:
  targetRef:
    group: policy.linkerd.io
    kind: Server
    name: {{ .Values.stream.service }}
  requiredAuthenticationRefs:
    {{- if .Values.authorization.mtls }}
    - name: mesh-tls
      kind: MeshTLSAuthentication
      group: policy.linkerd.io
    {{- end }}
    {{- if .Values.authorization.allowUnauthenticated }}
    - name: allow-all
      kind: NetworkAuthentication
      group: policy.linkerd.io
    {{- end }}
{{- end }}
{{- /* MeshTLSAuthentication for mTLS */ -}}
{{- if .Values.authorization.mtls }}
---
apiVersion: policy.linkerd.io/v1alpha1
kind: MeshTLSAuthentication
metadata:
  name: mesh-tls
  namespace: {{ .Values.angzarrNamespace }}
  labels:
    app.kubernetes.io/name: angzarr-mesh-linkerd
    app.kubernetes.io/component: authentication
spec:
  identities:
    - "*"
{{- end }}
{{- /* NetworkAuthentication for unauthenticated access */ -}}
{{- if .Values.authorization.allowUnauthenticated }}
---
apiVersion: policy.linkerd.io/v1alpha1
kind: NetworkAuthentication
metadata:
  name: allow-all
  namespace: {{ .Values.angzarrNamespace }}
  labels:
    app.kubernetes.io/name: angzarr-mesh-linkerd
    app.kubernetes.io/component: authentication
spec:
  networks:
    - cidr: 0.0.0.0/0
    - cidr: "::/0"
{{- end }}
