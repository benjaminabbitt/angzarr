apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: angzarr-routes
  namespace: {{ .Values.angzarrNamespace }}
  labels:
    app.kubernetes.io/name: angzarr-mesh-istio
    app.kubernetes.io/component: virtualservice
spec:
  hosts:
    {{- range .Values.gateway.hosts }}
    - {{ . | quote }}
    {{- end }}
  gateways:
    - angzarr-gateway
  http:
    {{- /* EventStream routing */ -}}
    {{- if .Values.stream.enabled }}
    - name: stream
      match:
        - uri:
            prefix: /angzarr.EventStream/
      route:
        - destination:
            host: {{ .Values.stream.service }}.{{ .Values.angzarrNamespace }}.svc.cluster.local
            port:
              number: {{ .Values.stream.port }}
      timeout: {{ .Values.trafficPolicy.timeout }}
      retries:
        attempts: {{ .Values.trafficPolicy.retries.attempts }}
        perTryTimeout: {{ .Values.trafficPolicy.retries.perTryTimeout }}
        retryOn: {{ .Values.trafficPolicy.retries.retryOn }}
    {{- end }}
    {{- /* Aggregate routing by domain header */ -}}
    {{- range .Values.aggregates.domains }}
    - name: aggregate-{{ .name }}
      match:
        - headers:
            x-angzarr-domain:
              exact: {{ .name }}
      route:
        - destination:
            host: {{ .service }}.{{ $.Values.angzarrNamespace }}.svc.cluster.local
            port:
              number: {{ .port }}
      timeout: {{ $.Values.trafficPolicy.timeout }}
      retries:
        attempts: {{ $.Values.trafficPolicy.retries.attempts }}
        perTryTimeout: {{ $.Values.trafficPolicy.retries.perTryTimeout }}
        retryOn: {{ $.Values.trafficPolicy.retries.retryOn }}
    {{- end }}
