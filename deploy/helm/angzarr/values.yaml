# Default values for angzarr
# Angzarr runs as a sidecar providing event sourcing infrastructure

replicaCount: 1

# Angzarr sidecar images (separate binaries per mode)
images:
  aggregate:
    repository: angzarr-aggregate
    pullPolicy: IfNotPresent
    tag: "latest"
  projector:
    repository: angzarr-projector
    pullPolicy: IfNotPresent
    tag: "latest"
  saga:
    repository: angzarr-saga
    pullPolicy: IfNotPresent
    tag: "latest"
  stream:
    repository: angzarr-stream
    pullPolicy: IfNotPresent
    tag: "latest"
  gateway:
    repository: angzarr-gateway
    pullPolicy: IfNotPresent
    tag: "latest"
  log:
    repository: angzarr-log
    pullPolicy: IfNotPresent
    tag: "latest"

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

serviceAccount:
  create: true
  annotations: {}
  name: ""

podAnnotations: {}
podLabels: {}

podSecurityContext:
  fsGroup: 1000

securityContext:
  runAsNonRoot: true
  runAsUser: 1000
  readOnlyRootFilesystem: true
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL

# =============================================================================
# Port Scheme (10-port ranges per component)
# See docs/port-conventions.md for full documentation
# =============================================================================
# Offset | Purpose              | Typically Exposed
# -------|----------------------|------------------
#   0    | Coordinator gRPC     | Yes (always)
#   1    | REST proxy           | Optional
#   2    | Coordinator debug    | No (dev only)
#   3    | Client logic gRPC    | No (internal)
#   4    | Client debug         | No (dev only)
#  5-8   | Reserved             | No
#   9    | Control/Meta UI      | Optional
#
# Business domains by language (10-port ranges, base port):
#   Rust: 50050+    Go: 50200+    Python: 50400+
# =============================================================================

# Port exposure configuration
# WARNING: Do not enable debug ports in production
ports:
  # Expose coordinator debug port (base + 2)
  coordinatorDebug:
    enabled: false
  # Expose client logic port (base + 3)
  # WARNING: Generally should NOT be exposed - sidecar handles all external communication
  clientLogic:
    enabled: false
  # Expose client debug port (base + 4)
  clientDebug:
    enabled: false
  # Expose control/meta UI port (base + 9)
  controlUI:
    enabled: false

# Debug access for backing services
# WARNING: Do not enable in production
debug:
  # Enable debug access for MongoDB (external test connections)
  mongodb:
    enabled: false
    nodePort: 30017
  # Enable debug access for RabbitMQ management UI
  rabbitmq:
    enabled: false
    nodePort: 30672

# Angzarr gRPC ports
service:
  type: ClusterIP
  aggregatePort: 1310     # Aggregate sidecar gRPC
  queryPort: 1315         # Aggregate sidecar business logic port (EventQuery)
  # NodePort for local development access
  nodePort:
    enabled: false
    aggregate: 30310

# Service discovery configuration
serviceDiscovery:
  # Enable headless service for DNS-based discovery
  headless: false
  # DNS suffix for service names
  dnsSuffix: "svc.cluster.local"

# Infrastructure services (standalone, not sidecars)
infrastructure:
  # Event stream service - broadcasts events to registered subscribers
  stream:
    enabled: false
    replicas: 1
    port: 1340            # Stream gRPC
    projectorPort: 1345   # Stream's internal projector port
    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 100m
        memory: 128Mi

  # Gateway service - routes commands to entities and streams back events
  gateway:
    enabled: false
    replicas: 1
    port: 9084            # Gateway gRPC (angzarr port)
    # Address of command service to forward to
    entityService: ""
    # Address of stream service
    streamService: ""
    # Timeout for event stream (seconds)
    streamTimeoutSecs: 30
    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 100m
        memory: 128Mi

  # Log service - prints events to stdout for debugging
  log:
    enabled: false
    replicas: 1
    port: 50051           # Projector gRPC (receives events from sidecar)
    resources:
      limits:
        cpu: 200m
        memory: 256Mi
      requests:
        cpu: 50m
        memory: 64Mi

ingress:
  enabled: false
  className: ""
  annotations: {}
  hosts:
    - host: angzarr.local
      paths:
        - path: /
          pathType: ImplementationSpecific
  tls: []

# Resources for angzarr sidecar
resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 100m
    memory: 128Mi

livenessProbe:
  tcpSocket:
    port: aggregate
  initialDelaySeconds: 10
  periodSeconds: 10

readinessProbe:
  tcpSocket:
    port: aggregate
  initialDelaySeconds: 5
  periodSeconds: 5

autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 10
  targetCPUUtilizationPercentage: 80

nodeSelector: {}
tolerations: []
affinity: {}

# Storage configuration for angzarr
storage:
  # Options: mongodb, postgres, eventstoredb
  type: mongodb
  mongodb:
    # Connection URI (credentials should be set via --set or secretRef)
    uri: "mongodb://mongodb:27017"
    database: "angzarr"
    # Use existing secret for credentials
    existingSecret: ""
    secretKeys:
      username: "username"
      password: "password"
  postgres:
    # Connection URI (credentials should be set via --set or secretRef)
    uri: "postgres://postgresql:5432/angzarr"
    # Use existing secret for credentials
    existingSecret: ""
    secretKeys:
      username: "username"
      password: "password"
  eventstoredb:
    # EventStoreDB connection string
    connectionString: "esdb://eventstore:2113?tls=false"

# Messaging configuration
messaging:
  # Options: amqp, kafka
  type: amqp

  # AMQP (RabbitMQ) configuration
  amqp:
    enabled: false
    url: "amqp://rabbitmq:5672"
    # Use existing secret for URL
    existingSecret: ""
    secretKey: "amqp_url"

  # Kafka configuration
  kafka:
    enabled: false
    bootstrapServers: "kafka:9092"
    topicPrefix: "angzarr"
    securityProtocol: "PLAINTEXT"  # PLAINTEXT, SSL, SASL_PLAINTEXT, SASL_SSL
    saslMechanism: ""  # PLAIN, SCRAM-SHA-256, SCRAM-SHA-512
    saslUsername: ""
    saslPassword: ""
    sslCaLocation: ""
    # Use existing secret for credentials
    existingSecret: ""
    secretKeys:
      bootstrapServers: "kafka_bootstrap_servers"
      saslUsername: "kafka_sasl_username"
      saslPassword: "kafka_sasl_password"
      saslMechanism: "kafka_sasl_mechanism"

# RabbitMQ subchart configuration
rabbitmq:
  enabled: false
  auth:
    # Required: set via --set or values file, never commit credentials
    username: ""
    password: ""
  persistence:
    size: 1Gi

# Kafka subchart configuration (Bitnami)
kafka:
  enabled: false
  controller:
    replicaCount: 1
    persistence:
      size: 2Gi
  broker:
    replicaCount: 1
    persistence:
      size: 2Gi
  sasl:
    client:
      users: []
      passwords: ""
  listeners:
    client:
      protocol: PLAINTEXT
  autoCreateTopicsEnable: true

# MongoDB subchart configuration
mongodb:
  enabled: true
  auth:
    # Required: set via --set or values file, never commit credentials
    rootUsername: ""
    rootPassword: ""
    usernames: ["angzarr"]
    passwords: [""]  # Set via --set mongodb.auth.passwords[0]=<password>
    databases: ["angzarr"]
  persistence:
    size: 8Gi

# PostgreSQL subchart configuration (Bitnami)
postgresql:
  enabled: false
  auth:
    # Required: set via --set or values file, never commit credentials
    postgresPassword: ""
    username: "angzarr"
    password: ""  # Set via --set postgresql.auth.password=<password>
    database: "angzarr"
  primary:
    persistence:
      size: 8Gi

# EventStoreDB: Deploy separately using deploy/helm/eventstore
# Example: helm install eventstore ./deploy/helm/eventstore -n angzarr

# Main application containers - angzarr runs as sidecar to these
# Each application type gets angzarr infrastructure
applications:
  # Business logic applications - handle commands, produce events
  # Angzarr sidecar provides: BusinessCoordinator gRPC service
  business: []
  # - name: discount-service
  #   image:
  #     repository: discount-business
  #     tag: "latest"
  #   # Domain this business logic handles
  #   domain: "discounts"
  #   # Port the business logic exposes (angzarr calls this)
  #   port: 50051
  #   type: python  # python, go, or custom
  #   python:
  #     module: discount_logic
  #     path: /app/business
  #   # go:
  #   #   library: /app/libbusiness.so
  #   resources: {}
  #   # Debug access - expose this application's sidecar via NodePort
  #   debug:
  #     enabled: false
  #     nodePort: null  # Auto-assign if not specified

  # Projector applications - subscribe to events, build read models
  # Angzarr sidecar subscribes to AMQP and calls projector via gRPC
  projectors: []
  # - name: order-projector
  #   image:
  #     repository: order-projector
  #     tag: "latest"
  #   # Port the projector gRPC server listens on
  #   port: 50051
  #   # Domain this projector handles (optional, for K8s service discovery)
  #   domain: "orders"
  #   # Event topics/domains to subscribe to (AMQP routing keys)
  #   topics:
  #     - "orders.*"
  #     - "discounts.DiscountApplied"
  #   resources: {}
  #   # Debug access - expose this projector via NodePort
  #   debug:
  #     enabled: false
  #     nodePort: null

  # Saga applications - subscribe to events, orchestrate transactions
  # Angzarr sidecar subscribes to AMQP and calls saga via gRPC
  sagas: []
  # - name: order-fulfillment
  #   image:
  #     repository: fulfillment-saga
  #     tag: "latest"
  #   # Port the saga gRPC server listens on
  #   port: 50051
  #   # Source domain - events this saga listens to (for K8s service discovery)
  #   sourceDomain: "order"
  #   # Target domain - commands this saga sends to (optional)
  #   domain: "fulfillment"
  #   # Event topics/domains to subscribe to (AMQP routing keys)
  #   topics:
  #     - "orders.OrderCreated"
  #     - "payments.PaymentCompleted"
  #     - "inventory.ItemReserved"
  #   resources: {}
  #   # Debug access - expose this saga via NodePort
  #   debug:
  #     enabled: false
  #     nodePort: null

# Default resources for application containers
applicationResources:
  limits:
    cpu: 200m
    memory: 256Mi
  requests:
    cpu: 50m
    memory: 64Mi

# Environment variables
env: []

# Extra volumes
extraVolumes: []
extraVolumeMounts: []

# Logging
logging:
  level: info
  format: json

# Observability (OpenTelemetry)
observability:
  enabled: false
  environment: "dev"
  otlp:
    endpoint: "http://angzarr-otel-collector-opentelemetry-collector.monitoring.svc.cluster.local:4317"

# Stakater Reloader configuration
# Automatically restarts pods when ConfigMaps/Secrets change
# Requires Reloader to be installed: helm install reloader stakater/reloader -n reloader --create-namespace
reloader:
  enabled: true
  # Watch specific secrets/configmaps (auto-detects if not specified)
  watchSecrets: true
  watchConfigMaps: true

# External Secrets Operator configuration
# Requires ESO to be installed in cluster: helm install external-secrets external-secrets/external-secrets -n external-secrets --create-namespace
externalSecrets:
  enabled: false
  # Provider: kubernetes, fake, aws, vault, gcp, azure
  provider: kubernetes
  # How often to sync secrets
  refreshInterval: "1h"
  # Kubernetes provider config (for local dev)
  kubernetes:
    # Namespace containing source secrets
    sourceNamespace: "angzarr-secrets"
  # Secret references
  mongodb:
    secretName: "angzarr-secrets"
  rabbitmq:
    secretName: "angzarr-secrets"
  postgresql:
    secretName: "angzarr-secrets"
