# Rust example applications for local development
# Deploy with: helm upgrade --install angzarr ./deploy/helm/angzarr -f ./deploy/helm/angzarr/values-rust.yaml -n angzarr --create-namespace

# Allow non-bitnami images for local development
global:
  security:
    allowInsecureImages: true

replicaCount: 1

# Angzarr sidecar images (using local registry)
images:
  entity:
    repository: localhost:5001/angzarr-entity
    pullPolicy: IfNotPresent
    tag: "latest"
  projector:
    repository: localhost:5001/angzarr-projector
    pullPolicy: IfNotPresent
    tag: "latest"
  saga:
    repository: localhost:5001/angzarr-saga
    pullPolicy: IfNotPresent
    tag: "latest"
  stream:
    repository: localhost:5001/angzarr-stream
    pullPolicy: IfNotPresent
    tag: "latest"
  gateway:
    repository: localhost:5001/angzarr-gateway
    pullPolicy: IfNotPresent
    tag: "latest"

# Minimal resources for local dev
resources:
  requests:
    memory: "64Mi"
    cpu: "50m"
  limits:
    memory: "256Mi"
    cpu: "250m"

applicationResources:
  requests:
    memory: "32Mi"
    cpu: "25m"
  limits:
    memory: "128Mi"
    cpu: "100m"

# MongoDB storage - using Bitnami subchart
storage:
  type: mongodb
  mongodb:
    # Bitnami replica set creates headless service: <release>-mongodb-headless
    # replicaSet=rs0 (Bitnami default replica set name)
    # retryWrites=true now works with replica set
    uri: "mongodb://angzarr:angzarr@angzarr-mongodb-headless:27017/?authSource=angzarr&replicaSet=rs0"
    database: "angzarr"

# AMQP event bus - using Bitnami subchart
amqp:
  enabled: true
  url: "amqp://guest:guest@angzarr-rabbitmq:5672"

# External secrets disabled - using manual sync via `just secrets-sync`
externalSecrets:
  enabled: false

# RabbitMQ subchart - message bus for event distribution
# Bitnami moved images to ECR: public.ecr.aws/bitnami/rabbitmq
rabbitmq:
  enabled: true
  image:
    registry: public.ecr.aws
    repository: bitnami/rabbitmq
    tag: "4.0"
  auth:
    username: "guest"
    password: "guest"
  persistence:
    size: 1Gi
  resources:
    requests:
      memory: "128Mi"
      cpu: "50m"
    limits:
      memory: "256Mi"
      cpu: "250m"

# MongoDB subchart - event store persistence
# Using single-node replica set for transaction support and better restart behavior
# Bitnami moved images to ECR: public.ecr.aws/bitnami/mongodb
mongodb:
  enabled: true
  image:
    registry: public.ecr.aws
    repository: bitnami/mongodb
    tag: "8.0"
  # Single-node replica set enables transactions and fixes lock file issues
  architecture: replicaset
  replicaCount: 1
  auth:
    rootUsername: "root"
    rootPassword: "rootpassword"
    usernames: ["angzarr"]
    passwords: ["angzarr"]
    databases: ["angzarr"]
    replicaSetKey: "angzarrReplicaSetKey"
  persistence:
    size: 2Gi
  resources:
    requests:
      memory: "128Mi"
      cpu: "50m"
    limits:
      memory: "512Mi"
      cpu: "500m"

# Central infrastructure services
infrastructure:
  # Stream is now a projector (see applications.projectors below)
  stream:
    enabled: false

  # Gateway service - command proxy with streaming
  # Uses K8s API to discover command handlers by label (app.kubernetes.io/component=business)
  # and routes commands based on domain from angzarr.io/domain annotation
  gateway:
    enabled: true
    # NodePort for external access (kind maps hostPort:50051 -> nodePort:30051)
    serviceType: NodePort
    nodePort: 30051
    streamService: "angzarr-stream-rs:1315"
    streamTimeoutSecs: 30

# Business logic applications - each gets angzarr as sidecar
applications:
  business:
    # E-commerce Domain Aggregates
    - name: entity-customer-rs
      image:
        repository: localhost:5001/entity-customer-rs
        tag: "latest"
        pullPolicy: IfNotPresent
      domain: "customer"
      port: 50055

    - name: entity-product-rs
      image:
        repository: localhost:5001/entity-product-rs
        tag: "latest"
        pullPolicy: IfNotPresent
      domain: "product"
      port: 50053

    - name: entity-inventory-rs
      image:
        repository: localhost:5001/entity-inventory-rs
        tag: "latest"
        pullPolicy: IfNotPresent
      domain: "inventory"
      port: 50054

    - name: entity-order-rs
      image:
        repository: localhost:5001/entity-order-rs
        tag: "latest"
        pullPolicy: IfNotPresent
      domain: "order"
      port: 50056

    - name: entity-cart-rs
      image:
        repository: localhost:5001/entity-cart-rs
        tag: "latest"
        pullPolicy: IfNotPresent
      domain: "cart"
      port: 50057

    - name: entity-fulfillment-rs
      image:
        repository: localhost:5001/entity-fulfillment-rs
        tag: "latest"
        pullPolicy: IfNotPresent
      domain: "fulfillment"
      port: 50058

  projectors:
    # Stream projector - broadcasts events to clients by correlation ID
    - name: stream-rs
      image:
        repository: localhost:5001/angzarr-stream
        tag: "latest"
        pullPolicy: IfNotPresent
      port: 1315
      topics:
        - "#"  # Subscribe to all events

  sagas:
    # Loyalty Earn Saga - awards points when orders complete
    - name: saga-loyalty-earn-rs
      image:
        repository: localhost:5001/saga-loyalty-earn-rs
        tag: "latest"
        pullPolicy: IfNotPresent
      port: 50060
      topics:
        - "order.*"

    # Fulfillment Saga - creates shipments when orders complete
    - name: saga-fulfillment-rs
      image:
        repository: localhost:5001/saga-fulfillment-rs
        tag: "latest"
        pullPolicy: IfNotPresent
      port: 50061
      topics:
        - "order.*"

    # Cancellation Saga - handles compensation when orders are cancelled
    - name: saga-cancellation-rs
      image:
        repository: localhost:5001/saga-cancellation-rs
        tag: "latest"
        pullPolicy: IfNotPresent
      port: 50062
      topics:
        - "order.*"

# Service configuration
service:
  type: NodePort
  entityPort: 50051
  queryPort: 50052
  # NodePort for local development entity access (kind maps hostPort:50052->30052)
  # Entity sidecar hosts both BusinessCoordinator and EventQuery on entityPort
  nodePort:
    enabled: true
    entity: 30052

logging:
  level: info

# Disable autoscaling for local dev
autoscaling:
  enabled: false

# Disable reloader for simpler local setup
reloader:
  enabled: false

# Service discovery options
serviceDiscovery:
  headless: false
