# Rust example applications for local development
# Deploy with: helm upgrade --install angzarr ./deploy/helm/angzarr -f ./deploy/helm/angzarr/values-rust.yaml -n angzarr --create-namespace
#
# =============================================================================
# Port Scheme - Rust (500xx range, 10 ports per domain)
# =============================================================================
# x0: sidecar gRPC (via service.aggregatePort)
# x1: sidecar debug
# x5: business gRPC
# x6: business debug
#
# order:              50030-50039  (business: 50035)
# inventory:          50020-50029  (business: 50025)
# fulfillment:        50050-50059  (business: 50055)
# saga-fulfillment:   50070-50079  (business: 50075)
# saga-inv-reserv:    50100-50109  (business: 50105)
# pm-fulfillment:     50110-50119  (business: 50115)
# proj-inventory:     50130-50139  (business: 50135)
# =============================================================================

# Allow non-bitnami images for local development
global:
  security:
    allowInsecureImages: true

replicaCount: 1

# Angzarr sidecar images (using local registry)
# All images use sha256 tags - skaffold injects actual tags via setValueTemplates
# pullPolicy: IfNotPresent works because new content = new sha256 tag = K8s pulls
images:
  aggregate:
    repository: localhost:5001/angzarr-aggregate
    pullPolicy: IfNotPresent
    tag: "latest"  # Overridden by skaffold setValueTemplates
  projector:
    repository: localhost:5001/angzarr-projector
    pullPolicy: IfNotPresent
    tag: "latest"  # Overridden by skaffold setValueTemplates
  saga:
    repository: localhost:5001/angzarr-saga
    pullPolicy: IfNotPresent
    tag: "latest"  # Overridden by skaffold setValueTemplates
  processManager:
    repository: localhost:5001/angzarr-process-manager
    pullPolicy: IfNotPresent
    tag: "latest"  # Overridden by skaffold setValueTemplates
  stream:
    repository: localhost:5001/angzarr-stream
    pullPolicy: IfNotPresent
    tag: "latest"  # Overridden by skaffold setValueTemplates
  gateway:
    repository: localhost:5001/angzarr-gateway
    pullPolicy: IfNotPresent
    tag: "latest"  # Overridden by skaffold setValueTemplates
  log:
    repository: localhost:5001/angzarr-log
    pullPolicy: IfNotPresent
    tag: "latest"  # Overridden by skaffold setValueTemplates
  topology:
    repository: localhost:5001/angzarr-topology
    pullPolicy: IfNotPresent
    tag: "latest"  # Overridden by skaffold setValueTemplates

# Minimal resources for local dev
resources:
  requests:
    memory: "64Mi"
    cpu: "50m"
  limits:
    memory: "256Mi"
    cpu: "250m"

applicationResources:
  requests:
    memory: "32Mi"
    cpu: "25m"
  limits:
    memory: "128Mi"
    cpu: "100m"

# Storage configuration
# MongoDB for aggregates (event store)
# PostgreSQL for projectors (read models)
storage:
  type: mongodb
  mongodb:
    uri: "mongodb://angzarr:angzarr-dev@angzarr-db-mongodb:27017/angzarr?authSource=angzarr"
    database: "angzarr"
  postgres:
    uri: "postgres://angzarr:angzarr-dev@angzarr-db-postgresql:5432/angzarr"

# Messaging configuration
messaging:
  type: "amqp"
  amqp:
    enabled: true
    url: "amqp://angzarr:angzarr-dev@angzarr-mq-rabbitmq:5672/%2F"

# AMQP event bus
amqp:
  enabled: true
  url: "amqp://angzarr:angzarr-dev@angzarr-mq-rabbitmq:5672/%2F"

# External secrets disabled for local dev
externalSecrets:
  enabled: false

# =============================================================================
# Backing Services - Bitnami Helm Subcharts
# Local dev credentials (not for production!)
# =============================================================================
rabbitmq:
  enabled: true
  fullnameOverride: "angzarr-mq-rabbitmq"
  image:
    registry: public.ecr.aws
    repository: bitnami/rabbitmq
    tag: "4.0"
  auth:
    username: "angzarr"
    password: "angzarr-dev"
  persistence:
    size: 1Gi
  resources:
    requests:
      memory: "128Mi"
      cpu: "100m"
    limits:
      memory: "512Mi"
      cpu: "500m"

mongodb:
  enabled: true
  fullnameOverride: "angzarr-db-mongodb"
  image:
    registry: public.ecr.aws
    repository: bitnami/mongodb
    tag: "8.0"
  auth:
    rootUsername: "root"
    rootPassword: "angzarr-root-dev"
    usernames: ["angzarr"]
    passwords: ["angzarr-dev"]
    databases: ["angzarr"]
  persistence:
    size: 2Gi
  resources:
    requests:
      memory: "128Mi"
      cpu: "100m"
    limits:
      memory: "512Mi"
      cpu: "500m"

postgresql:
  enabled: true
  fullnameOverride: "angzarr-db-postgresql"
  image:
    registry: public.ecr.aws
    repository: bitnami/postgresql
    tag: "17"
  auth:
    postgresPassword: "angzarr-postgres-dev"
    username: "angzarr"
    password: "angzarr-dev"
    database: "angzarr"
  primary:
    persistence:
      size: 2Gi
    resources:
      requests:
        memory: "128Mi"
        cpu: "100m"
      limits:
        memory: "512Mi"
        cpu: "500m"

kafka:
  enabled: false  # Disabled for local dev - AMQP via RabbitMQ is primary

# Central infrastructure services
infrastructure:
  # Stream service - broadcasts events to clients by correlation ID
  stream:
    enabled: true
    replicas: 1
    port: 1340           # Stream gRPC (x0)
    projectorPort: 1345  # Stream internal projector port (x5)
    # NodePort for external access (kind maps hostPort:1340 -> nodePort:31340)
    serviceType: NodePort
    nodePort: 31340
    resources:
      requests:
        memory: "64Mi"
        cpu: "50m"
      limits:
        memory: "256Mi"
        cpu: "250m"

  # Gateway service - command proxy with streaming
  # Uses K8s API to discover command handlers by label (app.kubernetes.io/component=business)
  # and routes commands based on domain from angzarr.io/domain annotation
  gateway:
    enabled: true
    replicas: 1
    port: 9084           # Gateway gRPC (angzarr port)
    # NodePort for external access (kind maps hostPort:9084 -> nodePort:30084)
    serviceType: NodePort
    nodePort: 30084
    streamService: "angzarr-stream:1340"
    streamTimeoutSecs: 30
    resources:
      requests:
        memory: "64Mi"
        cpu: "50m"
      limits:
        memory: "256Mi"
        cpu: "250m"

  # Log service - prints events to stdout for debugging
  log:
    enabled: true
    replicas: 1
    port: 50051          # Projector gRPC (receives events from sidecar)
    resources:
      requests:
        memory: "32Mi"
        cpu: "25m"
      limits:
        memory: "128Mi"
        cpu: "100m"

# client logic applications - each gets angzarr as sidecar
# Note: skaffold setValueTemplates override repository/tag with sha256-based tags
# pullPolicy: IfNotPresent works because sha256 tags ensure new content = new tag
applications:
  business:
    # E-commerce Domain Aggregates (Rust: 500xx range)
    - name: aggregate-order-rs
      image:
        repository: localhost:5001/aggregate-order-rs
        tag: "latest"
        pullPolicy: IfNotPresent
      domain: "order"
      port: 50035        # order business gRPC (50030+5)

    - name: aggregate-inventory-rs
      image:
        repository: localhost:5001/aggregate-inventory-rs
        tag: "latest"
        pullPolicy: IfNotPresent
      domain: "inventory"
      port: 50025        # inventory business gRPC (50020+5)

    - name: aggregate-fulfillment-rs
      image:
        repository: localhost:5001/aggregate-fulfillment-rs
        tag: "latest"
        pullPolicy: IfNotPresent
      domain: "fulfillment"
      port: 50055        # fulfillment business gRPC (50050+5)

  projectors:
    # Inventory Projector - logs inventory stock changes
    - name: projector-inventory-rs
      image:
        repository: localhost:5001/projector-inventory-rs
        tag: "latest"
        pullPolicy: IfNotPresent
      domain: "inventory"
      port: 50135        # projector-inventory business gRPC (50130+5)
      topics:
        - "inventory"

  sagas:
    # Order-Fulfillment Saga - creates shipments when orders complete
    - name: saga-order-fulfillment-rs
      image:
        repository: localhost:5001/saga-order-fulfillment-rs
        tag: "latest"
        pullPolicy: IfNotPresent
      domain: "saga-order-fulfillment"
      port: 50075        # saga-order-fulfillment business gRPC (50070+5)
      topics:
        - "order.*"

    # Order-Inventory Saga - reserves stock when orders are created
    - name: saga-order-inventory-rs
      image:
        repository: localhost:5001/saga-order-inventory-rs
        tag: "latest"
        pullPolicy: IfNotPresent
      domain: "saga-order-inventory"
      port: 50105        # saga-order-inventory business gRPC (50100+5)
      topics:
        - "order.*"

    # Fulfillment-Inventory Saga - commits inventory when shipments ship
    - name: saga-fulfillment-inventory-rs
      image:
        repository: localhost:5001/saga-fulfillment-inventory-rs
        tag: "latest"
        pullPolicy: IfNotPresent
      domain: "saga-fulfillment-inventory"
      port: 50127        # saga-fulfillment-inventory business gRPC
      topics:
        - "fulfillment.*"

  processManagers:
    # Order Fulfillment PM - fan-in: payment + inventory + fulfillment â†’ Ship
    - name: process-manager-fulfillment-rs
      image:
        repository: localhost:5001/process-manager-fulfillment-rs
        tag: "latest"
        pullPolicy: IfNotPresent
      domain: "order-fulfillment"
      port: 50115        # pm-fulfillment business gRPC (50110+5)
      topics:
        - "order.*"
        - "inventory.*"
        - "fulfillment.*"

# Service configuration - Angzarr sidecar ports
service:
  type: NodePort
  aggregatePort: 1310    # Aggregate sidecar gRPC (x0)
  queryPort: 1315        # Aggregate sidecar query port (x5)
  # NodePort for local development entity access
  nodePort:
    enabled: true
    aggregate: 31310     # Maps to aggregatePort

# Enable remote debugging with gdb (adds SYS_PTRACE capability)
# Debug ports are calculated: grpc_port + 1
debug:
  enabled: true

logging:
  level: info

# Disable autoscaling for local dev
autoscaling:
  enabled: false

# Disable reloader for simpler local setup
reloader:
  enabled: false

# Service discovery options
serviceDiscovery:
  headless: false
