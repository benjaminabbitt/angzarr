# Rust example applications for local development
# Deploy with: helm upgrade --install angzarr ./deploy/helm/angzarr -f ./deploy/helm/angzarr/values-rust.yaml -n angzarr --create-namespace
#
# =============================================================================
# Port Scheme - Rust (50000-50099, 3 ports per component)
# =============================================================================
# Per-component: +0 gRPC, +1 debug, +2 visualization
#
# agg-order:              50000-50002  (gRPC: 50000)
# agg-inventory:          50003-50005  (gRPC: 50003)
# agg-fulfillment:        50006-50008  (gRPC: 50006)
# sag-order-fulfillment:  50018-50020  (gRPC: 50018)
# sag-order-inventory:    50021-50023  (gRPC: 50021)
# sag-fulfillment-inv:    50024-50026  (gRPC: 50024)
# prj-inventory:          50033-50035  (gRPC: 50033)
# pmg-fulfillment:        50039-50041  (gRPC: 50039)
# =============================================================================

# Allow non-bitnami images for local development
global:
  security:
    allowInsecureImages: true

replicaCount: 1

# Angzarr sidecar images (using local registry)
# All images use sha256 tags - skaffold injects actual tags via setValueTemplates
# pullPolicy: IfNotPresent works because new content = new sha256 tag = K8s pulls
images:
  aggregate:
    repository: ghcr.io/angzarr-io/angzarr-aggregate
    pullPolicy: IfNotPresent
    tag: "latest"  # Overridden by skaffold setValueTemplates
  projector:
    repository: ghcr.io/angzarr-io/angzarr-projector
    pullPolicy: IfNotPresent
    tag: "latest"  # Overridden by skaffold setValueTemplates
  saga:
    repository: ghcr.io/angzarr-io/angzarr-saga
    pullPolicy: IfNotPresent
    tag: "latest"  # Overridden by skaffold setValueTemplates
  processManager:
    repository: ghcr.io/angzarr-io/angzarr-process-manager
    pullPolicy: IfNotPresent
    tag: "latest"  # Overridden by skaffold setValueTemplates
  stream:
    repository: ghcr.io/angzarr-io/angzarr-stream
    pullPolicy: IfNotPresent
    tag: "latest"  # Overridden by skaffold setValueTemplates
  gateway:
    repository: ghcr.io/angzarr-io/angzarr-gateway
    pullPolicy: IfNotPresent
    tag: "latest"  # Overridden by skaffold setValueTemplates
  log:
    repository: ghcr.io/angzarr-io/angzarr-log
    pullPolicy: IfNotPresent
    tag: "latest"  # Overridden by skaffold setValueTemplates
  topology:
    repository: ghcr.io/angzarr-io/angzarr-topology
    pullPolicy: IfNotPresent
    tag: "latest"  # Overridden by skaffold setValueTemplates

# Minimal resources for local dev
resources:
  requests:
    memory: "64Mi"
    cpu: "50m"
  limits:
    memory: "256Mi"
    cpu: "250m"

applicationResources:
  requests:
    memory: "32Mi"
    cpu: "25m"
  limits:
    memory: "128Mi"
    cpu: "100m"

# Storage configuration
# PostgreSQL for event store and read models
storage:
  type: postgres
  postgres:
    uri: "postgres://angzarr:angzarr-dev@angzarr-db-postgresql:5432/angzarr"

# Messaging configuration
messaging:
  type: "amqp"
  amqp:
    enabled: true
    url: "amqp://angzarr:angzarr-dev@angzarr-mq-rabbitmq:5672/%2F"

# AMQP event bus
amqp:
  enabled: true
  url: "amqp://angzarr:angzarr-dev@angzarr-mq-rabbitmq:5672/%2F"

# External secrets disabled for local dev
externalSecrets:
  enabled: false

# =============================================================================
# Infrastructure Dependencies
# Deploy separately using modular charts before deploying this chart.
# See examples/rust/skaffold.yaml for automated deployment.
#
# Required:
#   helm install angzarr-db ./deploy/helm/angzarr-db-postgres -n angzarr \
#     --set postgresql.auth.password=angzarr-dev
#
#   helm install angzarr-mq ./deploy/helm/angzarr-mq-rabbitmq -n angzarr \
#     --set rabbitmq.auth.password=angzarr-dev
# =============================================================================

# =============================================================================
# Mock Services for Testing
# These demonstrate external service integration patterns (fraud, pricing, tax, etc.)
# =============================================================================
mockServices:
  fraud:
    enabled: true
    image:
      repository: ghcr.io/angzarr-io/mock-fraud-service
      tag: "latest"
      pullPolicy: IfNotPresent
    # customer_id=result pairs (format: "CUST-ID1=result1,CUST-ID2=result2")
    # Results: approved, review_required, declined
    responses: "CUST-FRAUD=declined,CUST-REVIEW=review_required"
    resources:
      requests:
        memory: "32Mi"
        cpu: "25m"
      limits:
        memory: "128Mi"
        cpu: "100m"

# Central infrastructure services
infrastructure:
  # Stream service - broadcasts events to clients by correlation ID
  stream:
    enabled: true
    replicas: 1
    port: 1340           # Stream gRPC (x0)
    projectorPort: 1345  # Stream internal projector port (x5)
    # NodePort for external access (kind maps hostPort:1340 -> nodePort:31340)
    serviceType: NodePort
    nodePort: 31340
    resources:
      requests:
        memory: "64Mi"
        cpu: "50m"
      limits:
        memory: "256Mi"
        cpu: "250m"

  # Gateway service - command proxy with streaming
  # Uses K8s API to discover command handlers by label (app.kubernetes.io/component=business)
  # and routes commands based on domain from angzarr.io/domain annotation
  gateway:
    enabled: true
    replicas: 1
    port: 9084           # Gateway gRPC (angzarr port)
    # NodePort for external access (kind maps hostPort:9084 -> nodePort:30084)
    serviceType: NodePort
    nodePort: 30084
    streamService: "angzarr-stream:1340"
    streamTimeoutSecs: 30
    resources:
      requests:
        memory: "64Mi"
        cpu: "50m"
      limits:
        memory: "256Mi"
        cpu: "250m"

  # Log service - prints events to stdout for debugging
  log:
    enabled: true
    replicas: 1
    port: 50051          # Projector gRPC (receives events from sidecar)
    resources:
      requests:
        memory: "32Mi"
        cpu: "25m"
      limits:
        memory: "128Mi"
        cpu: "100m"

# client logic applications - each gets angzarr as sidecar
# Note: skaffold setValueTemplates override repository/tag with sha256-based tags
# pullPolicy: IfNotPresent works because sha256 tags ensure new content = new tag
applications:
  business:
    # E-commerce Domain Aggregates (Rust: 500xx range)
    - name: agg-order-rs
      image:
        repository: ghcr.io/angzarr-io/agg-order-rs
        tag: "latest"
        pullPolicy: IfNotPresent
      domain: "order"
      port: 50000        # order gRPC (50000-50002)
      env:
        - name: FRAUD_SERVICE_URL
          value: "http://mock-fraud-service"  # K8s service DNS

    - name: agg-inventory-rs
      image:
        repository: ghcr.io/angzarr-io/agg-inventory-rs
        tag: "latest"
        pullPolicy: IfNotPresent
      domain: "inventory"
      port: 50003        # inventory gRPC (50003-50005)

    - name: agg-fulfillment-rs
      image:
        repository: ghcr.io/angzarr-io/agg-fulfillment-rs
        tag: "latest"
        pullPolicy: IfNotPresent
      domain: "fulfillment"
      port: 50006        # fulfillment gRPC (50006-50008)

  projectors:
    # Inventory Projector - logs inventory stock changes
    - name: prj-inventory-rs
      image:
        repository: ghcr.io/angzarr-io/prj-inventory-rs
        tag: "latest"
        pullPolicy: IfNotPresent
      domain: "inventory"
      port: 50033        # prj-inventory gRPC (50033-50035)
      topics:
        - "inventory"

  sagas:
    # Order-Fulfillment Saga - creates shipments when orders complete
    - name: sag-order-fulfillment-rs
      image:
        repository: ghcr.io/angzarr-io/sag-order-fulfillment-rs
        tag: "latest"
        pullPolicy: IfNotPresent
      domain: "sag-order-fulfillment"
      port: 50018        # sag-order-fulfillment gRPC (50018-50020)
      topics:
        - "order.*"

    # Order-Inventory Saga - reserves stock when orders are created
    - name: sag-order-inventory-rs
      image:
        repository: ghcr.io/angzarr-io/sag-order-inventory-rs
        tag: "latest"
        pullPolicy: IfNotPresent
      domain: "sag-order-inventory"
      port: 50021        # sag-order-inventory gRPC (50021-50023)
      topics:
        - "order.*"

    # Fulfillment-Inventory Saga - commits inventory when shipments ship
    - name: sag-fulfillment-inventory-rs
      image:
        repository: ghcr.io/angzarr-io/sag-fulfillment-inventory-rs
        tag: "latest"
        pullPolicy: IfNotPresent
      domain: "sag-fulfillment-inventory"
      port: 50024        # sag-fulfillment-inventory gRPC (50024-50026)
      topics:
        - "fulfillment.*"

  processManagers:
    # Order Fulfillment PM - fan-in: payment + inventory + fulfillment â†’ Ship
    - name: pmg-fulfillment-rs
      image:
        repository: ghcr.io/angzarr-io/pmg-fulfillment-rs
        tag: "latest"
        pullPolicy: IfNotPresent
      domain: "pmg-fulfillment"
      port: 50039        # pmg-fulfillment gRPC (50039-50041)
      topics:
        - "order.*"
        - "inventory.*"
        - "fulfillment.*"

# Service configuration - Angzarr sidecar ports
service:
  type: NodePort
  aggregatePort: 1310    # Aggregate sidecar gRPC (x0)
  queryPort: 1315        # Aggregate sidecar query port (x5)
  # NodePort for local development entity access
  nodePort:
    enabled: true
    aggregate: 31310     # Maps to aggregatePort

# Enable remote debugging with gdb (adds SYS_PTRACE capability)
# Debug ports are calculated: grpc_port + 1
debug:
  enabled: true

logging:
  level: info

# Disable autoscaling for local dev
autoscaling:
  enabled: false

# Disable reloader for simpler local setup
reloader:
  enabled: false

# Service discovery options
serviceDiscovery:
  headless: false
