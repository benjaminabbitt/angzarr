{{- /* Services for aggregate (business logic) applications */}}
{{- range .Values.applications.business }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "angzarr.fullname" $ }}-{{ .name }}
  namespace: {{ $.Release.Namespace }}
  labels:
    {{- include "angzarr.labels" $ | nindent 4 }}
    app.kubernetes.io/component: aggregate
    angzarr.io/domain: {{ .domain }}
  annotations:
    # DNS: {{ include "angzarr.fullname" $ }}-{{ .name }}.{{ $.Release.Namespace }}.svc.cluster.local
    angzarr.io/dns-name: "{{ include "angzarr.fullname" $ }}-{{ .name }}.{{ $.Release.Namespace }}.svc.cluster.local"
spec:
  type: ClusterIP
  ports:
    # Angzarr sidecar aggregate coordinator (external access)
    - port: {{ $.Values.service.aggregatePort }}
      targetPort: entity
      protocol: TCP
      name: grpc
    # Angzarr sidecar event query (external access)
    - port: {{ $.Values.service.queryPort }}
      targetPort: query
      protocol: TCP
      name: query
    # Business logic gRPC (internal only)
    - port: {{ .port }}
      targetPort: business
      protocol: TCP
      name: business
  selector:
    {{- include "angzarr.selectorLabels" $ | nindent 4 }}
    app.kubernetes.io/component: aggregate
    angzarr.io/app: {{ .name }}
{{- end }}

{{- /* Services for projector applications */}}
{{- range .Values.applications.projectors }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "angzarr.fullname" $ }}-{{ .name }}
  namespace: {{ $.Release.Namespace }}
  labels:
    {{- include "angzarr.labels" $ | nindent 4 }}
    app.kubernetes.io/component: projector
    {{- if .domain }}
    angzarr.io/domain: {{ .domain }}
    {{- end }}
  annotations:
    angzarr.io/dns-name: "{{ include "angzarr.fullname" $ }}-{{ .name }}.{{ $.Release.Namespace }}.svc.cluster.local"
spec:
  type: ClusterIP
  ports:
    # Projector coordinator gRPC service
    - port: {{ .port | default 50051 }}
      targetPort: grpc
      protocol: TCP
      name: grpc
  selector:
    {{- include "angzarr.selectorLabels" $ | nindent 4 }}
    app.kubernetes.io/component: projector
    angzarr.io/app: {{ .name }}
{{- end }}

{{- /* Services for saga applications */}}
{{- range .Values.applications.sagas }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "angzarr.fullname" $ }}-{{ .name }}
  namespace: {{ $.Release.Namespace }}
  labels:
    {{- include "angzarr.labels" $ | nindent 4 }}
    app.kubernetes.io/component: saga
    {{- if .sourceDomain }}
    angzarr.io/source-domain: {{ .sourceDomain }}
    {{- end }}
    {{- if .domain }}
    angzarr.io/domain: {{ .domain }}
    {{- end }}
  annotations:
    angzarr.io/dns-name: "{{ include "angzarr.fullname" $ }}-{{ .name }}.{{ $.Release.Namespace }}.svc.cluster.local"
spec:
  type: ClusterIP
  ports:
    # Saga coordinator gRPC service
    - port: {{ .port | default 50051 }}
      targetPort: grpc
      protocol: TCP
      name: grpc
  selector:
    {{- include "angzarr.selectorLabels" $ | nindent 4 }}
    app.kubernetes.io/component: saga
    angzarr.io/app: {{ .name }}
{{- end }}

{{- /* Headless service for service discovery (optional) */}}
{{- if .Values.serviceDiscovery.headless }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "angzarr.fullname" . }}-headless
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "angzarr.labels" . | nindent 4 }}
spec:
  type: ClusterIP
  clusterIP: None
  ports:
    - port: {{ .Values.service.aggregatePort }}
      targetPort: entity
      protocol: TCP
      name: command
  selector:
    {{- include "angzarr.selectorLabels" . | nindent 4 }}
{{- end }}

{{- /* Event Stream service */}}
{{- if .Values.infrastructure.stream.enabled }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "angzarr.fullname" . }}-stream
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "angzarr.labels" . | nindent 4 }}
    app.kubernetes.io/component: infrastructure
    angzarr.io/service: stream
  annotations:
    angzarr.io/dns-name: "{{ include "angzarr.fullname" . }}-stream.{{ .Release.Namespace }}.svc.cluster.local"
spec:
  type: {{ .Values.infrastructure.stream.serviceType | default "ClusterIP" }}
  ports:
    - port: {{ .Values.infrastructure.stream.port }}
      targetPort: grpc
      protocol: TCP
      name: grpc
      {{- if and (eq (.Values.infrastructure.stream.serviceType | default "ClusterIP") "NodePort") .Values.infrastructure.stream.nodePort }}
      nodePort: {{ .Values.infrastructure.stream.nodePort }}
      {{- end }}
  selector:
    {{- include "angzarr.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: infrastructure
    angzarr.io/service: stream
{{- end }}

{{- /* Command Proxy service */}}
{{- if .Values.infrastructure.gateway.enabled }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "angzarr.fullname" . }}-gateway
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "angzarr.labels" . | nindent 4 }}
    app.kubernetes.io/component: infrastructure
    angzarr.io/service: gateway
  annotations:
    angzarr.io/dns-name: "{{ include "angzarr.fullname" . }}-gateway.{{ .Release.Namespace }}.svc.cluster.local"
spec:
  type: {{ .Values.infrastructure.gateway.serviceType | default "ClusterIP" }}
  ports:
    - port: {{ .Values.infrastructure.gateway.port }}
      targetPort: grpc
      protocol: TCP
      name: grpc
      {{- if and (eq (.Values.infrastructure.gateway.serviceType | default "ClusterIP") "NodePort") .Values.infrastructure.gateway.nodePort }}
      nodePort: {{ .Values.infrastructure.gateway.nodePort }}
      {{- end }}
  selector:
    {{- include "angzarr.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: infrastructure
    angzarr.io/service: gateway
{{- end }}

{{- /* NodePort service for local development aggregate access */}}
{{- if .Values.service.nodePort.enabled }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "angzarr.fullname" . }}-aggregate-nodeport
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "angzarr.labels" . | nindent 4 }}
    app.kubernetes.io/component: aggregate-access
spec:
  type: NodePort
  ports:
    # Aggregate sidecar exposes AggregateCoordinator and EventQuery
    - port: {{ .Values.service.aggregatePort }}
      targetPort: entity
      protocol: TCP
      name: grpc
      nodePort: {{ .Values.service.nodePort.aggregate }}
  selector:
    {{- include "angzarr.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: aggregate
{{- end }}

{{- /* Debug NodePort services for individual aggregate applications */}}
{{- range $index, $app := .Values.applications.business }}
{{- if and $app.debug $app.debug.enabled }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "angzarr.fullname" $ }}-{{ $app.name }}-debug
  namespace: {{ $.Release.Namespace }}
  labels:
    {{- include "angzarr.labels" $ | nindent 4 }}
    app.kubernetes.io/component: aggregate-debug
    angzarr.io/app: {{ $app.name }}
spec:
  type: NodePort
  ports:
    - port: {{ $.Values.service.aggregatePort }}
      targetPort: entity
      protocol: TCP
      name: grpc
      {{- if $app.debug.nodePort }}
      nodePort: {{ $app.debug.nodePort }}
      {{- end }}
  selector:
    {{- include "angzarr.selectorLabels" $ | nindent 4 }}
    app.kubernetes.io/component: aggregate
    angzarr.io/app: {{ $app.name }}
{{- end }}
{{- end }}

{{- /* Debug NodePort services for individual projector applications */}}
{{- range $index, $app := .Values.applications.projectors }}
{{- if and $app.debug $app.debug.enabled }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "angzarr.fullname" $ }}-{{ $app.name }}-debug
  namespace: {{ $.Release.Namespace }}
  labels:
    {{- include "angzarr.labels" $ | nindent 4 }}
    app.kubernetes.io/component: projector-debug
    angzarr.io/app: {{ $app.name }}
spec:
  type: NodePort
  ports:
    - port: {{ $app.port | default 50051 }}
      targetPort: grpc
      protocol: TCP
      name: grpc
      {{- if $app.debug.nodePort }}
      nodePort: {{ $app.debug.nodePort }}
      {{- end }}
  selector:
    {{- include "angzarr.selectorLabels" $ | nindent 4 }}
    app.kubernetes.io/component: projector
    angzarr.io/app: {{ $app.name }}
{{- end }}
{{- end }}

{{- /* Debug NodePort services for individual saga applications */}}
{{- range $index, $app := .Values.applications.sagas }}
{{- if and $app.debug $app.debug.enabled }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "angzarr.fullname" $ }}-{{ $app.name }}-debug
  namespace: {{ $.Release.Namespace }}
  labels:
    {{- include "angzarr.labels" $ | nindent 4 }}
    app.kubernetes.io/component: saga-debug
    angzarr.io/app: {{ $app.name }}
spec:
  type: NodePort
  ports:
    - port: {{ $app.port | default 50051 }}
      targetPort: grpc
      protocol: TCP
      name: grpc
      {{- if $app.debug.nodePort }}
      nodePort: {{ $app.debug.nodePort }}
      {{- end }}
  selector:
    {{- include "angzarr.selectorLabels" $ | nindent 4 }}
    app.kubernetes.io/component: saga
    angzarr.io/app: {{ $app.name }}
{{- end }}
{{- end }}
