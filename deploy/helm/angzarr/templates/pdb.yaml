{{- if .Values.podDisruptionBudget.enabled }}
{{- /*
PodDisruptionBudgets for angzarr components.
Ensures minimum availability during voluntary disruptions (node drains, upgrades).

Strategy:
- Aggregates: minAvailable based on replicaCount (critical for command handling)
- Sagas/Projectors: maxUnavailable 1 (can tolerate brief interruption, events will replay)
- Infrastructure: minAvailable 1 (gateway/stream should always have 1 available)
*/}}

{{- /* Aggregate PDBs */}}
{{- range .Values.applications.business }}
{{- if gt (int ($.Values.replicaCount | default 1)) 1 }}
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: {{ include "angzarr.fullname" $ }}-{{ .name }}-pdb
  labels:
    {{- include "angzarr.labels" $ | nindent 4 }}
    app.kubernetes.io/component: aggregate
    angzarr.io/domain: {{ .domain }}
spec:
  {{- if $.Values.podDisruptionBudget.minAvailable }}
  minAvailable: {{ $.Values.podDisruptionBudget.minAvailable }}
  {{- else }}
  maxUnavailable: {{ $.Values.podDisruptionBudget.maxUnavailable | default 1 }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "angzarr.selectorLabels" $ | nindent 6 }}
      app.kubernetes.io/component: aggregate
      angzarr.io/app: {{ .name }}
{{- end }}
{{- end }}

{{- /* Saga PDBs */}}
{{- range .Values.applications.sagas }}
{{- if gt (int ($.Values.replicaCount | default 1)) 1 }}
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: {{ include "angzarr.fullname" $ }}-{{ .name }}-pdb
  labels:
    {{- include "angzarr.labels" $ | nindent 4 }}
    app.kubernetes.io/component: saga
    angzarr.io/domain: {{ .sourceDomain }}
spec:
  maxUnavailable: {{ $.Values.podDisruptionBudget.sagaMaxUnavailable | default 1 }}
  selector:
    matchLabels:
      {{- include "angzarr.selectorLabels" $ | nindent 6 }}
      app.kubernetes.io/component: saga
      angzarr.io/app: {{ .name }}
{{- end }}
{{- end }}

{{- /* Projector PDBs */}}
{{- range .Values.applications.projectors }}
{{- if gt (int ($.Values.replicaCount | default 1)) 1 }}
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: {{ include "angzarr.fullname" $ }}-{{ .name }}-pdb
  labels:
    {{- include "angzarr.labels" $ | nindent 4 }}
    app.kubernetes.io/component: projector
    angzarr.io/domain: {{ .domain }}
spec:
  maxUnavailable: {{ $.Values.podDisruptionBudget.projectorMaxUnavailable | default 1 }}
  selector:
    matchLabels:
      {{- include "angzarr.selectorLabels" $ | nindent 6 }}
      app.kubernetes.io/component: projector
      angzarr.io/app: {{ .name }}
{{- end }}
{{- end }}

{{- /* Process Manager PDBs */}}
{{- range .Values.applications.processManagers }}
{{- if gt (int ($.Values.replicaCount | default 1)) 1 }}
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: {{ include "angzarr.fullname" $ }}-{{ .name }}-pdb
  labels:
    {{- include "angzarr.labels" $ | nindent 4 }}
    app.kubernetes.io/component: processManager
spec:
  maxUnavailable: {{ $.Values.podDisruptionBudget.processManagerMaxUnavailable | default 1 }}
  selector:
    matchLabels:
      {{- include "angzarr.selectorLabels" $ | nindent 6 }}
      app.kubernetes.io/component: processManager
      angzarr.io/app: {{ .name }}
{{- end }}
{{- end }}

{{- /* Gateway PDB */}}
{{- if and .Values.infrastructure.gateway.enabled (gt (int (.Values.infrastructure.gateway.replicas | default 1)) 1) }}
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: {{ include "angzarr.fullname" $ }}-gateway-pdb
  labels:
    {{- include "angzarr.labels" $ | nindent 4 }}
    app.kubernetes.io/component: infrastructure
    angzarr.io/service: gateway
spec:
  minAvailable: 1
  selector:
    matchLabels:
      {{- include "angzarr.selectorLabels" $ | nindent 6 }}
      angzarr.io/service: gateway
{{- end }}

{{- /* Stream PDB */}}
{{- if and .Values.infrastructure.stream.enabled (gt (int (.Values.infrastructure.stream.replicas | default 1)) 1) }}
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: {{ include "angzarr.fullname" $ }}-stream-pdb
  labels:
    {{- include "angzarr.labels" $ | nindent 4 }}
    app.kubernetes.io/component: infrastructure
    angzarr.io/service: stream
spec:
  minAvailable: 1
  selector:
    matchLabels:
      {{- include "angzarr.selectorLabels" $ | nindent 6 }}
      angzarr.io/service: stream
{{- end }}

{{- end }}
