{{- /* ConfigMap for angzarr configuration */}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "angzarr.fullname" . }}-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "angzarr.labels" . | nindent 4 }}
data:
  config.yaml: |
    # Angzarr configuration - generated by Helm

    storage:
      type: {{ .Values.storage.type }}
      {{- if eq .Values.storage.type "sqlite" }}
      path: /app/data/events.db
      {{- else if eq .Values.storage.type "mongodb" }}
      path: {{ .Values.storage.mongodb.uri }}
      database: {{ .Values.storage.mongodb.database }}
      {{- end }}

    server:
      command_handler_port: {{ .Values.service.commandPort }}
      event_query_port: {{ .Values.service.queryPort }}
      host: "0.0.0.0"

    {{- if .Values.amqp.enabled }}
    amqp:
      url: {{ .Values.amqp.url | quote }}
    {{- end }}

    {{- if .Values.applications.business }}
    business_logic:
      {{- range .Values.applications.business }}
      - domain: {{ .domain }}
        address: {{ include "angzarr.fullname" $ }}-{{ .name }}:{{ .port }}
      {{- end }}
    {{- end }}

    {{- if .Values.applications.projectors }}
    projectors:
      {{- range .Values.applications.projectors }}
      - name: {{ .name }}
        address: {{ include "angzarr.fullname" $ }}-{{ .name }}:{{ .port | default 50051 }}
        synchronous: {{ .synchronous | default false }}
      {{- end }}
    {{- end }}

    {{- if .Values.applications.sagas }}
    sagas:
      {{- range .Values.applications.sagas }}
      - name: {{ .name }}
        address: {{ include "angzarr.fullname" $ }}-{{ .name }}:{{ .port | default 50051 }}
        synchronous: {{ .synchronous | default false }}
      {{- end }}
    {{- end }}
