{{- /* ConfigMap for angzarr configuration */}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "angzarr.fullname" . }}-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "angzarr.labels" . | nindent 4 }}
data:
  config.yaml: |
    # Angzarr configuration - generated by Helm

    storage:
      type: {{ .Values.storage.type }}
      mongodb:
        uri: {{ .Values.storage.mongodb.uri | default "mongodb://localhost:27017" | quote }}
        database: {{ .Values.storage.mongodb.database | default "angzarr" | quote }}
      postgres:
        uri: {{ .Values.storage.postgres.uri | default "postgres://localhost:5432/angzarr" | quote }}
      eventstoredb:
        connection_string: {{ .Values.storage.eventstoredb.connectionString | default "esdb://localhost:2113?tls=false" | quote }}

    server:
      entity_port: {{ .Values.service.entityPort }}
      event_query_port: {{ .Values.service.queryPort }}
      host: "0.0.0.0"

    {{- if .Values.amqp.enabled }}
    messaging:
      type: amqp
      amqp:
        url: {{ .Values.amqp.url | quote }}
    {{- end }}

    {{- if .Values.applications.business }}
    business_logic:
      {{- range .Values.applications.business }}
      - domain: {{ .domain }}
        address: {{ include "angzarr.fullname" $ }}-{{ .name }}:{{ .port }}
      {{- end }}
    {{- end }}

    {{- if .Values.applications.projectors }}
    projectors:
      {{- range .Values.applications.projectors }}
      - name: {{ .name }}
        address: {{ include "angzarr.fullname" $ }}-{{ .name }}:{{ .port | default 50051 }}
        synchronous: {{ .synchronous | default false }}
      {{- end }}
    {{- end }}

    {{- if .Values.applications.sagas }}
    sagas:
      {{- range .Values.applications.sagas }}
      - name: {{ .name }}
        address: {{ include "angzarr.fullname" $ }}-{{ .name }}:{{ .port | default 50051 }}
        synchronous: {{ .synchronous | default false }}
      {{- end }}
    {{- end }}
