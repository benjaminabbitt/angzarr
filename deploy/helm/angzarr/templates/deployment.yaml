{{- /* Generate deployments for each application type with angzarr as sidecar */}}

{{- /* Business logic deployments */}}
{{- range .Values.applications.business }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "angzarr.fullname" $ }}-{{ .name }}
  labels:
    {{- include "angzarr.labels" $ | nindent 4 }}
    app.kubernetes.io/component: aggregate
    angzarr.io/domain: {{ .domain }}
  {{- if $.Values.reloader.enabled }}
  annotations:
    reloader.stakater.com/auto: "true"
  {{- end }}
spec:
  {{- if not $.Values.autoscaling.enabled }}
  replicas: {{ $.Values.replicaCount }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "angzarr.selectorLabels" $ | nindent 6 }}
      app.kubernetes.io/component: aggregate
      angzarr.io/app: {{ .name }}
  template:
    metadata:
      annotations:
        {{- if $.Values.reloader.enabled }}
        reloader.stakater.com/auto: "true"
        {{- end }}
        {{- with $.Values.podAnnotations }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      labels:
        {{- include "angzarr.labels" $ | nindent 8 }}
        app.kubernetes.io/component: aggregate
        angzarr.io/app: {{ .name }}
        angzarr.io/domain: {{ .domain }}
    spec:
      {{- with $.Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "angzarr.serviceAccountName" $ }}
      securityContext:
        {{- toYaml $.Values.podSecurityContext | nindent 8 }}
      initContainers:
        {{- if eq $.Values.storage.type "mongodb" }}
        # Wait for MongoDB (deployed by Terraform)
        - name: wait-for-mongodb
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for MongoDB..."
              until nc -z angzarr-db-mongodb 27017 2>/dev/null; do sleep 2; done
              echo "MongoDB is ready"
        {{- end }}
        {{- if $.Values.amqp.enabled }}
        # Wait for RabbitMQ (deployed by Terraform)
        - name: wait-for-rabbitmq
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for RabbitMQ..."
              until nc -z angzarr-mq-rabbitmq 5672 2>/dev/null; do sleep 2; done
              echo "RabbitMQ is ready"
        {{- end }}
      containers:
        # Main container: Business logic application
        - name: {{ .name }}
          image: "{{ .image.repository }}:{{ .image.tag }}"
          imagePullPolicy: {{ .image.pullPolicy | default "IfNotPresent" }}
          ports:
            - name: grpc
              containerPort: {{ .port }}
              protocol: TCP
            {{- if $.Values.debug.enabled }}
            - name: debug
              containerPort: {{ add .port 1 }}
              protocol: TCP
            {{- end }}
          env:
            # Business logic application port (sidecar calls this)
            - name: PORT
              value: "{{ .port }}"
            - name: DOMAIN
              value: {{ .domain | quote }}
            # Angzarr sidecar endpoint (consolidated on single port)
            - name: ANGZARR_HOST
              value: "localhost"
            - name: ANGZARR_PORT
              value: "{{ $.Values.service.aggregatePort }}"
            {{- if eq .type "python" }}
            - name: BUSINESS_LOGIC_TYPE
              value: "python"
            - name: PYTHON_MODULE
              value: {{ .python.module | quote }}
            - name: PYTHON_PATH
              value: {{ .python.path | quote }}
            {{- end }}
            {{- if eq .type "go" }}
            - name: BUSINESS_LOGIC_TYPE
              value: "go"
            - name: GO_LIBRARY
              value: {{ .go.library | quote }}
            {{- end }}
            - name: ANGZARR_LOG
              value: {{ $.Values.logging.level }}
          resources:
            {{- if .resources }}
            {{- toYaml .resources | nindent 12 }}
            {{- else }}
            {{- toYaml $.Values.applicationResources | nindent 12 }}
            {{- end }}
          securityContext:
            {{- include "angzarr.containerSecurityContext" $ | nindent 12 }}

        # Sidecar: Angzarr entity sidecar
        - name: angzarr
          securityContext:
            {{- include "angzarr.containerSecurityContext" $ | nindent 12 }}
          image: "{{ $.Values.images.aggregate.repository }}:{{ $.Values.images.aggregate.tag | default $.Chart.AppVersion }}"
          imagePullPolicy: {{ $.Values.images.aggregate.pullPolicy }}
          ports:
            - name: entity
              containerPort: {{ $.Values.service.aggregatePort }}
              protocol: TCP
            - name: query
              containerPort: {{ $.Values.service.queryPort }}
              protocol: TCP
            {{- if $.Values.debug.enabled }}
            - name: debug
              containerPort: {{ add $.Values.service.aggregatePort 1 }}
              protocol: TCP
            {{- end }}
          env:
            - name: ANGZARR_LOG
              value: {{ $.Values.logging.level }}
            # Namespace for K8s service discovery
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            # Server ports (ANGZARR__ prefix with __ separator)
            - name: ANGZARR__SERVER__AGGREGATE_PORT
              value: "{{ $.Values.service.aggregatePort }}"
            - name: ANGZARR__SERVER__EVENT_QUERY_PORT
              value: "{{ $.Values.service.queryPort }}"
            # Target configuration
            - name: ANGZARR__TARGET__ADDRESS
              value: "localhost:{{ .port }}"
            - name: ANGZARR__TARGET__DOMAIN
              value: {{ .domain | quote }}
            # Storage configuration - override from secret if provided
            {{- if $.Values.storage.existingSecret }}
            - name: ANGZARR__STORAGE__TYPE
              value: {{ $.Values.storage.type | quote }}
            - name: ANGZARR__STORAGE__MONGODB__URI
              valueFrom:
                secretKeyRef:
                  name: {{ $.Values.storage.existingSecret }}
                  key: uri
            - name: ANGZARR__STORAGE__MONGODB__DATABASE
              valueFrom:
                secretKeyRef:
                  name: {{ $.Values.storage.existingSecret }}
                  key: database
            {{- end }}
            # AMQP configuration
            {{- if $.Values.amqp.enabled }}
            - name: ANGZARR__MESSAGING__TYPE
              value: "amqp"
            - name: ANGZARR__MESSAGING__AMQP__URL
              {{- if $.Values.amqp.existingSecret }}
              valueFrom:
                secretKeyRef:
                  name: {{ $.Values.amqp.existingSecret }}
                  key: uri
              {{- else }}
              value: {{ $.Values.amqp.url }}
              {{- end }}
            {{- end }}
          livenessProbe:
            {{- toYaml $.Values.livenessProbe | nindent 12 }}
          readinessProbe:
            {{- toYaml $.Values.readinessProbe | nindent 12 }}
          resources:
            {{- toYaml $.Values.resources | nindent 12 }}
      {{- with $.Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with $.Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with $.Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
{{- end }}

{{- /* Projector deployments */}}
{{- range .Values.applications.projectors }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "angzarr.fullname" $ }}-{{ .name }}
  labels:
    {{- include "angzarr.labels" $ | nindent 4 }}
    app.kubernetes.io/component: projector
  {{- if $.Values.reloader.enabled }}
  annotations:
    reloader.stakater.com/auto: "true"
  {{- end }}
spec:
  {{- if not $.Values.autoscaling.enabled }}
  replicas: {{ $.Values.replicaCount }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "angzarr.selectorLabels" $ | nindent 6 }}
      app.kubernetes.io/component: projector
      angzarr.io/app: {{ .name }}
  template:
    metadata:
      annotations:
        {{- if $.Values.reloader.enabled }}
        reloader.stakater.com/auto: "true"
        {{- end }}
        {{- with $.Values.podAnnotations }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      labels:
        {{- include "angzarr.labels" $ | nindent 8 }}
        app.kubernetes.io/component: projector
        angzarr.io/app: {{ .name }}
    spec:
      {{- with $.Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "angzarr.serviceAccountName" $ }}
      securityContext:
        {{- toYaml $.Values.podSecurityContext | nindent 8 }}
      initContainers:
        {{- if $.Values.amqp.enabled }}
        # Wait for RabbitMQ (deployed by Terraform)
        - name: wait-for-rabbitmq
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for RabbitMQ..."
              until nc -z angzarr-mq-rabbitmq 5672 2>/dev/null; do sleep 2; done
              echo "RabbitMQ is ready"
        {{- end }}
      containers:
        # Main container: Projector application
        - name: {{ .name }}
          image: "{{ .image.repository }}:{{ .image.tag }}"
          imagePullPolicy: {{ .image.pullPolicy | default "IfNotPresent" }}
          ports:
            - name: grpc
              containerPort: {{ .port | default 50051 }}
              protocol: TCP
            {{- if $.Values.debug.enabled }}
            - name: debug
              containerPort: {{ add (.port | default 50051) 1 }}
              protocol: TCP
            {{- end }}
          env:
            # gRPC port this projector listens on
            # Projector application port
            - name: PORT
              value: "{{ .port | default 50051 }}"
            # Angzarr sidecar endpoint (consolidated on single port)
            - name: ANGZARR_HOST
              value: "localhost"
            - name: ANGZARR_PORT
              value: "{{ $.Values.service.queryPort }}"
            # AMQP for event subscription
            {{- if $.Values.amqp.enabled }}
            - name: MESSAGING_TYPE
              value: "amqp"
            - name: MESSAGING_AMQP_URL
              {{- if $.Values.amqp.existingSecret }}
              valueFrom:
                secretKeyRef:
                  name: {{ $.Values.amqp.existingSecret }}
                  key: uri
              {{- else }}
              value: {{ $.Values.amqp.url | quote }}
              {{- end }}
            {{- end }}
            - name: EVENT_TOPICS
              value: {{ .topics | join "," | quote }}
            - name: ANGZARR_LOG
              value: {{ $.Values.logging.level }}
          resources:
            {{- if .resources }}
            {{- toYaml .resources | nindent 12 }}
            {{- else }}
            {{- toYaml $.Values.applicationResources | nindent 12 }}
            {{- end }}
          securityContext:
            {{- include "angzarr.containerSecurityContext" $ | nindent 12 }}

        # Sidecar: Angzarr projector sidecar
        # Uses environment variables for configuration (no config file)
        - name: angzarr
          securityContext:
            {{- include "angzarr.containerSecurityContext" $ | nindent 12 }}
          image: "{{ $.Values.images.projector.repository }}:{{ $.Values.images.projector.tag | default $.Chart.AppVersion }}"
          imagePullPolicy: {{ $.Values.images.projector.pullPolicy }}
          ports:
            - name: query
              containerPort: {{ $.Values.service.queryPort }}
              protocol: TCP
            {{- if $.Values.debug.enabled }}
            - name: debug
              containerPort: {{ add $.Values.service.queryPort 1 }}
              protocol: TCP
            {{- end }}
          env:
            - name: ANGZARR_LOG
              value: {{ $.Values.logging.level }}
            # Server ports (ANGZARR__ prefix with __ separator)
            - name: ANGZARR__SERVER__EVENT_QUERY_PORT
              value: "{{ $.Values.service.queryPort }}"
            # Projector sidecar target address
            - name: ANGZARR__TARGET__ADDRESS
              value: "localhost:{{ .port | default 50051 }}"
            # Storage configuration - from secret if provided
            {{- if $.Values.storage.existingSecret }}
            - name: ANGZARR__STORAGE__TYPE
              value: {{ $.Values.storage.type | quote }}
            - name: ANGZARR__STORAGE__MONGODB__URI
              valueFrom:
                secretKeyRef:
                  name: {{ $.Values.storage.existingSecret }}
                  key: uri
            - name: ANGZARR__STORAGE__MONGODB__DATABASE
              valueFrom:
                secretKeyRef:
                  name: {{ $.Values.storage.existingSecret }}
                  key: database
            {{- else }}
            - name: ANGZARR__STORAGE__TYPE
              value: {{ $.Values.storage.type | quote }}
            - name: ANGZARR__STORAGE__MONGODB__URI
              value: {{ $.Values.storage.mongodb.uri | quote }}
            - name: ANGZARR__STORAGE__MONGODB__DATABASE
              value: {{ $.Values.storage.mongodb.database | quote }}
            {{- end }}
            # Messaging configuration
            {{- if $.Values.amqp.enabled }}
            - name: ANGZARR__MESSAGING__TYPE
              value: "amqp"
            - name: ANGZARR__MESSAGING__AMQP__URL
              {{- if $.Values.amqp.existingSecret }}
              valueFrom:
                secretKeyRef:
                  name: {{ $.Values.amqp.existingSecret }}
                  key: uri
              {{- else }}
              value: {{ $.Values.amqp.url }}
              {{- end }}
            - name: ANGZARR__MESSAGING__AMQP__DOMAIN
              value: {{ .topics | first | default "#" | quote }}
            {{- end }}
          resources:
            {{- toYaml $.Values.resources | nindent 12 }}
      {{- with $.Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with $.Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with $.Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
{{- end }}

{{- /* Saga deployments */}}
{{- range .Values.applications.sagas }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "angzarr.fullname" $ }}-{{ .name }}
  labels:
    {{- include "angzarr.labels" $ | nindent 4 }}
    app.kubernetes.io/component: saga
  {{- if $.Values.reloader.enabled }}
  annotations:
    reloader.stakater.com/auto: "true"
  {{- end }}
spec:
  {{- if not $.Values.autoscaling.enabled }}
  replicas: {{ $.Values.replicaCount }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "angzarr.selectorLabels" $ | nindent 6 }}
      app.kubernetes.io/component: saga
      angzarr.io/app: {{ .name }}
  template:
    metadata:
      annotations:
        {{- if $.Values.reloader.enabled }}
        reloader.stakater.com/auto: "true"
        {{- end }}
        {{- with $.Values.podAnnotations }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      labels:
        {{- include "angzarr.labels" $ | nindent 8 }}
        app.kubernetes.io/component: saga
        angzarr.io/app: {{ .name }}
    spec:
      {{- with $.Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "angzarr.serviceAccountName" $ }}
      securityContext:
        {{- toYaml $.Values.podSecurityContext | nindent 8 }}
      initContainers:
        {{- if $.Values.amqp.enabled }}
        # Wait for RabbitMQ (deployed by Terraform)
        - name: wait-for-rabbitmq
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for RabbitMQ..."
              until nc -z angzarr-mq-rabbitmq 5672 2>/dev/null; do sleep 2; done
              echo "RabbitMQ is ready"
        {{- end }}
      containers:
        # Main container: Saga application
        - name: {{ .name }}
          image: "{{ .image.repository }}:{{ .image.tag }}"
          imagePullPolicy: {{ .image.pullPolicy | default "IfNotPresent" }}
          ports:
            - name: grpc
              containerPort: {{ .port | default 50051 }}
              protocol: TCP
            {{- if $.Values.debug.enabled }}
            - name: debug
              containerPort: {{ add (.port | default 50051) 1 }}
              protocol: TCP
            {{- end }}
          env:
            # Saga application port
            - name: PORT
              value: "{{ .port | default 50051 }}"
            # Angzarr sidecar endpoint (consolidated on single port)
            - name: ANGZARR_HOST
              value: "localhost"
            - name: ANGZARR_PORT
              value: "{{ $.Values.service.aggregatePort }}"
            # AMQP for event subscription
            {{- if $.Values.amqp.enabled }}
            - name: MESSAGING_TYPE
              value: "amqp"
            - name: MESSAGING_AMQP_URL
              {{- if $.Values.amqp.existingSecret }}
              valueFrom:
                secretKeyRef:
                  name: {{ $.Values.amqp.existingSecret }}
                  key: uri
              {{- else }}
              value: {{ $.Values.amqp.url | quote }}
              {{- end }}
            {{- end }}
            - name: EVENT_TOPICS
              value: {{ .topics | join "," | quote }}
            - name: ANGZARR_LOG
              value: {{ $.Values.logging.level }}
          resources:
            {{- if .resources }}
            {{- toYaml .resources | nindent 12 }}
            {{- else }}
            {{- toYaml $.Values.applicationResources | nindent 12 }}
            {{- end }}
          securityContext:
            {{- include "angzarr.containerSecurityContext" $ | nindent 12 }}

        # Sidecar: Angzarr saga sidecar
        # Uses environment variables for configuration (no config file)
        - name: angzarr
          securityContext:
            {{- include "angzarr.containerSecurityContext" $ | nindent 12 }}
          image: "{{ $.Values.images.saga.repository }}:{{ $.Values.images.saga.tag | default $.Chart.AppVersion }}"
          imagePullPolicy: {{ $.Values.images.saga.pullPolicy }}
          ports:
            - name: entity
              containerPort: {{ $.Values.service.aggregatePort }}
              protocol: TCP
            - name: query
              containerPort: {{ $.Values.service.queryPort }}
              protocol: TCP
            {{- if $.Values.debug.enabled }}
            - name: debug
              containerPort: {{ add $.Values.service.aggregatePort 1 }}
              protocol: TCP
            {{- end }}
          env:
            - name: ANGZARR_LOG
              value: {{ $.Values.logging.level }}
            # Server ports (ANGZARR__ prefix with __ separator)
            - name: ANGZARR__SERVER__AGGREGATE_PORT
              value: "{{ $.Values.service.aggregatePort }}"
            - name: ANGZARR__SERVER__EVENT_QUERY_PORT
              value: "{{ $.Values.service.queryPort }}"
            # Saga sidecar target address
            - name: ANGZARR__TARGET__ADDRESS
              value: "localhost:{{ .port | default 50051 }}"
            # Storage configuration - from secret if provided
            {{- if $.Values.storage.existingSecret }}
            - name: ANGZARR__STORAGE__TYPE
              value: {{ $.Values.storage.type | quote }}
            - name: ANGZARR__STORAGE__MONGODB__URI
              valueFrom:
                secretKeyRef:
                  name: {{ $.Values.storage.existingSecret }}
                  key: uri
            - name: ANGZARR__STORAGE__MONGODB__DATABASE
              valueFrom:
                secretKeyRef:
                  name: {{ $.Values.storage.existingSecret }}
                  key: database
            {{- else }}
            - name: ANGZARR__STORAGE__TYPE
              value: {{ $.Values.storage.type | quote }}
            - name: ANGZARR__STORAGE__MONGODB__URI
              value: {{ $.Values.storage.mongodb.uri | quote }}
            - name: ANGZARR__STORAGE__MONGODB__DATABASE
              value: {{ $.Values.storage.mongodb.database | quote }}
            {{- end }}
            # Messaging configuration
            {{- if $.Values.amqp.enabled }}
            - name: ANGZARR__MESSAGING__TYPE
              value: "amqp"
            - name: ANGZARR__MESSAGING__AMQP__URL
              {{- if $.Values.amqp.existingSecret }}
              valueFrom:
                secretKeyRef:
                  name: {{ $.Values.amqp.existingSecret }}
                  key: uri
              {{- else }}
              value: {{ $.Values.amqp.url }}
              {{- end }}
            - name: ANGZARR__MESSAGING__AMQP__DOMAIN
              value: {{ .topics | first | default "#" | quote }}
            {{- end }}
          # NOTE: No liveness/readiness probes - saga sidecar is a pure consumer (no server ports)
          resources:
            {{- toYaml $.Values.resources | nindent 12 }}
      {{- with $.Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with $.Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with $.Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
{{- end }}

{{- /* Central infrastructure services */}}

{{- /* Event Stream service - infrastructure projector with sidecar */}}
{{- if .Values.infrastructure.stream.enabled }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "angzarr.fullname" . }}-stream
  labels:
    {{- include "angzarr.labels" . | nindent 4 }}
    app.kubernetes.io/component: infrastructure
    angzarr.io/service: stream
  {{- if .Values.reloader.enabled }}
  annotations:
    reloader.stakater.com/auto: "true"
  {{- end }}
spec:
  replicas: {{ .Values.infrastructure.stream.replicas }}
  selector:
    matchLabels:
      {{- include "angzarr.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: infrastructure
      angzarr.io/service: stream
  template:
    metadata:
      labels:
        {{- include "angzarr.labels" . | nindent 8 }}
        app.kubernetes.io/component: infrastructure
        angzarr.io/service: stream
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "angzarr.serviceAccountName" . }}
      securityContext:
        {{- toYaml .Values.podSecurityContext | nindent 8 }}
      initContainers:
        {{- if .Values.amqp.enabled }}
        # Wait for RabbitMQ (deployed by Terraform)
        - name: wait-for-rabbitmq
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for RabbitMQ..."
              until nc -z angzarr-mq-rabbitmq 5672 2>/dev/null; do sleep 2; done
              echo "RabbitMQ is ready"
        {{- end }}
      containers:
        # Stream projector - receives events from sidecar, exposes EventStream for gateway
        - name: stream
          securityContext:
            {{- include "angzarr.containerSecurityContext" . | nindent 12 }}
          image: "{{ .Values.images.stream.repository }}:{{ .Values.images.stream.tag | default .Chart.AppVersion }}"
          imagePullPolicy: {{ .Values.images.stream.pullPolicy }}
          ports:
            # Projector gRPC (receives events from sidecar) + EventStream gRPC (for gateway)
            - name: grpc
              containerPort: {{ .Values.infrastructure.stream.projectorPort | default 50051 }}
              protocol: TCP
          env:
            - name: ANGZARR_LOG
              value: {{ .Values.logging.level }}
            # Port for Projector + EventStream gRPC services
            - name: ANGZARR_PORT
              value: "{{ .Values.infrastructure.stream.projectorPort | default 50051 }}"
          resources:
            {{- toYaml .Values.infrastructure.stream.resources | nindent 12 }}

        # Projector sidecar - subscribes to all AMQP events and forwards to stream
        - name: angzarr
          securityContext:
            {{- include "angzarr.containerSecurityContext" . | nindent 12 }}
          image: "{{ .Values.images.projector.repository }}:{{ .Values.images.projector.tag | default .Chart.AppVersion }}"
          imagePullPolicy: {{ .Values.images.projector.pullPolicy }}
          env:
            - name: ANGZARR_LOG
              value: {{ .Values.logging.level }}
            # Target: stream projector container
            - name: ANGZARR__TARGET__ADDRESS
              value: "localhost:{{ .Values.infrastructure.stream.projectorPort | default 50051 }}"
            # Subscribe to ALL events (stream forwards by correlation ID)
            {{- if .Values.amqp.enabled }}
            - name: ANGZARR__MESSAGING__TYPE
              value: "amqp"
            - name: ANGZARR__MESSAGING__AMQP__URL
              {{- if .Values.amqp.existingSecret }}
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.amqp.existingSecret }}
                  key: uri
              {{- else }}
              value: {{ .Values.amqp.url }}
              {{- end }}
            # Subscribe to all domains
            - name: ANGZARR__MESSAGING__AMQP__DOMAIN
              value: "#"
            {{- end }}
          resources:
            {{- toYaml .Values.resources | nindent 12 }}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
{{- end }}

{{- /* Command Proxy service */}}
{{- if .Values.infrastructure.gateway.enabled }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "angzarr.fullname" . }}-gateway
  labels:
    {{- include "angzarr.labels" . | nindent 4 }}
    app.kubernetes.io/component: infrastructure
    angzarr.io/service: gateway
  {{- if .Values.reloader.enabled }}
  annotations:
    reloader.stakater.com/auto: "true"
  {{- end }}
spec:
  replicas: {{ .Values.infrastructure.gateway.replicas }}
  selector:
    matchLabels:
      {{- include "angzarr.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: infrastructure
      angzarr.io/service: gateway
  template:
    metadata:
      labels:
        {{- include "angzarr.labels" . | nindent 8 }}
        app.kubernetes.io/component: infrastructure
        angzarr.io/service: gateway
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "angzarr.serviceAccountName" . }}
      securityContext:
        {{- toYaml .Values.podSecurityContext | nindent 8 }}
      containers:
        - name: gateway
          securityContext:
            {{- include "angzarr.containerSecurityContext" . | nindent 12 }}
          image: "{{ .Values.images.gateway.repository }}:{{ .Values.images.gateway.tag | default .Chart.AppVersion }}"
          imagePullPolicy: {{ .Values.images.gateway.pullPolicy }}
          ports:
            - name: grpc
              containerPort: {{ .Values.infrastructure.gateway.port }}
              protocol: TCP
            {{- if .Values.debug.enabled }}
            - name: debug
              containerPort: {{ add .Values.infrastructure.gateway.port 1 }}
              protocol: TCP
            {{- end }}
          env:
            - name: ANGZARR_LOG
              value: {{ .Values.logging.level }}
            # Standard Angzarr port - used across all languages/containers
            - name: ANGZARR_PORT
              value: "{{ .Values.infrastructure.gateway.port }}"
            # Namespace for K8s service discovery (from downward API)
            - name: NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            {{- if .Values.infrastructure.gateway.entities }}
            # Domain-based routing: domain=address pairs (overrides K8s discovery)
            - name: COMMAND_HANDLERS
              value: {{ range $domain, $addr := .Values.infrastructure.gateway.entities }}{{ $domain }}={{ $addr }},{{ end }}
            {{- else if .Values.infrastructure.gateway.entityService }}
            # Single command service (legacy, overrides K8s discovery)
            - name: COMMAND_ADDRESS
              value: {{ .Values.infrastructure.gateway.entityService | quote }}
            {{- end }}
            - name: STREAM_ADDRESS
              value: {{ .Values.infrastructure.gateway.streamService | default (printf "%s-stream:%d" (include "angzarr.fullname" .) (.Values.infrastructure.stream.port | int)) | quote }}
            - name: STREAM_TIMEOUT_SECS
              value: "{{ .Values.infrastructure.gateway.streamTimeoutSecs }}"
          resources:
            {{- toYaml .Values.infrastructure.gateway.resources | nindent 12 }}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
{{- end }}

{{- /* Log projector service - infrastructure projector for debugging */}}
{{- if .Values.infrastructure.log.enabled }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "angzarr.fullname" . }}-log
  labels:
    {{- include "angzarr.labels" . | nindent 4 }}
    app.kubernetes.io/component: infrastructure
    angzarr.io/service: log
  {{- if .Values.reloader.enabled }}
  annotations:
    reloader.stakater.com/auto: "true"
  {{- end }}
spec:
  replicas: {{ .Values.infrastructure.log.replicas }}
  selector:
    matchLabels:
      {{- include "angzarr.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: infrastructure
      angzarr.io/service: log
  template:
    metadata:
      labels:
        {{- include "angzarr.labels" . | nindent 8 }}
        app.kubernetes.io/component: infrastructure
        angzarr.io/service: log
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "angzarr.serviceAccountName" . }}
      securityContext:
        {{- toYaml .Values.podSecurityContext | nindent 8 }}
      initContainers:
        {{- if .Values.amqp.enabled }}
        # Wait for RabbitMQ (deployed by Terraform)
        - name: wait-for-rabbitmq
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for RabbitMQ..."
              until nc -z angzarr-mq-rabbitmq 5672 2>/dev/null; do sleep 2; done
              echo "RabbitMQ is ready"
        {{- end }}
      containers:
        # Log projector - receives events from sidecar, prints to stdout
        - name: log
          securityContext:
            {{- include "angzarr.containerSecurityContext" . | nindent 12 }}
          image: "{{ .Values.images.log.repository }}:{{ .Values.images.log.tag | default .Chart.AppVersion }}"
          imagePullPolicy: {{ .Values.images.log.pullPolicy }}
          ports:
            # Projector gRPC (receives events from sidecar)
            - name: grpc
              containerPort: {{ .Values.infrastructure.log.port | default 50051 }}
              protocol: TCP
          env:
            - name: ANGZARR_LOG
              value: {{ .Values.logging.level }}
            # Port for Projector gRPC service
            - name: ANGZARR_PORT
              value: "{{ .Values.infrastructure.log.port | default 50051 }}"
          resources:
            {{- toYaml .Values.infrastructure.log.resources | nindent 12 }}

        # Projector sidecar - subscribes to all AMQP events and forwards to log
        - name: angzarr
          securityContext:
            {{- include "angzarr.containerSecurityContext" . | nindent 12 }}
          image: "{{ .Values.images.projector.repository }}:{{ .Values.images.projector.tag | default .Chart.AppVersion }}"
          imagePullPolicy: {{ .Values.images.projector.pullPolicy }}
          env:
            - name: ANGZARR_LOG
              value: {{ .Values.logging.level }}
            # Target: log projector container
            - name: ANGZARR__TARGET__ADDRESS
              value: "localhost:{{ .Values.infrastructure.log.port | default 50051 }}"
            # Subscribe to ALL events
            {{- if .Values.amqp.enabled }}
            - name: ANGZARR__MESSAGING__TYPE
              value: "amqp"
            - name: ANGZARR__MESSAGING__AMQP__URL
              {{- if .Values.amqp.existingSecret }}
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.amqp.existingSecret }}
                  key: uri
              {{- else }}
              value: {{ .Values.amqp.url }}
              {{- end }}
            # Subscribe to all domains
            - name: ANGZARR__MESSAGING__AMQP__DOMAIN
              value: "#"
            {{- end }}
          resources:
            {{- toYaml .Values.resources | nindent 12 }}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
{{- end }}
