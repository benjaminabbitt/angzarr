# syntax=docker/dockerfile:1.4
# Kotlin examples - multi-stage build with Gradle
# Build: podman build -t kt-customer --target customer -f examples/kotlin/Containerfile .
# Context must be repo root for proto access
# Cache mounts persist Gradle dependencies across builds

# ============================================================================
# Builder stage - compiles Kotlin projects with Gradle
# ============================================================================
FROM docker.io/library/gradle:8.11-jdk21-alpine AS builder

WORKDIR /app

# Copy proto files from repo root
COPY proto/ /app/proto/

# ============================================================================
# Build each service with Gradle cache mounts
# ============================================================================
FROM builder AS build-customer
COPY examples/kotlin/customer/build.gradle.kts examples/kotlin/customer/settings.gradle.kts ./
COPY examples/kotlin/customer/gradle/ ./gradle/
RUN --mount=type=cache,target=/home/gradle/.gradle \
    gradle dependencies --no-daemon || true
COPY examples/kotlin/customer/src/ ./src/
RUN --mount=type=cache,target=/home/gradle/.gradle \
    gradle shadowJar --no-daemon

FROM builder AS build-transaction
COPY examples/kotlin/transaction/build.gradle.kts examples/kotlin/transaction/settings.gradle.kts ./
COPY examples/kotlin/transaction/gradle/ ./gradle/
RUN --mount=type=cache,target=/home/gradle/.gradle \
    gradle dependencies --no-daemon || true
COPY examples/kotlin/transaction/src/ ./src/
RUN --mount=type=cache,target=/home/gradle/.gradle \
    gradle shadowJar --no-daemon

FROM builder AS build-saga-loyalty
COPY examples/kotlin/saga-loyalty/build.gradle.kts examples/kotlin/saga-loyalty/settings.gradle.kts ./
COPY examples/kotlin/saga-loyalty/gradle/ ./gradle/
RUN --mount=type=cache,target=/home/gradle/.gradle \
    gradle dependencies --no-daemon || true
COPY examples/kotlin/saga-loyalty/src/ ./src/
RUN --mount=type=cache,target=/home/gradle/.gradle \
    gradle shadowJar --no-daemon

FROM builder AS build-projector-receipt
COPY examples/kotlin/projector-receipt/build.gradle.kts examples/kotlin/projector-receipt/settings.gradle.kts ./
COPY examples/kotlin/projector-receipt/gradle/ ./gradle/
RUN --mount=type=cache,target=/home/gradle/.gradle \
    gradle dependencies --no-daemon || true
COPY examples/kotlin/projector-receipt/src/ ./src/
RUN --mount=type=cache,target=/home/gradle/.gradle \
    gradle shadowJar --no-daemon

FROM builder AS build-projector-log-customer
COPY examples/kotlin/projector-log-customer/build.gradle.kts examples/kotlin/projector-log-customer/settings.gradle.kts ./
COPY examples/kotlin/projector-log-customer/gradle/ ./gradle/
RUN --mount=type=cache,target=/home/gradle/.gradle \
    gradle dependencies --no-daemon || true
COPY examples/kotlin/projector-log-customer/src/ ./src/
RUN --mount=type=cache,target=/home/gradle/.gradle \
    gradle shadowJar --no-daemon

FROM builder AS build-projector-log-transaction
COPY examples/kotlin/projector-log-transaction/build.gradle.kts examples/kotlin/projector-log-transaction/settings.gradle.kts ./
COPY examples/kotlin/projector-log-transaction/gradle/ ./gradle/
RUN --mount=type=cache,target=/home/gradle/.gradle \
    gradle dependencies --no-daemon || true
COPY examples/kotlin/projector-log-transaction/src/ ./src/
RUN --mount=type=cache,target=/home/gradle/.gradle \
    gradle shadowJar --no-daemon

# ============================================================================
# Runtime base
# ============================================================================
FROM docker.io/library/eclipse-temurin:21-jre-alpine AS runtime
RUN apk --no-cache add ca-certificates
WORKDIR /app

# ============================================================================
# Service-specific images
# ============================================================================
FROM runtime AS customer
COPY --from=build-customer /app/build/libs/*-all.jar ./server.jar
ENV PORT=50500
EXPOSE 50500
CMD ["java", "-jar", "server.jar"]

FROM runtime AS transaction
COPY --from=build-transaction /app/build/libs/*-all.jar ./server.jar
ENV PORT=50501
EXPOSE 50501
CMD ["java", "-jar", "server.jar"]

FROM runtime AS saga-loyalty
COPY --from=build-saga-loyalty /app/build/libs/*-all.jar ./server.jar
ENV PORT=50502
EXPOSE 50502
CMD ["java", "-jar", "server.jar"]

FROM runtime AS projector-receipt
COPY --from=build-projector-receipt /app/build/libs/*-all.jar ./server.jar
ENV PORT=50503
EXPOSE 50503
CMD ["java", "-jar", "server.jar"]

FROM runtime AS projector-log-customer
COPY --from=build-projector-log-customer /app/build/libs/*-all.jar ./server.jar
ENV PORT=50504
EXPOSE 50504
CMD ["java", "-jar", "server.jar"]

FROM runtime AS projector-log-transaction
COPY --from=build-projector-log-transaction /app/build/libs/*-all.jar ./server.jar
ENV PORT=50505
EXPOSE 50505
CMD ["java", "-jar", "server.jar"]
