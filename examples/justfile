# Angzarr examples - multi-language gRPC implementations
# Language-specific commands are in their respective justfiles (e.g., rust/justfile)
#
# UNIFIED WORKFLOW:
#   1. From repo root: `just kind-create-registry && just infra-local` (one-time setup)
#   2. `just dev rust` - watch mode with auto-rebuild on changes
#   3. Or commit changes - lefthook triggers deployment automatically
#
# All 14 images use sha256 content-based tags.
# Skaffold caches aggressively - only changed images are rebuilt.
#
# For tests, run from repo root: `just integration` or `just acceptance`

set shell := ["bash", "-c"]

TOP := `git rev-parse --show-toplevel`

# Import language-specific justfiles as modules
mod rust "rust/justfile"
mod go "go/justfile"
mod python "python/justfile"

# Show available commands
default:
    @just --list

# ============================================================================
# Proto Management (cross-language)
# ============================================================================

# Copy canonical proto files to example directories (required before building)
proto-copy:
    @mkdir -p "{{TOP}}/examples/go/proto/examples"
    @mkdir -p "{{TOP}}/examples/python/proto/examples"
    cp "{{TOP}}/proto/examples/"*.proto "{{TOP}}/examples/go/proto/examples/"
    cp "{{TOP}}/proto/examples/"*.proto "{{TOP}}/examples/python/proto/examples/"

# Generate protos (required before building non-Rust examples)
proto: proto-copy
    cd "{{TOP}}" && just proto-generate

# ============================================================================
# Skaffold Shortcuts (delegates to language modules)
# ============================================================================

# Start examples with skaffold dev (file watching)
dev LANG:
    cd "{{TOP}}/examples/{{LANG}}" && skaffold dev

# Build and deploy examples once
run LANG:
    cd "{{TOP}}/examples/{{LANG}}" && skaffold run

# Delete skaffold deployment
delete LANG:
    cd "{{TOP}}/examples/{{LANG}}" && skaffold delete

# ============================================================================
# Cross-Language Operations
# ============================================================================

# Clean all examples
clean:
    just rust clean || true
    just go clean || true
    just python clean || true

# Format all examples
fmt:
    just rust fmt || true
    just go fmt || true
    just python fmt || true

# Lint all examples
lint:
    just rust lint || true
    just go lint || true
    just python lint || true

# Lint all Helm charts
helm-lint:
    just rust helm-lint || true
    just go helm-lint || true
    just python helm-lint || true

# ============================================================================
# Container Cache Management
# ============================================================================

# Show podman disk usage
cache-status:
    @echo "=== Podman System Disk Usage ==="
    podman system df
    @echo ""
    @echo "=== Example Images ==="
    podman images --filter "reference=*aggregate-*" --filter "reference=*saga-*"

# Prune unused images
cache-prune:
    @echo "Pruning dangling images..."
    podman image prune -f
    @echo ""
    podman system df
