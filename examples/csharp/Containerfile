# syntax=docker/dockerfile:1.4
# C# examples - optimized multi-stage build with trimming and self-contained
# Build: podman build -t cs-customer --target customer -f examples/csharp/Containerfile .
# Multi-arch: podman build --platform linux/amd64,linux/arm64 ...
# Context must be repo root for proto access
#
# Optimizations:
# 1. Shared deps-fetcher stage (all .csproj restored together)
# 2. PublishTrimmed + PublishSingleFile for minimal binaries
# 3. Self-contained deployment (no runtime dependency)
# 4. Distroless runtime - minimal attack surface (~35MB vs ~100MB)
# 5. Named cache IDs for NuGet persistence
# 6. Multi-arch support (amd64 + arm64)

ARG DOTNET_VERSION=8.0

# ============================================================================
# Base builder - common SDK
# ============================================================================
FROM mcr.microsoft.com/dotnet/sdk:${DOTNET_VERSION}-alpine AS builder

WORKDIR /app

# Copy proto files from repo root
COPY proto/ /app/proto/

# ============================================================================
# Deps fetcher - restores ALL project dependencies once
# This is the key caching optimization - shared across all services
# ============================================================================
FROM builder AS deps-fetcher

# Copy all .csproj files for dependency resolution
COPY examples/csharp/Customer/Customer.csproj /deps/Customer/
COPY examples/csharp/Product/Product.csproj /deps/Product/
COPY examples/csharp/Cart/Cart.csproj /deps/Cart/
COPY examples/csharp/Order/Order.csproj /deps/Order/
COPY examples/csharp/Inventory/Inventory.csproj /deps/Inventory/
COPY examples/csharp/Fulfillment/Fulfillment.csproj /deps/Fulfillment/
COPY examples/csharp/SagaFulfillment/SagaFulfillment.csproj /deps/SagaFulfillment/
COPY examples/csharp/SagaLoyaltyEarn/SagaLoyaltyEarn.csproj /deps/SagaLoyaltyEarn/
COPY examples/csharp/SagaCancellation/SagaCancellation.csproj /deps/SagaCancellation/
COPY examples/csharp/ProjectorReceipt/ProjectorReceipt.csproj /deps/ProjectorReceipt/

# Restore all dependencies in one layer with persistent cache
RUN --mount=type=cache,id=nuget-cache,target=/root/.nuget/packages,sharing=locked \
    for proj in /deps/*/*.csproj; do \
        dotnet restore "$proj"; \
    done

# ============================================================================
# Service builds - each publishes trimmed, self-contained binary
# ============================================================================
FROM deps-fetcher AS build-customer
WORKDIR /build
COPY examples/csharp/Customer/ ./
RUN --mount=type=cache,id=nuget-cache,target=/root/.nuget/packages,sharing=locked \
    dotnet publish -c Release -o /out \
    --self-contained true \
    -r linux-musl-x64 \
    /p:PublishTrimmed=true \
    /p:PublishSingleFile=true \
    /p:EnableCompressionInSingleFile=true

FROM deps-fetcher AS build-product
WORKDIR /build
COPY examples/csharp/Product/ ./
RUN --mount=type=cache,id=nuget-cache,target=/root/.nuget/packages,sharing=locked \
    dotnet publish -c Release -o /out \
    --self-contained true \
    -r linux-musl-x64 \
    /p:PublishTrimmed=true \
    /p:PublishSingleFile=true \
    /p:EnableCompressionInSingleFile=true

FROM deps-fetcher AS build-cart
WORKDIR /build
COPY examples/csharp/Cart/ ./
RUN --mount=type=cache,id=nuget-cache,target=/root/.nuget/packages,sharing=locked \
    dotnet publish -c Release -o /out \
    --self-contained true \
    -r linux-musl-x64 \
    /p:PublishTrimmed=true \
    /p:PublishSingleFile=true \
    /p:EnableCompressionInSingleFile=true

FROM deps-fetcher AS build-order
WORKDIR /build
COPY examples/csharp/Order/ ./
RUN --mount=type=cache,id=nuget-cache,target=/root/.nuget/packages,sharing=locked \
    dotnet publish -c Release -o /out \
    --self-contained true \
    -r linux-musl-x64 \
    /p:PublishTrimmed=true \
    /p:PublishSingleFile=true \
    /p:EnableCompressionInSingleFile=true

FROM deps-fetcher AS build-inventory
WORKDIR /build
COPY examples/csharp/Inventory/ ./
RUN --mount=type=cache,id=nuget-cache,target=/root/.nuget/packages,sharing=locked \
    dotnet publish -c Release -o /out \
    --self-contained true \
    -r linux-musl-x64 \
    /p:PublishTrimmed=true \
    /p:PublishSingleFile=true \
    /p:EnableCompressionInSingleFile=true

FROM deps-fetcher AS build-fulfillment
WORKDIR /build
COPY examples/csharp/Fulfillment/ ./
RUN --mount=type=cache,id=nuget-cache,target=/root/.nuget/packages,sharing=locked \
    dotnet publish -c Release -o /out \
    --self-contained true \
    -r linux-musl-x64 \
    /p:PublishTrimmed=true \
    /p:PublishSingleFile=true \
    /p:EnableCompressionInSingleFile=true

FROM deps-fetcher AS build-saga-fulfillment
WORKDIR /build
COPY examples/csharp/SagaFulfillment/ ./
RUN --mount=type=cache,id=nuget-cache,target=/root/.nuget/packages,sharing=locked \
    dotnet publish -c Release -o /out \
    --self-contained true \
    -r linux-musl-x64 \
    /p:PublishTrimmed=true \
    /p:PublishSingleFile=true \
    /p:EnableCompressionInSingleFile=true

FROM deps-fetcher AS build-saga-loyalty-earn
WORKDIR /build
COPY examples/csharp/SagaLoyaltyEarn/ ./
RUN --mount=type=cache,id=nuget-cache,target=/root/.nuget/packages,sharing=locked \
    dotnet publish -c Release -o /out \
    --self-contained true \
    -r linux-musl-x64 \
    /p:PublishTrimmed=true \
    /p:PublishSingleFile=true \
    /p:EnableCompressionInSingleFile=true

FROM deps-fetcher AS build-saga-cancellation
WORKDIR /build
COPY examples/csharp/SagaCancellation/ ./
RUN --mount=type=cache,id=nuget-cache,target=/root/.nuget/packages,sharing=locked \
    dotnet publish -c Release -o /out \
    --self-contained true \
    -r linux-musl-x64 \
    /p:PublishTrimmed=true \
    /p:PublishSingleFile=true \
    /p:EnableCompressionInSingleFile=true

FROM deps-fetcher AS build-projector-receipt
WORKDIR /build
COPY examples/csharp/ProjectorReceipt/ ./
RUN --mount=type=cache,id=nuget-cache,target=/root/.nuget/packages,sharing=locked \
    dotnet publish -c Release -o /out \
    --self-contained true \
    -r linux-musl-x64 \
    /p:PublishTrimmed=true \
    /p:PublishSingleFile=true \
    /p:EnableCompressionInSingleFile=true

# ============================================================================
# Runtime base - distroless (just needs libc for self-contained .NET)
# ============================================================================
FROM gcr.io/distroless/cc-debian12:nonroot AS runtime
WORKDIR /app
USER nonroot:nonroot

# ============================================================================
# Domain Aggregates
# ============================================================================
FROM runtime AS customer
COPY --from=build-customer --chown=nonroot:nonroot /out/Customer ./server
ENV PORT=50600 ASPNETCORE_URLS=http://+:50600
EXPOSE 50600
ENTRYPOINT ["./server"]

FROM runtime AS product
COPY --from=build-product --chown=nonroot:nonroot /out/Product ./server
ENV PORT=50601 ASPNETCORE_URLS=http://+:50601
EXPOSE 50601
ENTRYPOINT ["./server"]

FROM runtime AS cart
COPY --from=build-cart --chown=nonroot:nonroot /out/Cart ./server
ENV PORT=50602 ASPNETCORE_URLS=http://+:50602
EXPOSE 50602
ENTRYPOINT ["./server"]

FROM runtime AS order
COPY --from=build-order --chown=nonroot:nonroot /out/Order ./server
ENV PORT=50603 ASPNETCORE_URLS=http://+:50603
EXPOSE 50603
ENTRYPOINT ["./server"]

FROM runtime AS inventory
COPY --from=build-inventory --chown=nonroot:nonroot /out/Inventory ./server
ENV PORT=50604 ASPNETCORE_URLS=http://+:50604
EXPOSE 50604
ENTRYPOINT ["./server"]

FROM runtime AS fulfillment
COPY --from=build-fulfillment --chown=nonroot:nonroot /out/Fulfillment ./server
ENV PORT=50605 ASPNETCORE_URLS=http://+:50605
EXPOSE 50605
ENTRYPOINT ["./server"]

# ============================================================================
# Sagas
# ============================================================================
FROM runtime AS saga-fulfillment
COPY --from=build-saga-fulfillment --chown=nonroot:nonroot /out/SagaFulfillment ./server
ENV PORT=50610 ASPNETCORE_URLS=http://+:50610
EXPOSE 50610
ENTRYPOINT ["./server"]

FROM runtime AS saga-loyalty-earn
COPY --from=build-saga-loyalty-earn --chown=nonroot:nonroot /out/SagaLoyaltyEarn ./server
ENV PORT=50611 ASPNETCORE_URLS=http://+:50611
EXPOSE 50611
ENTRYPOINT ["./server"]

FROM runtime AS saga-cancellation
COPY --from=build-saga-cancellation --chown=nonroot:nonroot /out/SagaCancellation ./server
ENV PORT=50612 ASPNETCORE_URLS=http://+:50612
EXPOSE 50612
ENTRYPOINT ["./server"]

# ============================================================================
# Projectors
# ============================================================================
FROM runtime AS projector-receipt
COPY --from=build-projector-receipt --chown=nonroot:nonroot /out/ProjectorReceipt ./server
ENV PORT=50620 ASPNETCORE_URLS=http://+:50620
EXPOSE 50620
ENTRYPOINT ["./server"]
