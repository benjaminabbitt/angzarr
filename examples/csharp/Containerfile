# syntax=docker/dockerfile:1.4
# C# examples - multi-stage build
# Build: podman build -t cs-customer --target customer -f examples/csharp/Containerfile .
# Context must be repo root for proto access
# Cache mounts persist NuGet packages across builds

# ============================================================================
# Builder stage - compiles .NET projects
# ============================================================================
FROM mcr.microsoft.com/dotnet/sdk:8.0-alpine AS builder

WORKDIR /app

# Copy proto files from repo root
COPY proto/ /app/proto/

# ============================================================================
# Build each service with NuGet cache mounts
# ============================================================================
FROM builder AS build-customer
COPY examples/csharp/Customer/Customer.csproj ./
RUN --mount=type=cache,target=/root/.nuget/packages \
    dotnet restore
COPY examples/csharp/Customer/ ./
RUN --mount=type=cache,target=/root/.nuget/packages \
    dotnet publish -c Release -o /out --no-restore

FROM builder AS build-transaction
COPY examples/csharp/Transaction/Transaction.csproj ./
RUN --mount=type=cache,target=/root/.nuget/packages \
    dotnet restore
COPY examples/csharp/Transaction/ ./
RUN --mount=type=cache,target=/root/.nuget/packages \
    dotnet publish -c Release -o /out --no-restore

FROM builder AS build-saga-loyalty
COPY examples/csharp/SagaLoyalty/SagaLoyalty.csproj ./
RUN --mount=type=cache,target=/root/.nuget/packages \
    dotnet restore
COPY examples/csharp/SagaLoyalty/ ./
RUN --mount=type=cache,target=/root/.nuget/packages \
    dotnet publish -c Release -o /out --no-restore

FROM builder AS build-projector-receipt
COPY examples/csharp/ProjectorReceipt/ProjectorReceipt.csproj ./
RUN --mount=type=cache,target=/root/.nuget/packages \
    dotnet restore
COPY examples/csharp/ProjectorReceipt/ ./
RUN --mount=type=cache,target=/root/.nuget/packages \
    dotnet publish -c Release -o /out --no-restore

FROM builder AS build-projector-log-customer
COPY examples/csharp/ProjectorLogCustomer/ProjectorLogCustomer.csproj ./
RUN --mount=type=cache,target=/root/.nuget/packages \
    dotnet restore
COPY examples/csharp/ProjectorLogCustomer/ ./
RUN --mount=type=cache,target=/root/.nuget/packages \
    dotnet publish -c Release -o /out --no-restore

FROM builder AS build-projector-log-transaction
COPY examples/csharp/ProjectorLogTransaction/ProjectorLogTransaction.csproj ./
RUN --mount=type=cache,target=/root/.nuget/packages \
    dotnet restore
COPY examples/csharp/ProjectorLogTransaction/ ./
RUN --mount=type=cache,target=/root/.nuget/packages \
    dotnet publish -c Release -o /out --no-restore

# ============================================================================
# Runtime base
# ============================================================================
FROM mcr.microsoft.com/dotnet/aspnet:8.0-alpine AS runtime
RUN apk --no-cache add ca-certificates
WORKDIR /app

# ============================================================================
# Service-specific images
# ============================================================================
FROM runtime AS customer
COPY --from=build-customer /out ./
ENV PORT=50600
ENV ASPNETCORE_URLS=http://+:50600
EXPOSE 50600
CMD ["dotnet", "Customer.dll"]

FROM runtime AS transaction
COPY --from=build-transaction /out ./
ENV PORT=50601
ENV ASPNETCORE_URLS=http://+:50601
EXPOSE 50601
CMD ["dotnet", "Transaction.dll"]

FROM runtime AS saga-loyalty
COPY --from=build-saga-loyalty /out ./
ENV PORT=50602
ENV ASPNETCORE_URLS=http://+:50602
EXPOSE 50602
CMD ["dotnet", "SagaLoyalty.dll"]

FROM runtime AS projector-receipt
COPY --from=build-projector-receipt /out ./
ENV PORT=50603
ENV ASPNETCORE_URLS=http://+:50603
EXPOSE 50603
CMD ["dotnet", "ProjectorReceipt.dll"]

FROM runtime AS projector-log-customer
COPY --from=build-projector-log-customer /out ./
ENV PORT=50604
ENV ASPNETCORE_URLS=http://+:50604
EXPOSE 50604
CMD ["dotnet", "ProjectorLogCustomer.dll"]

FROM runtime AS projector-log-transaction
COPY --from=build-projector-log-transaction /out ./
ENV PORT=50605
ENV ASPNETCORE_URLS=http://+:50605
EXPOSE 50605
CMD ["dotnet", "ProjectorLogTransaction.dll"]
