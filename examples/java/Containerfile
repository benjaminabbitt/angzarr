# syntax=docker/dockerfile:1.4
# Java examples - multi-stage build with Maven
# Build: podman build -t java-customer --target customer -f examples/java/Containerfile .
# Context must be repo root for proto access
# Cache mounts persist Maven repository across builds

# ============================================================================
# Builder stage - compiles Java projects with Maven
# ============================================================================
FROM docker.io/library/maven:3.9-eclipse-temurin-21-alpine AS builder

WORKDIR /app

# Copy proto files from repo root
COPY proto/ /app/proto/

# ============================================================================
# Build each service with Maven cache mounts
# ============================================================================
FROM builder AS build-customer
COPY examples/java/customer/pom.xml ./customer/
WORKDIR /app/customer
RUN --mount=type=cache,target=/root/.m2 \
    mvn dependency:go-offline -q || true
COPY examples/java/customer/src/ ./src/
RUN --mount=type=cache,target=/root/.m2 \
    mvn package -DskipTests -q

FROM builder AS build-transaction
COPY examples/java/transaction/pom.xml ./transaction/
WORKDIR /app/transaction
RUN --mount=type=cache,target=/root/.m2 \
    mvn dependency:go-offline -q || true
COPY examples/java/transaction/src/ ./src/
RUN --mount=type=cache,target=/root/.m2 \
    mvn package -DskipTests -q

FROM builder AS build-saga-loyalty
COPY examples/java/saga-loyalty/pom.xml ./saga-loyalty/
WORKDIR /app/saga-loyalty
RUN --mount=type=cache,target=/root/.m2 \
    mvn dependency:go-offline -q || true
COPY examples/java/saga-loyalty/src/ ./src/
RUN --mount=type=cache,target=/root/.m2 \
    mvn package -DskipTests -q

FROM builder AS build-projector-receipt
COPY examples/java/projector-receipt/pom.xml ./projector-receipt/
WORKDIR /app/projector-receipt
RUN --mount=type=cache,target=/root/.m2 \
    mvn dependency:go-offline -q || true
COPY examples/java/projector-receipt/src/ ./src/
RUN --mount=type=cache,target=/root/.m2 \
    mvn package -DskipTests -q

FROM builder AS build-projector-log-customer
COPY examples/java/projector-log-customer/pom.xml ./projector-log-customer/
WORKDIR /app/projector-log-customer
RUN --mount=type=cache,target=/root/.m2 \
    mvn dependency:go-offline -q || true
COPY examples/java/projector-log-customer/src/ ./src/
RUN --mount=type=cache,target=/root/.m2 \
    mvn package -DskipTests -q

FROM builder AS build-projector-log-transaction
COPY examples/java/projector-log-transaction/pom.xml ./projector-log-transaction/
WORKDIR /app/projector-log-transaction
RUN --mount=type=cache,target=/root/.m2 \
    mvn dependency:go-offline -q || true
COPY examples/java/projector-log-transaction/src/ ./src/
RUN --mount=type=cache,target=/root/.m2 \
    mvn package -DskipTests -q

# ============================================================================
# Runtime base
# ============================================================================
FROM docker.io/library/eclipse-temurin:21-jre-alpine AS runtime
RUN apk --no-cache add ca-certificates
WORKDIR /app

# ============================================================================
# Service-specific images
# ============================================================================
FROM runtime AS customer
COPY --from=build-customer /app/customer/target/customer-*.jar ./server.jar
ENV PORT=50700
EXPOSE 50700
CMD ["java", "-jar", "server.jar"]

FROM runtime AS transaction
COPY --from=build-transaction /app/transaction/target/transaction-*.jar ./server.jar
ENV PORT=50701
EXPOSE 50701
CMD ["java", "-jar", "server.jar"]

FROM runtime AS saga-loyalty
COPY --from=build-saga-loyalty /app/saga-loyalty/target/saga-loyalty-*.jar ./server.jar
ENV PORT=50702
EXPOSE 50702
CMD ["java", "-jar", "server.jar"]

FROM runtime AS projector-receipt
COPY --from=build-projector-receipt /app/projector-receipt/target/projector-receipt-*.jar ./server.jar
ENV PORT=50703
EXPOSE 50703
CMD ["java", "-jar", "server.jar"]

FROM runtime AS projector-log-customer
COPY --from=build-projector-log-customer /app/projector-log-customer/target/projector-log-customer-*.jar ./server.jar
ENV PORT=50704
EXPOSE 50704
CMD ["java", "-jar", "server.jar"]

FROM runtime AS projector-log-transaction
COPY --from=build-projector-log-transaction /app/projector-log-transaction/target/projector-log-transaction-*.jar ./server.jar
ENV PORT=50705
EXPOSE 50705
CMD ["java", "-jar", "server.jar"]
