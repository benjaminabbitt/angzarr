# syntax=docker/dockerfile:1.4
# Java examples - optimized multi-stage build with jlink minimal JRE
# Build: podman build -t java-customer --target customer -f examples/java/Containerfile .
# Multi-arch: podman build --platform linux/amd64,linux/arm64 ...
# Context must be repo root for proto access
#
# Optimizations:
# 1. Shared deps-fetcher stage (all pom.xml deps resolved together)
# 2. jlink for minimal custom JRE (~40MB vs ~200MB full JRE)
# 3. Named cache IDs for Maven persistence
# 4. Distroless runtime
# 5. Multi-arch support (amd64 + arm64)

ARG JAVA_VERSION=21

# ============================================================================
# Base builder - common SDK
# ============================================================================
FROM docker.io/library/maven:3.9-eclipse-temurin-${JAVA_VERSION}-alpine AS builder

WORKDIR /app

# Copy proto files from repo root
COPY proto/ /app/proto/

# ============================================================================
# Deps fetcher - resolves ALL project dependencies once
# ============================================================================
FROM builder AS deps-fetcher

# Copy all pom.xml files for dependency resolution
COPY examples/java/customer/pom.xml /deps/customer/pom.xml
COPY examples/java/product/pom.xml /deps/product/pom.xml
COPY examples/java/cart/pom.xml /deps/cart/pom.xml
COPY examples/java/order/pom.xml /deps/order/pom.xml
COPY examples/java/inventory/pom.xml /deps/inventory/pom.xml
COPY examples/java/fulfillment/pom.xml /deps/fulfillment/pom.xml
COPY examples/java/saga-fulfillment/pom.xml /deps/saga-fulfillment/pom.xml
COPY examples/java/saga-loyalty-earn/pom.xml /deps/saga-loyalty-earn/pom.xml
COPY examples/java/saga-cancellation/pom.xml /deps/saga-cancellation/pom.xml
COPY examples/java/projector-receipt/pom.xml /deps/projector-receipt/pom.xml

# Resolve all dependencies in one layer with persistent cache
RUN --mount=type=cache,id=maven-cache,target=/root/.m2,sharing=locked \
    for pom in /deps/*/pom.xml; do \
        mvn -f "$pom" dependency:go-offline -q || true; \
    done

# ============================================================================
# Create minimal JRE with jlink
# ============================================================================
FROM builder AS jlink

# Determine required modules for gRPC service
RUN jlink \
    --add-modules java.base,java.logging,java.naming,java.net.http,java.security.jgss,java.sql,jdk.unsupported \
    --strip-debug \
    --no-header-files \
    --no-man-pages \
    --compress=2 \
    --output /jre-minimal

# ============================================================================
# Service builds - each builds a fat JAR
# ============================================================================
FROM deps-fetcher AS build-customer
WORKDIR /build
COPY examples/java/customer/ ./
RUN --mount=type=cache,id=maven-cache,target=/root/.m2,sharing=locked \
    mvn package -DskipTests -q

FROM deps-fetcher AS build-product
WORKDIR /build
COPY examples/java/product/ ./
RUN --mount=type=cache,id=maven-cache,target=/root/.m2,sharing=locked \
    mvn package -DskipTests -q

FROM deps-fetcher AS build-cart
WORKDIR /build
COPY examples/java/cart/ ./
RUN --mount=type=cache,id=maven-cache,target=/root/.m2,sharing=locked \
    mvn package -DskipTests -q

FROM deps-fetcher AS build-order
WORKDIR /build
COPY examples/java/order/ ./
RUN --mount=type=cache,id=maven-cache,target=/root/.m2,sharing=locked \
    mvn package -DskipTests -q

FROM deps-fetcher AS build-inventory
WORKDIR /build
COPY examples/java/inventory/ ./
RUN --mount=type=cache,id=maven-cache,target=/root/.m2,sharing=locked \
    mvn package -DskipTests -q

FROM deps-fetcher AS build-fulfillment
WORKDIR /build
COPY examples/java/fulfillment/ ./
RUN --mount=type=cache,id=maven-cache,target=/root/.m2,sharing=locked \
    mvn package -DskipTests -q

FROM deps-fetcher AS build-saga-fulfillment
WORKDIR /build
COPY examples/java/saga-fulfillment/ ./
RUN --mount=type=cache,id=maven-cache,target=/root/.m2,sharing=locked \
    mvn package -DskipTests -q

FROM deps-fetcher AS build-saga-loyalty-earn
WORKDIR /build
COPY examples/java/saga-loyalty-earn/ ./
RUN --mount=type=cache,id=maven-cache,target=/root/.m2,sharing=locked \
    mvn package -DskipTests -q

FROM deps-fetcher AS build-saga-cancellation
WORKDIR /build
COPY examples/java/saga-cancellation/ ./
RUN --mount=type=cache,id=maven-cache,target=/root/.m2,sharing=locked \
    mvn package -DskipTests -q

FROM deps-fetcher AS build-projector-receipt
WORKDIR /build
COPY examples/java/projector-receipt/ ./
RUN --mount=type=cache,id=maven-cache,target=/root/.m2,sharing=locked \
    mvn package -DskipTests -q

# ============================================================================
# Runtime base - distroless with custom minimal JRE
# ============================================================================
FROM gcr.io/distroless/base-debian12:nonroot AS runtime
COPY --from=jlink /jre-minimal /jre
ENV PATH="/jre/bin:$PATH"
WORKDIR /app
USER nonroot:nonroot

# ============================================================================
# Domain Aggregates
# ============================================================================
FROM runtime AS customer
COPY --from=build-customer --chown=nonroot:nonroot /build/target/customer-*.jar ./server.jar
ENV PORT=50700
EXPOSE 50700
ENTRYPOINT ["java", "-jar", "server.jar"]

FROM runtime AS product
COPY --from=build-product --chown=nonroot:nonroot /build/target/product-*.jar ./server.jar
ENV PORT=50701
EXPOSE 50701
ENTRYPOINT ["java", "-jar", "server.jar"]

FROM runtime AS cart
COPY --from=build-cart --chown=nonroot:nonroot /build/target/cart-*.jar ./server.jar
ENV PORT=50702
EXPOSE 50702
ENTRYPOINT ["java", "-jar", "server.jar"]

FROM runtime AS order
COPY --from=build-order --chown=nonroot:nonroot /build/target/order-*.jar ./server.jar
ENV PORT=50703
EXPOSE 50703
ENTRYPOINT ["java", "-jar", "server.jar"]

FROM runtime AS inventory
COPY --from=build-inventory --chown=nonroot:nonroot /build/target/inventory-*.jar ./server.jar
ENV PORT=50704
EXPOSE 50704
ENTRYPOINT ["java", "-jar", "server.jar"]

FROM runtime AS fulfillment
COPY --from=build-fulfillment --chown=nonroot:nonroot /build/target/fulfillment-*.jar ./server.jar
ENV PORT=50705
EXPOSE 50705
ENTRYPOINT ["java", "-jar", "server.jar"]

# ============================================================================
# Sagas
# ============================================================================
FROM runtime AS saga-fulfillment
COPY --from=build-saga-fulfillment --chown=nonroot:nonroot /build/target/saga-fulfillment-*.jar ./server.jar
ENV PORT=50710
EXPOSE 50710
ENTRYPOINT ["java", "-jar", "server.jar"]

FROM runtime AS saga-loyalty-earn
COPY --from=build-saga-loyalty-earn --chown=nonroot:nonroot /build/target/saga-loyalty-earn-*.jar ./server.jar
ENV PORT=50711
EXPOSE 50711
ENTRYPOINT ["java", "-jar", "server.jar"]

FROM runtime AS saga-cancellation
COPY --from=build-saga-cancellation --chown=nonroot:nonroot /build/target/saga-cancellation-*.jar ./server.jar
ENV PORT=50712
EXPOSE 50712
ENTRYPOINT ["java", "-jar", "server.jar"]

# ============================================================================
# Projectors
# ============================================================================
FROM runtime AS projector-receipt
COPY --from=build-projector-receipt --chown=nonroot:nonroot /build/target/projector-receipt-*.jar ./server.jar
ENV PORT=50720
EXPOSE 50720
ENTRYPOINT ["java", "-jar", "server.jar"]
