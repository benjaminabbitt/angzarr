# Java examples
# Container: podman build -t angzarr-dev-java -f examples/java/Containerfile.dev .
# Run:       podman run --rm -v .:/app:Z -w /app/examples/java angzarr-dev-java just test

set shell := ["bash", "-c"]

TOP := `git rev-parse --show-toplevel`

# Show available commands
default:
    @just --list

# Build dev container
container-build:
    cd {{TOP}} && podman build -t angzarr-dev-java -f examples/java/Containerfile.dev .

# Run tests in container
container-test:
    cd {{TOP}} && podman run --rm -v .:/app:Z -w /app/examples/java angzarr-dev-java just test

# Build all Java examples
build:
    cd customer && mvn compile -q
    cd transaction && mvn compile -q
    cd saga-loyalty && mvn compile -q
    cd projector-receipt && mvn compile -q
    cd projector-log-customer && mvn compile -q
    cd projector-log-transaction && mvn compile -q

# Test all Java examples (unit tests)
test:
    cd customer && mvn test
    cd transaction && mvn test
    cd saga-loyalty && mvn test
    cd projector-receipt && mvn test
    cd projector-log-customer && mvn test
    cd projector-log-transaction && mvn test

# Run integration tests (requires running angzarr system)
integration-test:
    cd integration-tests && mvn test

# Clean all Java examples
clean:
    cd customer && mvn clean -q || true
    cd transaction && mvn clean -q || true
    cd saga-loyalty && mvn clean -q || true
    cd projector-receipt && mvn clean -q || true
    cd projector-log-customer && mvn clean -q || true
    cd projector-log-transaction && mvn clean -q || true
    cd integration-tests && mvn clean -q || true

# Format all Java code
fmt:
    cd customer && mvn spotless:apply || echo "Spotless not configured"
    cd transaction && mvn spotless:apply || echo "Spotless not configured"
    cd saga-loyalty && mvn spotless:apply || echo "Spotless not configured"
    cd projector-receipt && mvn spotless:apply || echo "Spotless not configured"
    cd projector-log-customer && mvn spotless:apply || echo "Spotless not configured"
    cd projector-log-transaction && mvn spotless:apply || echo "Spotless not configured"

# Lint all Java code
lint:
    cd customer && mvn spotless:check || true
    cd transaction && mvn spotless:check || true
    cd saga-loyalty && mvn spotless:check || true
    cd projector-receipt && mvn spotless:check || true
    cd projector-log-customer && mvn spotless:check || true
    cd projector-log-transaction && mvn spotless:check || true

# Package all services as JAR files
package:
    cd customer && mvn package -DskipTests -q
    cd transaction && mvn package -DskipTests -q
    cd saga-loyalty && mvn package -DskipTests -q
    cd projector-receipt && mvn package -DskipTests -q
    cd projector-log-customer && mvn package -DskipTests -q
    cd projector-log-transaction && mvn package -DskipTests -q

# Lint Helm chart
helm-lint:
    helm lint helm
