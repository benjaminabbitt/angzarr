# Go dev container for running tests
# Build: podman build -t angzarr-dev-go -f examples/go/Containerfile.dev .
# Run:   podman run --rm -v .:/app:Z -w /app/examples/go angzarr-dev-go just test
#
# Proto bindings are pre-installed at /app/generated/go/

FROM docker.io/library/golang:1.23-alpine

RUN apk add --no-cache git curl bash

# Install just
RUN curl -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin

WORKDIR /app

# Copy generated proto files
COPY generated/go /app/generated/go

# Set up proto symlinks script (use sh for Alpine)
RUN printf '#!/bin/sh\n\
for dir in customer product cart order inventory fulfillment projector-receipt saga-loyalty-earn saga-fulfillment saga-cancellation; do\n\
  mkdir -p /app/examples/go/$dir/proto/angzarr /app/examples/go/$dir/proto/examples\n\
  cp -r /app/generated/go/angzarr/* /app/examples/go/$dir/proto/angzarr/ 2>/dev/null || true\n\
  cp -r /app/generated/go/examples/* /app/examples/go/$dir/proto/examples/ 2>/dev/null || true\n\
done\n\
exec "$@"\n' > /usr/local/bin/setup-protos.sh && chmod +x /usr/local/bin/setup-protos.sh

WORKDIR /app/examples/go

ENTRYPOINT ["/usr/local/bin/setup-protos.sh"]
CMD ["just", "test"]
