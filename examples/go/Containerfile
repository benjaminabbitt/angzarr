# syntax=docker/dockerfile:1.4
# Go examples - multi-stage build with cache mounts
# Build: podman build -t go-customer --target customer -f examples/go/Containerfile .
# Context must be repo root for proto/generated access
# Cache mounts persist go modules and build cache across builds

# ============================================================================
# Builder stage - compiles Go binaries
# ============================================================================
FROM docker.io/library/golang:1.23-alpine AS builder

RUN apk add --no-cache git protobuf-dev

WORKDIR /app

# Copy proto and generated files from repo root
COPY proto proto/
COPY generated generated/

# ============================================================================
# Build each service with shared cache mounts
# ============================================================================
FROM builder AS build-customer
WORKDIR /app/service
COPY examples/go/customer/go.mod examples/go/customer/go.sum ./
RUN --mount=type=cache,target=/go/pkg/mod \
    go mod download
COPY examples/go/customer/ ./
RUN --mount=type=cache,target=/go/pkg/mod \
    --mount=type=cache,target=/root/.cache/go-build \
    CGO_ENABLED=0 GOOS=linux go build -installsuffix cgo -o /server .

FROM builder AS build-transaction
WORKDIR /app/service
COPY examples/go/transaction/go.mod examples/go/transaction/go.sum ./
RUN --mount=type=cache,target=/go/pkg/mod \
    go mod download
COPY examples/go/transaction/ ./
RUN --mount=type=cache,target=/go/pkg/mod \
    --mount=type=cache,target=/root/.cache/go-build \
    CGO_ENABLED=0 GOOS=linux go build -installsuffix cgo -o /server .

FROM builder AS build-saga-loyalty
WORKDIR /app/service
COPY examples/go/saga-loyalty/go.mod examples/go/saga-loyalty/go.sum ./
RUN --mount=type=cache,target=/go/pkg/mod \
    go mod download
COPY examples/go/saga-loyalty/ ./
RUN --mount=type=cache,target=/go/pkg/mod \
    --mount=type=cache,target=/root/.cache/go-build \
    CGO_ENABLED=0 GOOS=linux go build -installsuffix cgo -o /server .

FROM builder AS build-projector-receipt
WORKDIR /app/service
COPY examples/go/projector-receipt/go.mod examples/go/projector-receipt/go.sum ./
RUN --mount=type=cache,target=/go/pkg/mod \
    go mod download
COPY examples/go/projector-receipt/ ./
RUN --mount=type=cache,target=/go/pkg/mod \
    --mount=type=cache,target=/root/.cache/go-build \
    CGO_ENABLED=0 GOOS=linux go build -installsuffix cgo -o /server .

FROM builder AS build-projector-log-customer
WORKDIR /app/service
COPY examples/go/projector-log-customer/go.mod examples/go/projector-log-customer/go.sum ./
RUN --mount=type=cache,target=/go/pkg/mod \
    go mod download
COPY examples/go/projector-log-customer/ ./
RUN --mount=type=cache,target=/go/pkg/mod \
    --mount=type=cache,target=/root/.cache/go-build \
    CGO_ENABLED=0 GOOS=linux go build -installsuffix cgo -o /server .

FROM builder AS build-projector-log-transaction
WORKDIR /app/service
COPY examples/go/projector-log-transaction/go.mod examples/go/projector-log-transaction/go.sum ./
RUN --mount=type=cache,target=/go/pkg/mod \
    go mod download
COPY examples/go/projector-log-transaction/ ./
RUN --mount=type=cache,target=/go/pkg/mod \
    --mount=type=cache,target=/root/.cache/go-build \
    CGO_ENABLED=0 GOOS=linux go build -installsuffix cgo -o /server .

# ============================================================================
# Runtime base
# ============================================================================
FROM gcr.io/distroless/static-debian12:nonroot AS runtime
WORKDIR /app
USER nonroot:nonroot

# ============================================================================
# Service-specific images
# ============================================================================
FROM runtime AS customer
COPY --from=build-customer /server ./server
ENV PORT=50200
EXPOSE 50200
ENTRYPOINT ["./server"]

FROM runtime AS transaction
COPY --from=build-transaction /server ./server
ENV PORT=50201
EXPOSE 50201
ENTRYPOINT ["./server"]

FROM runtime AS saga-loyalty
COPY --from=build-saga-loyalty /server ./server
ENV PORT=50202
EXPOSE 50202
ENTRYPOINT ["./server"]

FROM runtime AS projector-receipt
COPY --from=build-projector-receipt /server ./server
ENV PORT=50203
EXPOSE 50203
ENTRYPOINT ["./server"]

FROM runtime AS projector-log-customer
COPY --from=build-projector-log-customer /server ./server
ENV PORT=50204
EXPOSE 50204
ENTRYPOINT ["./server"]

FROM runtime AS projector-log-transaction
COPY --from=build-projector-log-transaction /server ./server
ENV PORT=50205
EXPOSE 50205
ENTRYPOINT ["./server"]
