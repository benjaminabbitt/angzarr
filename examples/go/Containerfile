# syntax=docker/dockerfile:1.4
# Go poker examples - optimized multi-stage build
# Build: podman build -t go-poker-player --target agg-player -f examples/go/Containerfile .
# Multi-arch: podman build --platform linux/amd64,linux/arm64 ...
# Context must be repo root for proto access
#
# Optimizations:
# 1. Shared deps-fetcher stage - go mod download runs once
# 2. Named cache IDs for Go module cache persistence
# 3. Distroless runtime - minimal attack surface
# 4. Multi-arch support (amd64 + arm64)

ARG GO_VERSION=1.23

# ============================================================================
# Base builder - common SDK
# ============================================================================
FROM docker.io/library/golang:${GO_VERSION}-alpine AS base

RUN apk add --no-cache ca-certificates git

WORKDIR /app

# ============================================================================
# Deps fetcher - downloads ALL dependencies once
# ============================================================================
FROM base AS deps-fetcher

# Copy go.mod/go.sum for dependency resolution
COPY examples/go/go.mod examples/go/go.sum ./

# Download dependencies with persistent cache
RUN --mount=type=cache,id=go-mod-cache,target=/go/pkg/mod,sharing=locked \
    go mod download

# ============================================================================
# Service builds - each builds a static binary
# ============================================================================
FROM deps-fetcher AS build-player
WORKDIR /build
COPY examples/go/ ./
RUN --mount=type=cache,id=go-mod-cache,target=/go/pkg/mod,sharing=locked \
    --mount=type=cache,id=go-build-cache,target=/root/.cache/go-build,sharing=locked \
    CGO_ENABLED=0 go build -ldflags="-s -w" -o /out/server ./agg-player

FROM deps-fetcher AS build-table
WORKDIR /build
COPY examples/go/ ./
RUN --mount=type=cache,id=go-mod-cache,target=/go/pkg/mod,sharing=locked \
    --mount=type=cache,id=go-build-cache,target=/root/.cache/go-build,sharing=locked \
    CGO_ENABLED=0 go build -ldflags="-s -w" -o /out/server ./agg-table

FROM deps-fetcher AS build-hand
WORKDIR /build
COPY examples/go/ ./
RUN --mount=type=cache,id=go-mod-cache,target=/go/pkg/mod,sharing=locked \
    --mount=type=cache,id=go-build-cache,target=/root/.cache/go-build,sharing=locked \
    CGO_ENABLED=0 go build -ldflags="-s -w" -o /out/server ./agg-hand

# ============================================================================
# Runtime base - distroless static (minimal, secure)
# ============================================================================
FROM gcr.io/distroless/static-debian12:nonroot AS runtime
WORKDIR /app
USER nonroot:nonroot

# ============================================================================
# Domain Aggregates
# ============================================================================
FROM runtime AS agg-player
COPY --from=build-player --chown=nonroot:nonroot /out/server ./server
ENV PORT=50201
EXPOSE 50201
ENTRYPOINT ["./server"]

FROM runtime AS agg-table
COPY --from=build-table --chown=nonroot:nonroot /out/server ./server
ENV PORT=50202
EXPOSE 50202
ENTRYPOINT ["./server"]

FROM runtime AS agg-hand
COPY --from=build-hand --chown=nonroot:nonroot /out/server ./server
ENV PORT=50203
EXPOSE 50203
ENTRYPOINT ["./server"]
