# syntax=docker/dockerfile:1.4
# TypeScript examples - optimized multi-stage build with esbuild bundling
# Build: podman build -t ts-customer --target customer -f examples/typescript/Containerfile .
# Multi-arch: podman build --platform linux/amd64,linux/arm64 ...
# Context must be repo root for proto access
#
# Optimizations:
# 1. Shared deps-fetcher stage - all package.json installed once
# 2. esbuild bundling - single-file output eliminates node_modules at runtime
# 3. Distroless runtime - minimal attack surface (~35MB vs ~180MB)
# 4. Named cache IDs for npm persistence
# 5. Multi-arch support (amd64 + arm64)

ARG NODE_VERSION=22

# ============================================================================
# Base builder - common tooling
# ============================================================================
FROM docker.io/library/node:${NODE_VERSION}-alpine AS base

RUN npm install -g esbuild

WORKDIR /app

# ============================================================================
# Proto files layer (changes occasionally)
# ============================================================================
FROM base AS with-protos

# Copy proto files from examples/typescript/proto
COPY examples/typescript/proto proto/

# ============================================================================
# Common library build (shared by all services)
# ============================================================================
FROM with-protos AS build-common

WORKDIR /app/common
COPY examples/typescript/common/package*.json ./
RUN --mount=type=cache,id=npm-cache,target=/root/.npm,sharing=locked \
    npm ci
COPY examples/typescript/common/ ./
RUN npm run build

# ============================================================================
# Deps fetcher - downloads ALL service dependencies once
# This is the key caching optimization - shared across all services
# ============================================================================
FROM with-protos AS deps-fetcher

# Copy all package.json files for dependency resolution
COPY examples/typescript/customer/package*.json /deps/customer/
COPY examples/typescript/product/package*.json /deps/product/
COPY examples/typescript/cart/package*.json /deps/cart/
COPY examples/typescript/order/package*.json /deps/order/
COPY examples/typescript/inventory/package*.json /deps/inventory/
COPY examples/typescript/fulfillment/package*.json /deps/fulfillment/
COPY examples/typescript/saga-fulfillment/package*.json /deps/saga-fulfillment/
COPY examples/typescript/saga-loyalty-earn/package*.json /deps/saga-loyalty-earn/
COPY examples/typescript/saga-cancellation/package*.json /deps/saga-cancellation/
COPY examples/typescript/projector-receipt/package*.json /deps/projector-receipt/

# Install all dependencies in one layer with persistent cache
RUN --mount=type=cache,id=npm-cache,target=/root/.npm,sharing=locked \
    for dir in /deps/*/; do \
        cd "$dir" && npm ci --omit=dev 2>/dev/null || npm ci; \
    done

# ============================================================================
# Service builds - each bundles to single file with esbuild
# ============================================================================
FROM deps-fetcher AS build-customer
WORKDIR /build
COPY --from=build-common /app/common/dist /app/common/dist
COPY --from=build-common /app/common/package.json /app/common/
COPY examples/typescript/customer/ ./
RUN cp -r /deps/customer/node_modules . 2>/dev/null || true && \
    esbuild src/server.ts --bundle --platform=node --target=node${NODE_VERSION} \
    --outfile=dist/server.js --external:@grpc/grpc-js --format=esm

FROM deps-fetcher AS build-product
WORKDIR /build
COPY --from=build-common /app/common/dist /app/common/dist
COPY --from=build-common /app/common/package.json /app/common/
COPY examples/typescript/product/ ./
RUN cp -r /deps/product/node_modules . 2>/dev/null || true && \
    esbuild src/server.ts --bundle --platform=node --target=node${NODE_VERSION} \
    --outfile=dist/server.js --external:@grpc/grpc-js --format=esm

FROM deps-fetcher AS build-cart
WORKDIR /build
COPY --from=build-common /app/common/dist /app/common/dist
COPY --from=build-common /app/common/package.json /app/common/
COPY examples/typescript/cart/ ./
RUN cp -r /deps/cart/node_modules . 2>/dev/null || true && \
    esbuild src/server.ts --bundle --platform=node --target=node${NODE_VERSION} \
    --outfile=dist/server.js --external:@grpc/grpc-js --format=esm

FROM deps-fetcher AS build-order
WORKDIR /build
COPY --from=build-common /app/common/dist /app/common/dist
COPY --from=build-common /app/common/package.json /app/common/
COPY examples/typescript/order/ ./
RUN cp -r /deps/order/node_modules . 2>/dev/null || true && \
    esbuild src/server.ts --bundle --platform=node --target=node${NODE_VERSION} \
    --outfile=dist/server.js --external:@grpc/grpc-js --format=esm

FROM deps-fetcher AS build-inventory
WORKDIR /build
COPY --from=build-common /app/common/dist /app/common/dist
COPY --from=build-common /app/common/package.json /app/common/
COPY examples/typescript/inventory/ ./
RUN cp -r /deps/inventory/node_modules . 2>/dev/null || true && \
    esbuild src/server.ts --bundle --platform=node --target=node${NODE_VERSION} \
    --outfile=dist/server.js --external:@grpc/grpc-js --format=esm

FROM deps-fetcher AS build-fulfillment
WORKDIR /build
COPY --from=build-common /app/common/dist /app/common/dist
COPY --from=build-common /app/common/package.json /app/common/
COPY examples/typescript/fulfillment/ ./
RUN cp -r /deps/fulfillment/node_modules . 2>/dev/null || true && \
    esbuild src/server.ts --bundle --platform=node --target=node${NODE_VERSION} \
    --outfile=dist/server.js --external:@grpc/grpc-js --format=esm

FROM deps-fetcher AS build-saga-fulfillment
WORKDIR /build
COPY --from=build-common /app/common/dist /app/common/dist
COPY --from=build-common /app/common/package.json /app/common/
COPY examples/typescript/saga-fulfillment/ ./
RUN cp -r /deps/saga-fulfillment/node_modules . 2>/dev/null || true && \
    esbuild src/server.ts --bundle --platform=node --target=node${NODE_VERSION} \
    --outfile=dist/server.js --external:@grpc/grpc-js --format=esm

FROM deps-fetcher AS build-saga-loyalty-earn
WORKDIR /build
COPY --from=build-common /app/common/dist /app/common/dist
COPY --from=build-common /app/common/package.json /app/common/
COPY examples/typescript/saga-loyalty-earn/ ./
RUN cp -r /deps/saga-loyalty-earn/node_modules . 2>/dev/null || true && \
    esbuild src/server.ts --bundle --platform=node --target=node${NODE_VERSION} \
    --outfile=dist/server.js --external:@grpc/grpc-js --format=esm

FROM deps-fetcher AS build-saga-cancellation
WORKDIR /build
COPY --from=build-common /app/common/dist /app/common/dist
COPY --from=build-common /app/common/package.json /app/common/
COPY examples/typescript/saga-cancellation/ ./
RUN cp -r /deps/saga-cancellation/node_modules . 2>/dev/null || true && \
    esbuild src/server.ts --bundle --platform=node --target=node${NODE_VERSION} \
    --outfile=dist/server.js --external:@grpc/grpc-js --format=esm

FROM deps-fetcher AS build-projector-receipt
WORKDIR /build
COPY --from=build-common /app/common/dist /app/common/dist
COPY --from=build-common /app/common/package.json /app/common/
COPY examples/typescript/projector-receipt/ ./
RUN cp -r /deps/projector-receipt/node_modules . 2>/dev/null || true && \
    esbuild src/server.ts --bundle --platform=node --target=node${NODE_VERSION} \
    --outfile=dist/server.js --external:@grpc/grpc-js --format=esm

# ============================================================================
# Runtime base - distroless Node.js (minimal, secure)
# ============================================================================
FROM gcr.io/distroless/nodejs22-debian12:nonroot AS runtime
WORKDIR /app
USER nonroot:nonroot

# ============================================================================
# Domain Aggregates
# ============================================================================
FROM runtime AS customer
COPY --from=build-customer --chown=nonroot:nonroot /build/dist/server.js ./
COPY --from=build-customer --chown=nonroot:nonroot /build/node_modules ./node_modules
ENV PORT=50400
EXPOSE 50400
CMD ["server.js"]

FROM runtime AS product
COPY --from=build-product --chown=nonroot:nonroot /build/dist/server.js ./
COPY --from=build-product --chown=nonroot:nonroot /build/node_modules ./node_modules
ENV PORT=50401
EXPOSE 50401
CMD ["server.js"]

FROM runtime AS cart
COPY --from=build-cart --chown=nonroot:nonroot /build/dist/server.js ./
COPY --from=build-cart --chown=nonroot:nonroot /build/node_modules ./node_modules
ENV PORT=50402
EXPOSE 50402
CMD ["server.js"]

FROM runtime AS order
COPY --from=build-order --chown=nonroot:nonroot /build/dist/server.js ./
COPY --from=build-order --chown=nonroot:nonroot /build/node_modules ./node_modules
ENV PORT=50403
EXPOSE 50403
CMD ["server.js"]

FROM runtime AS inventory
COPY --from=build-inventory --chown=nonroot:nonroot /build/dist/server.js ./
COPY --from=build-inventory --chown=nonroot:nonroot /build/node_modules ./node_modules
ENV PORT=50404
EXPOSE 50404
CMD ["server.js"]

FROM runtime AS fulfillment
COPY --from=build-fulfillment --chown=nonroot:nonroot /build/dist/server.js ./
COPY --from=build-fulfillment --chown=nonroot:nonroot /build/node_modules ./node_modules
ENV PORT=50405
EXPOSE 50405
CMD ["server.js"]

# ============================================================================
# Sagas
# ============================================================================
FROM runtime AS saga-fulfillment
COPY --from=build-saga-fulfillment --chown=nonroot:nonroot /build/dist/server.js ./
COPY --from=build-saga-fulfillment --chown=nonroot:nonroot /build/node_modules ./node_modules
ENV PORT=50410
EXPOSE 50410
CMD ["server.js"]

FROM runtime AS saga-loyalty-earn
COPY --from=build-saga-loyalty-earn --chown=nonroot:nonroot /build/dist/server.js ./
COPY --from=build-saga-loyalty-earn --chown=nonroot:nonroot /build/node_modules ./node_modules
ENV PORT=50411
EXPOSE 50411
CMD ["server.js"]

FROM runtime AS saga-cancellation
COPY --from=build-saga-cancellation --chown=nonroot:nonroot /build/dist/server.js ./
COPY --from=build-saga-cancellation --chown=nonroot:nonroot /build/node_modules ./node_modules
ENV PORT=50412
EXPOSE 50412
CMD ["server.js"]

# ============================================================================
# Projectors
# ============================================================================
FROM runtime AS projector-receipt
COPY --from=build-projector-receipt --chown=nonroot:nonroot /build/dist/server.js ./
COPY --from=build-projector-receipt --chown=nonroot:nonroot /build/node_modules ./node_modules
ENV PORT=50420
EXPOSE 50420
CMD ["server.js"]
