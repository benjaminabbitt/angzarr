# syntax=docker/dockerfile:1.4
# TypeScript examples - multi-stage build with Node.js
# Build: podman build -t ts-customer --target customer -f examples/typescript/Containerfile .
# Context must be repo root for generated proto access
# Cache mounts persist npm packages across builds

# ============================================================================
# Builder stage - compiles TypeScript with npm
# ============================================================================
FROM docker.io/library/node:22-alpine AS builder

WORKDIR /app

# Copy generated proto files from repo root
COPY generated/angzarr angzarr/proto/
COPY generated/examples proto/

# ============================================================================
# Build each service with npm cache mounts
# ============================================================================
FROM builder AS build-customer
COPY examples/typescript/customer/package*.json ./
RUN --mount=type=cache,target=/root/.npm \
    npm ci
COPY examples/typescript/customer/ ./
RUN npm run build

FROM builder AS build-transaction
COPY examples/typescript/transaction/package*.json ./
RUN --mount=type=cache,target=/root/.npm \
    npm ci
COPY examples/typescript/transaction/ ./
RUN npm run build

FROM builder AS build-saga-loyalty
COPY examples/typescript/saga-loyalty/package*.json ./
RUN --mount=type=cache,target=/root/.npm \
    npm ci
COPY examples/typescript/saga-loyalty/ ./
RUN npm run build

FROM builder AS build-projector-receipt
COPY examples/typescript/projector-receipt/package*.json ./
RUN --mount=type=cache,target=/root/.npm \
    npm ci
COPY examples/typescript/projector-receipt/ ./
RUN npm run build

FROM builder AS build-projector-log-customer
COPY examples/typescript/projector-log-customer/package*.json ./
RUN --mount=type=cache,target=/root/.npm \
    npm ci
COPY examples/typescript/projector-log-customer/ ./
RUN npm run build

FROM builder AS build-projector-log-transaction
COPY examples/typescript/projector-log-transaction/package*.json ./
RUN --mount=type=cache,target=/root/.npm \
    npm ci
COPY examples/typescript/projector-log-transaction/ ./
RUN npm run build

# ============================================================================
# Runtime base
# ============================================================================
FROM docker.io/library/node:22-alpine AS runtime
WORKDIR /app

# ============================================================================
# Service-specific images
# ============================================================================
FROM runtime AS customer
COPY --from=build-customer /app ./
ENV PORT=50400
EXPOSE 50400
CMD ["node", "dist/server.js"]

FROM runtime AS transaction
COPY --from=build-transaction /app ./
ENV PORT=50401
EXPOSE 50401
CMD ["node", "dist/server.js"]

FROM runtime AS saga-loyalty
COPY --from=build-saga-loyalty /app ./
ENV PORT=50402
EXPOSE 50402
CMD ["node", "dist/server.js"]

FROM runtime AS projector-receipt
COPY --from=build-projector-receipt /app ./
ENV PORT=50403
EXPOSE 50403
CMD ["node", "dist/server.js"]

FROM runtime AS projector-log-customer
COPY --from=build-projector-log-customer /app ./
ENV PORT=50404
EXPOSE 50404
CMD ["node", "dist/server.js"]

FROM runtime AS projector-log-transaction
COPY --from=build-projector-log-transaction /app ./
ENV PORT=50405
EXPOSE 50405
CMD ["node", "dist/server.js"]
