apiVersion: skaffold/v4beta11
kind: Config
metadata:
  name: angzarr-elixir-examples

requires:
  - path: ../../skaffold.yaml
    activeProfiles:
      - name: local

build:
  local:
    push: true
    useBuildkit: false
  artifacts:
    - image: localhost:5001/entity-customer-ex
      context: .
      docker:
        dockerfile: Containerfile
        target: customer

    - image: localhost:5001/entity-product-ex
      context: .
      docker:
        dockerfile: Containerfile
        target: product

    - image: localhost:5001/entity-cart-ex
      context: .
      docker:
        dockerfile: Containerfile
        target: cart

    - image: localhost:5001/entity-order-ex
      context: .
      docker:
        dockerfile: Containerfile
        target: order

    - image: localhost:5001/entity-inventory-ex
      context: .
      docker:
        dockerfile: Containerfile
        target: inventory

    - image: localhost:5001/entity-fulfillment-ex
      context: .
      docker:
        dockerfile: Containerfile
        target: fulfillment

    - image: localhost:5001/saga-fulfillment-ex
      context: .
      docker:
        dockerfile: Containerfile
        target: saga-fulfillment

    - image: localhost:5001/saga-loyalty-earn-ex
      context: .
      docker:
        dockerfile: Containerfile
        target: saga-loyalty-earn

    - image: localhost:5001/saga-cancellation-ex
      context: .
      docker:
        dockerfile: Containerfile
        target: saga-cancellation

    - image: localhost:5001/projector-receipt-ex
      context: .
      docker:
        dockerfile: Containerfile
        target: projector-receipt

deploy:
  helm:
    releases:
      - name: angzarr
        chartPath: ../../deploy/helm/angzarr
        namespace: angzarr
        createNamespace: true
        valuesFiles:
          - ../../deploy/helm/angzarr/values-elixir.yaml
        setValues:
          images.command.repository: localhost:5001/angzarr-entity
          images.command.tag: latest
          images.projector.repository: localhost:5001/angzarr-projector
          images.projector.tag: latest
          images.saga.repository: localhost:5001/angzarr-saga
          images.saga.tag: latest
          images.stream.repository: localhost:5001/angzarr-stream
          images.stream.tag: latest
          images.gateway.repository: localhost:5001/angzarr-gateway
          images.gateway.tag: latest
          applications.business[0].image.repository: localhost:5001/entity-customer-ex
          applications.business[0].image.tag: latest
          applications.business[1].image.repository: localhost:5001/entity-product-ex
          applications.business[1].image.tag: latest
          applications.business[2].image.repository: localhost:5001/entity-cart-ex
          applications.business[2].image.tag: latest
          applications.business[3].image.repository: localhost:5001/entity-order-ex
          applications.business[3].image.tag: latest
          applications.business[4].image.repository: localhost:5001/entity-inventory-ex
          applications.business[4].image.tag: latest
          applications.business[5].image.repository: localhost:5001/entity-fulfillment-ex
          applications.business[5].image.tag: latest
          applications.projectors[0].image.repository: localhost:5001/projector-receipt-ex
          applications.projectors[0].image.tag: latest
          applications.sagas[0].image.repository: localhost:5001/saga-fulfillment-ex
          applications.sagas[0].image.tag: latest
          applications.sagas[1].image.repository: localhost:5001/saga-loyalty-earn-ex
          applications.sagas[1].image.tag: latest
          applications.sagas[2].image.repository: localhost:5001/saga-cancellation-ex
          applications.sagas[2].image.tag: latest

profiles:
  - name: dev
    activation:
      - command: dev
