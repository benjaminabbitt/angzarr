# syntax=docker/dockerfile:1.4
# Ruby examples - multi-stage build with Bundler
# Build: podman build -t rb-customer --target customer -f examples/ruby/Containerfile .
# Context must be repo root for generated proto access
# Cache mounts persist Bundler gems across builds

# ============================================================================
# Builder stage - installs dependencies with Bundler
# ============================================================================
FROM docker.io/library/ruby:3.3-alpine AS builder

RUN apk add --no-cache build-base

WORKDIR /app

# Copy generated proto files from repo root
COPY generated/angzarr angzarr/proto/
COPY generated/examples proto/

# ============================================================================
# Build each service with Bundler cache mounts
# ============================================================================
FROM builder AS build-customer
COPY examples/ruby/customer/Gemfile examples/ruby/customer/Gemfile.lock ./
RUN --mount=type=cache,target=/usr/local/bundle/cache \
    bundle install --deployment --without development test
COPY examples/ruby/customer/*.rb ./

FROM builder AS build-transaction
COPY examples/ruby/transaction/Gemfile examples/ruby/transaction/Gemfile.lock ./
RUN --mount=type=cache,target=/usr/local/bundle/cache \
    bundle install --deployment --without development test
COPY examples/ruby/transaction/*.rb ./

FROM builder AS build-saga-loyalty
COPY examples/ruby/saga-loyalty/Gemfile examples/ruby/saga-loyalty/Gemfile.lock ./
RUN --mount=type=cache,target=/usr/local/bundle/cache \
    bundle install --deployment --without development test
COPY examples/ruby/saga-loyalty/*.rb ./

FROM builder AS build-projector-receipt
COPY examples/ruby/projector-receipt/Gemfile examples/ruby/projector-receipt/Gemfile.lock ./
RUN --mount=type=cache,target=/usr/local/bundle/cache \
    bundle install --deployment --without development test
COPY examples/ruby/projector-receipt/*.rb ./

FROM builder AS build-projector-log-customer
COPY examples/ruby/projector-log-customer/Gemfile examples/ruby/projector-log-customer/Gemfile.lock ./
RUN --mount=type=cache,target=/usr/local/bundle/cache \
    bundle install --deployment --without development test
COPY examples/ruby/projector-log-customer/*.rb ./

FROM builder AS build-projector-log-transaction
COPY examples/ruby/projector-log-transaction/Gemfile examples/ruby/projector-log-transaction/Gemfile.lock ./
RUN --mount=type=cache,target=/usr/local/bundle/cache \
    bundle install --deployment --without development test
COPY examples/ruby/projector-log-transaction/*.rb ./

# ============================================================================
# Runtime base
# ============================================================================
FROM docker.io/library/ruby:3.3-alpine AS runtime
WORKDIR /app

# ============================================================================
# Service-specific images
# ============================================================================
FROM runtime AS customer
COPY --from=build-customer /app ./
ENV PORT=50800
EXPOSE 50800
CMD ["bundle", "exec", "ruby", "server.rb"]

FROM runtime AS transaction
COPY --from=build-transaction /app ./
ENV PORT=50801
EXPOSE 50801
CMD ["bundle", "exec", "ruby", "server.rb"]

FROM runtime AS saga-loyalty
COPY --from=build-saga-loyalty /app ./
ENV PORT=50802
EXPOSE 50802
CMD ["bundle", "exec", "ruby", "server.rb"]

FROM runtime AS projector-receipt
COPY --from=build-projector-receipt /app ./
ENV PORT=50803
EXPOSE 50803
CMD ["bundle", "exec", "ruby", "server.rb"]

FROM runtime AS projector-log-customer
COPY --from=build-projector-log-customer /app ./
ENV PORT=50804
EXPOSE 50804
CMD ["bundle", "exec", "ruby", "server.rb"]

FROM runtime AS projector-log-transaction
COPY --from=build-projector-log-transaction /app ./
ENV PORT=50805
EXPOSE 50805
CMD ["bundle", "exec", "ruby", "server.rb"]
