# Ruby dev container for running tests
# Build: podman build -t angzarr-dev-ruby -f examples/ruby/Containerfile.dev .
# Run:   podman run --rm -v .:/app:Z -w /app/examples/ruby angzarr-dev-ruby just test
#
# Proto bindings are pre-installed at /app/generated/ruby/

FROM ruby:3.3-slim

RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    git \
    curl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Install just
RUN curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin

WORKDIR /app

# Copy generated proto files
COPY generated/ruby /app/generated/ruby

# Pre-install gems for all services (test deps included)
COPY examples/ruby/customer/Gemfile /tmp/customer/Gemfile
COPY examples/ruby/transaction/Gemfile /tmp/transaction/Gemfile
COPY examples/ruby/saga-loyalty/Gemfile /tmp/saga-loyalty/Gemfile
COPY examples/ruby/projector-receipt/Gemfile /tmp/projector-receipt/Gemfile
COPY examples/ruby/projector-log-customer/Gemfile /tmp/projector-log-customer/Gemfile
COPY examples/ruby/projector-log-transaction/Gemfile /tmp/projector-log-transaction/Gemfile

# Install all gems (including test group)
RUN cd /tmp/customer && bundle install \
    && cd /tmp/transaction && bundle install \
    && cd /tmp/saga-loyalty && bundle install \
    && cd /tmp/projector-receipt && bundle install \
    && cd /tmp/projector-log-customer && bundle install \
    && cd /tmp/projector-log-transaction && bundle install \
    && rm -rf /tmp/*

# Set up proto files script (copies to lib/ where Ruby $LOAD_PATH looks)
RUN echo '#!/bin/bash\n\
for dir in customer transaction saga-loyalty projector-receipt projector-log-customer projector-log-transaction; do\n\
  mkdir -p /app/examples/ruby/$dir/lib/angzarr /app/examples/ruby/$dir/lib/examples\n\
  cp /app/generated/ruby/angzarr/*.rb /app/examples/ruby/$dir/lib/angzarr/ 2>/dev/null || true\n\
  cp /app/generated/ruby/examples/*.rb /app/examples/ruby/$dir/lib/examples/ 2>/dev/null || true\n\
done\n\
exec "$@"' > /usr/local/bin/setup-protos.sh && chmod +x /usr/local/bin/setup-protos.sh

WORKDIR /app/examples/ruby

ENTRYPOINT ["/usr/local/bin/setup-protos.sh"]
CMD ["just", "test"]
