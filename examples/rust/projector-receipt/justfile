# Receipt Projector - Rust gRPC Server

set shell := ["bash", "-c"]

TOP := `git rev-parse --show-toplevel`

# Show available commands
default:
    @just --list

# Build the server
build:
    cargo build -p projector-receipt --bin projector-receipt-server

# Build release
build-release:
    cargo build -p projector-receipt --bin projector-receipt-server --release

# Run the server
run: build
    cargo run -p projector-receipt --bin projector-receipt-server

# Run with custom port
run-port port:
    PORT={{port}} cargo run -p projector-receipt --bin projector-receipt-server

# Copy feature files from shared location
copy-features:
    rm -rf tests/features
    cp -r {{TOP}}/examples/features tests/

# Run unit tests (no infrastructure required)
unit:
    cargo test -p projector-receipt --lib

# Run acceptance tests (requires Kind cluster)
acceptance: copy-features
    cargo test -p projector-receipt --test acceptance

# Run all tests (unit + acceptance)
test: unit acceptance

# Run unit tests only (alias for CI without cluster)
test-unit: unit

# Clean build artifacts
clean:
    cargo clean -p projector-receipt

# Check code
check:
    cargo check -p projector-receipt

# Lint code
lint:
    cargo clippy -p projector-receipt -- -D warnings
