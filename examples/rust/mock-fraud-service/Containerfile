# syntax=docker/dockerfile:1.4
# Mock Fraud Service - Simple REST API for external service integration testing
#
# Build: podman build -t mock-fraud-service -f examples/rust/mock-fraud-service/Containerfile .
# Run:   podman run -p 8080:8080 -e FRAUD_RESPONSES="CUST-BAD=declined" mock-fraud-service

# =============================================================================
# Builder - native glibc (fast compilation)
# =============================================================================
FROM docker.io/library/rust:1.92-bookworm AS builder

WORKDIR /app

# Copy workspace files needed for build
COPY Cargo.toml Cargo.lock build.rs ./
COPY proto/ ./proto/
COPY src/ ./src/
COPY angzarr-client/ ./angzarr-client/
COPY examples/rust examples/rust/

# Create stubs for test files that aren't needed
RUN mkdir -p tests/integration && \
    for f in acceptance container_integration mongodb_debug \
             storage_mongodb storage_redis storage_postgres storage_sqlite \
             standalone_integration; do \
      echo "fn main() {}" > tests/$f.rs; \
    done && \
    for f in gateway_test streaming_test query_test; do \
      echo "fn main() {}" > tests/integration/$f.rs; \
    done

# Build only the mock-fraud-service binary
RUN --mount=type=cache,target=/usr/local/cargo/registry \
    --mount=type=cache,target=/usr/local/cargo/git \
    --mount=type=cache,id=mock-fraud-target,target=/app/target \
    cargo build --release -p mock-fraud-service && \
    cp target/release/mock-fraud-service /tmp/

# =============================================================================
# Runtime - minimal debian image
# =============================================================================
FROM docker.io/library/debian:bookworm-slim AS runtime

RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app
COPY --from=builder /tmp/mock-fraud-service ./server

ENV PORT=8080
EXPOSE 8080

ENTRYPOINT ["./server"]
