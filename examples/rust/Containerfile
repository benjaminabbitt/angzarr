# syntax=docker/dockerfile:1.4
# Rust examples - multi-stage build with cargo-chef and musl for static binaries
# Build: docker build -t angzarr-rust-examples -f examples/rust/Containerfile .
# Build single: docker build --target customer -t rs-customer -f examples/rust/Containerfile .
# Uses cargo-chef for dependency caching - rebuilds only when Cargo.toml changes

# =============================================================================
# Stage 1: Chef - install cargo-chef with musl toolchain
# =============================================================================
FROM docker.io/library/rust:1.92-alpine AS chef

RUN apk add --no-cache \
    musl-dev \
    protobuf-dev \
    protoc \
    openssl-dev \
    openssl-libs-static \
    pkgconfig

RUN rustup target add x86_64-unknown-linux-musl
RUN --mount=type=cache,target=/usr/local/cargo/registry \
    --mount=type=cache,target=/usr/local/cargo/git \
    cargo install cargo-chef --locked

ENV RUSTFLAGS="-C target-feature=+crt-static"
ENV OPENSSL_STATIC=1
ENV OPENSSL_DIR=/usr

WORKDIR /app

# =============================================================================
# Stage 2: Planner - analyze dependencies
# =============================================================================
FROM chef AS planner

COPY Cargo.toml Cargo.lock build.rs ./
COPY proto/ ./proto/
COPY src/ ./src/
COPY examples/rust examples/rust/

# Create stub test files (required by Cargo.toml)
RUN mkdir -p tests && \
    echo "fn main() {}" > tests/acceptance.rs && \
    echo "fn main() {}" > tests/container_integration.rs && \
    echo "fn main() {}" > tests/mongodb_debug.rs

RUN cargo chef prepare --recipe-path recipe.json

# =============================================================================
# Stage 3: Cacher - build dependencies only (heavily cached)
# cargo-chef cooks the recipe with stub code to pre-build dependencies
# =============================================================================
FROM chef AS cacher

COPY --from=planner /app/recipe.json recipe.json

# Build dependencies with musl using chef's recipe
# This creates target/ with compiled deps that will be reused in builder
RUN --mount=type=cache,target=/usr/local/cargo/registry \
    --mount=type=cache,target=/usr/local/cargo/git \
    cargo chef cook --release --target x86_64-unknown-linux-musl --recipe-path recipe.json

# =============================================================================
# Stage 4: Builder - compile ALL binaries in single stage (shared artifacts)
# =============================================================================
FROM chef AS builder

# Copy only cached dependencies, not source files
COPY --from=cacher /app/target target
COPY --from=cacher /usr/local/cargo /usr/local/cargo

# Copy fresh source from build context (not cacher's chef-modified files)
COPY Cargo.toml Cargo.lock build.rs ./
COPY proto/ ./proto/
COPY src/ ./src/
COPY examples/rust examples/rust/

RUN mkdir -p tests && \
    echo "fn main() {}" > tests/acceptance.rs && \
    echo "fn main() {}" > tests/container_integration.rs && \
    echo "fn main() {}" > tests/mongodb_debug.rs

# Build all example binaries in single invocation - cargo resolves all deps once
RUN --mount=type=cache,target=/usr/local/cargo/registry \
    --mount=type=cache,target=/usr/local/cargo/git \
    cargo build --release --target x86_64-unknown-linux-musl \
    -p customer --bin customer-server \
    -p transaction --bin transaction-server \
    -p saga-loyalty --bin saga-loyalty-server \
    -p projector-receipt --bin projector-receipt-server \
    -p projector-log-customer --bin projector-log-customer-server \
    -p projector-log-transaction --bin projector-log-transaction-server

# ============================================================================
# Runtime stage - minimal distroless image
# ============================================================================
FROM gcr.io/distroless/static-debian12:nonroot AS runtime

WORKDIR /app
USER nonroot:nonroot

# ============================================================================
# Service-specific images (use --target)
# ============================================================================
FROM runtime AS customer
COPY --from=builder /app/target/x86_64-unknown-linux-musl/release/customer-server ./server
ENV PORT=50100
EXPOSE 50100
ENTRYPOINT ["./server"]

FROM runtime AS transaction
COPY --from=builder /app/target/x86_64-unknown-linux-musl/release/transaction-server ./server
ENV PORT=50101
EXPOSE 50101
ENTRYPOINT ["./server"]

FROM runtime AS saga-loyalty
COPY --from=builder /app/target/x86_64-unknown-linux-musl/release/saga-loyalty-server ./server
ENV PORT=50102
EXPOSE 50102
ENTRYPOINT ["./server"]

FROM runtime AS projector-receipt
COPY --from=builder /app/target/x86_64-unknown-linux-musl/release/projector-receipt-server ./server
ENV PORT=50103
EXPOSE 50103
ENTRYPOINT ["./server"]

FROM runtime AS projector-log-customer
COPY --from=builder /app/target/x86_64-unknown-linux-musl/release/projector-log-customer-server ./server
ENV PORT=50104
EXPOSE 50104
ENTRYPOINT ["./server"]

FROM runtime AS projector-log-transaction
COPY --from=builder /app/target/x86_64-unknown-linux-musl/release/projector-log-transaction-server ./server
ENV PORT=50105
EXPOSE 50105
ENTRYPOINT ["./server"]
