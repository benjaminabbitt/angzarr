# syntax=docker/dockerfile:1.4
# Rust example images - unified dev/release build
#
# Dev (fast):     podman build --target agg-order-dev -t agg-order-rs -f examples/rust/Containerfile .
# Release (slow): podman build --target agg-order -t agg-order-rs -f examples/rust/Containerfile .
#
# Dev uses native glibc target + debian runtime (no cross-compilation)
# Release uses musl static target + scratch runtime (smallest images)

# =============================================================================
# Dev builder - native glibc (fast compilation)
# =============================================================================
FROM docker.io/library/rust:1.92-bookworm AS builder-dev

RUN apt-get update && apt-get install -y --no-install-recommends \
    protobuf-compiler \
    libprotobuf-dev \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

COPY Cargo.toml Cargo.lock build.rs ./
COPY proto/ ./proto/
COPY src/ ./src/
COPY angzarr-client/ ./angzarr-client/
COPY examples/rust examples/rust/

RUN mkdir -p tests/integration && \
    for f in acceptance container_integration mongodb_debug \
             storage_mongodb storage_redis storage_postgres storage_sqlite \
             standalone_integration; do \
      echo "fn main() {}" > tests/$f.rs; \
    done && \
    for f in gateway_test streaming_test query_test; do \
      echo "fn main() {}" > tests/integration/$f.rs; \
    done

RUN --mount=type=cache,target=/usr/local/cargo/registry \
    --mount=type=cache,target=/usr/local/cargo/git \
    --mount=type=cache,id=examples-target,target=/app/target \
    cargo build --profile container-dev \
    -p agg-order --bin agg-order-server \
    -p agg-inventory --bin agg-inventory-server \
    -p agg-fulfillment --bin agg-fulfillment-server \
    -p sag-order-fulfillment --bin sag-order-fulfillment-server \
    -p sag-order-inventory --bin sag-order-inventory-server \
    -p sag-fulfillment-inventory --bin sag-fulfillment-inventory-server \
    -p pmg-fulfillment --bin pmg-fulfillment-server \
    -p prj-inventory --bin prj-inventory-server && \
    cp target/container-dev/*-server /tmp/

# =============================================================================
# Release builder - musl static (small images)
# =============================================================================
FROM docker.io/library/rust:1.92-alpine AS builder-release

RUN apk add --no-cache \
    musl-dev \
    protobuf-dev \
    protoc \
    openssl-dev \
    openssl-libs-static \
    pkgconfig

RUN rustup target add x86_64-unknown-linux-musl

ENV RUSTFLAGS="-C target-feature=+crt-static"
ENV OPENSSL_STATIC=1
ENV OPENSSL_DIR=/usr

WORKDIR /app

COPY Cargo.toml Cargo.lock build.rs ./
COPY proto/ ./proto/
COPY src/ ./src/
COPY angzarr-client/ ./angzarr-client/
COPY examples/rust examples/rust/

RUN mkdir -p tests/integration && \
    for f in acceptance container_integration mongodb_debug \
             storage_mongodb storage_redis storage_postgres storage_sqlite \
             standalone_integration; do \
      echo "fn main() {}" > tests/$f.rs; \
    done && \
    for f in gateway_test streaming_test query_test; do \
      echo "fn main() {}" > tests/integration/$f.rs; \
    done

RUN --mount=type=cache,target=/usr/local/cargo/registry \
    --mount=type=cache,target=/usr/local/cargo/git \
    cargo build --release --target x86_64-unknown-linux-musl \
    -p agg-order --bin agg-order-server \
    -p agg-inventory --bin agg-inventory-server \
    -p agg-fulfillment --bin agg-fulfillment-server \
    -p sag-order-fulfillment --bin sag-order-fulfillment-server \
    -p sag-order-inventory --bin sag-order-inventory-server \
    -p sag-fulfillment-inventory --bin sag-fulfillment-inventory-server \
    -p pmg-fulfillment --bin pmg-fulfillment-server \
    -p prj-inventory --bin prj-inventory-server && \
    cp target/x86_64-unknown-linux-musl/release/*-server /tmp/

# =============================================================================
# Runtime bases
# =============================================================================
FROM docker.io/library/debian:bookworm-slim AS runtime-dev-base
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    gdb \
    gdbserver \
    && rm -rf /var/lib/apt/lists/*
WORKDIR /app

FROM scratch AS runtime-release-base
WORKDIR /app

# =============================================================================
# Dev images - Domain Aggregates
# =============================================================================
FROM runtime-dev-base AS agg-order-dev
COPY --from=builder-dev /tmp/agg-order-server ./server
ENV PORT=50000
EXPOSE 50000
ENTRYPOINT ["./server"]

FROM runtime-dev-base AS agg-inventory-dev
COPY --from=builder-dev /tmp/agg-inventory-server ./server
ENV PORT=50003
EXPOSE 50003
ENTRYPOINT ["./server"]

FROM runtime-dev-base AS agg-fulfillment-dev
COPY --from=builder-dev /tmp/agg-fulfillment-server ./server
ENV PORT=50006
EXPOSE 50006
ENTRYPOINT ["./server"]

# =============================================================================
# Dev images - Sagas
# =============================================================================
FROM runtime-dev-base AS sag-order-fulfillment-dev
COPY --from=builder-dev /tmp/sag-order-fulfillment-server ./server
ENV PORT=50018
EXPOSE 50018
ENTRYPOINT ["./server"]

FROM runtime-dev-base AS sag-order-inventory-dev
COPY --from=builder-dev /tmp/sag-order-inventory-server ./server
ENV PORT=50021
EXPOSE 50021
ENTRYPOINT ["./server"]

FROM runtime-dev-base AS sag-fulfillment-inventory-dev
COPY --from=builder-dev /tmp/sag-fulfillment-inventory-server ./server
ENV PORT=50024
EXPOSE 50024
ENTRYPOINT ["./server"]

# =============================================================================
# Dev images - Process Managers
# =============================================================================
FROM runtime-dev-base AS pmg-fulfillment-dev
COPY --from=builder-dev /tmp/pmg-fulfillment-server ./server
ENV PORT=50039
EXPOSE 50039
ENTRYPOINT ["./server"]

# =============================================================================
# Dev images - Projectors
# =============================================================================
FROM runtime-dev-base AS prj-inventory-dev
COPY --from=builder-dev /tmp/prj-inventory-server ./server
ENV PORT=50033
EXPOSE 50033
ENTRYPOINT ["./server"]

# =============================================================================
# Release images - Domain Aggregates
# =============================================================================
FROM runtime-release-base AS agg-order
COPY --from=builder-release /tmp/agg-order-server ./server
ENV PORT=50000
EXPOSE 50000
ENTRYPOINT ["./server"]

FROM runtime-release-base AS agg-inventory
COPY --from=builder-release /tmp/agg-inventory-server ./server
ENV PORT=50003
EXPOSE 50003
ENTRYPOINT ["./server"]

FROM runtime-release-base AS agg-fulfillment
COPY --from=builder-release /tmp/agg-fulfillment-server ./server
ENV PORT=50006
EXPOSE 50006
ENTRYPOINT ["./server"]

# =============================================================================
# Release images - Sagas
# =============================================================================
FROM runtime-release-base AS sag-order-fulfillment
COPY --from=builder-release /tmp/sag-order-fulfillment-server ./server
ENV PORT=50018
EXPOSE 50018
ENTRYPOINT ["./server"]

FROM runtime-release-base AS sag-order-inventory
COPY --from=builder-release /tmp/sag-order-inventory-server ./server
ENV PORT=50021
EXPOSE 50021
ENTRYPOINT ["./server"]

FROM runtime-release-base AS sag-fulfillment-inventory
COPY --from=builder-release /tmp/sag-fulfillment-inventory-server ./server
ENV PORT=50024
EXPOSE 50024
ENTRYPOINT ["./server"]

# =============================================================================
# Release images - Process Managers
# =============================================================================
FROM runtime-release-base AS pmg-fulfillment
COPY --from=builder-release /tmp/pmg-fulfillment-server ./server
ENV PORT=50039
EXPOSE 50039
ENTRYPOINT ["./server"]

# =============================================================================
# Release images - Projectors
# =============================================================================
FROM runtime-release-base AS prj-inventory
COPY --from=builder-release /tmp/prj-inventory-server ./server
ENV PORT=50033
EXPOSE 50033
ENTRYPOINT ["./server"]
