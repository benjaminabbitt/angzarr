# syntax=docker/dockerfile:1.4
# Rust poker examples - optimized multi-stage build
# Build: podman build -t rust-poker-player --target agg-player -f examples/rust/Containerfile .
# Multi-arch: podman build --platform linux/amd64,linux/arm64 ...
# Context must be repo root for proto access
#
# Optimizations:
# 1. Shared deps-fetcher stage - cargo build deps runs once
# 2. Named cache IDs for cargo registry/target persistence
# 3. Dev vs release profiles (fast dev builds, minimal release images)
# 4. Distroless runtime for release - minimal attack surface
# 5. Multi-arch support (amd64 + arm64)
#
# Base images from ghcr.io/angzarr (see build/images/)

ARG RUST_IMAGE=ghcr.io/angzarr/angzarr-rust:latest
ARG RUST_VERSION=1.92

# ============================================================================
# Dev builder - native glibc (fast compilation)
# Uses custom angzarr-rust image with protoc and mold pre-installed
# ============================================================================
FROM ${RUST_IMAGE} AS builder-dev-deps

# protoc and libs already in base image

WORKDIR /app

# Copy proto files (needed by client library build.rs)
COPY proto ./proto

# Copy client library manifests
COPY client/rust/Cargo.toml ./client/rust/Cargo.toml
COPY client/rust/build.rs ./client/rust/build.rs

# Copy examples workspace manifests
COPY examples/rust/Cargo.toml examples/rust/Cargo.lock ./examples/rust/
COPY examples/rust/player/agg/Cargo.toml ./examples/rust/player/agg/Cargo.toml
COPY examples/rust/table/agg/Cargo.toml ./examples/rust/table/agg/Cargo.toml
COPY examples/rust/hand/agg/Cargo.toml ./examples/rust/hand/agg/Cargo.toml

# Create minimal stubs
RUN mkdir -p client/rust/src \
    examples/rust/player/agg/src \
    examples/rust/table/agg/src \
    examples/rust/hand/agg/src && \
    echo "pub fn stub() {}" > client/rust/src/lib.rs && \
    echo "fn main() {}" > examples/rust/player/agg/src/main.rs && \
    echo "fn main() {}" > examples/rust/table/agg/src/main.rs && \
    echo "fn main() {}" > examples/rust/hand/agg/src/main.rs

# Build deps only with persistent cache
WORKDIR /app/examples/rust
RUN --mount=type=cache,id=rust-cargo-registry,target=/usr/local/cargo/registry,sharing=locked \
    --mount=type=cache,id=rust-cargo-git,target=/usr/local/cargo/git,sharing=locked \
    cargo build --profile container-dev --workspace 2>/dev/null || true

# ============================================================================
# Dev builder - source
# ============================================================================
FROM builder-dev-deps AS builder-dev

WORKDIR /app

# Copy real source
COPY client/rust/src ./client/rust/src
COPY examples/rust/player/agg/src ./examples/rust/player/agg/src
COPY examples/rust/table/agg/src ./examples/rust/table/agg/src
COPY examples/rust/hand/agg/src ./examples/rust/hand/agg/src

# Build all with persistent cache
WORKDIR /app/examples/rust
RUN --mount=type=cache,id=rust-cargo-registry,target=/usr/local/cargo/registry,sharing=locked \
    --mount=type=cache,id=rust-cargo-git,target=/usr/local/cargo/git,sharing=locked \
    cargo build --profile container-dev --workspace && \
    cp target/container-dev/agg-player /tmp/ && \
    cp target/container-dev/agg-table /tmp/ && \
    cp target/container-dev/agg-hand /tmp/

# ============================================================================
# Release builder - musl static for minimal images
# ============================================================================
FROM docker.io/library/rust:${RUST_VERSION}-alpine AS builder-release-deps

ARG TARGETARCH

RUN apk add --no-cache \
    musl-dev \
    protobuf-dev \
    protoc \
    openssl-dev \
    openssl-libs-static \
    pkgconfig

RUN rustup target add x86_64-unknown-linux-musl aarch64-unknown-linux-musl

ENV RUSTFLAGS="-C target-feature=+crt-static"
ENV OPENSSL_STATIC=1
ENV OPENSSL_DIR=/usr

WORKDIR /app

# Copy proto files
COPY proto ./proto

# Copy client library manifests
COPY client/rust/Cargo.toml ./client/rust/Cargo.toml
COPY client/rust/build.rs ./client/rust/build.rs

# Copy examples workspace manifests
COPY examples/rust/Cargo.toml examples/rust/Cargo.lock ./examples/rust/
COPY examples/rust/player/agg/Cargo.toml ./examples/rust/player/agg/Cargo.toml
COPY examples/rust/table/agg/Cargo.toml ./examples/rust/table/agg/Cargo.toml
COPY examples/rust/hand/agg/Cargo.toml ./examples/rust/hand/agg/Cargo.toml

# Create minimal stubs
RUN mkdir -p client/rust/src \
    examples/rust/player/agg/src \
    examples/rust/table/agg/src \
    examples/rust/hand/agg/src && \
    echo "pub fn stub() {}" > client/rust/src/lib.rs && \
    echo "fn main() {}" > examples/rust/player/agg/src/main.rs && \
    echo "fn main() {}" > examples/rust/table/agg/src/main.rs && \
    echo "fn main() {}" > examples/rust/hand/agg/src/main.rs

# Build deps with persistent cache
WORKDIR /app/examples/rust
RUN --mount=type=cache,id=rust-musl-cargo-registry,target=/usr/local/cargo/registry,sharing=locked \
    --mount=type=cache,id=rust-musl-cargo-git,target=/usr/local/cargo/git,sharing=locked \
    if [ "$TARGETARCH" = "arm64" ]; then \
        TARGET="aarch64-unknown-linux-musl"; \
    else \
        TARGET="x86_64-unknown-linux-musl"; \
    fi && \
    cargo build --profile production --target $TARGET --workspace 2>/dev/null || true

# ============================================================================
# Release builder - source
# ============================================================================
FROM builder-release-deps AS builder-release

ARG TARGETARCH

WORKDIR /app

COPY client/rust/src ./client/rust/src
COPY examples/rust/player/agg/src ./examples/rust/player/agg/src
COPY examples/rust/table/agg/src ./examples/rust/table/agg/src
COPY examples/rust/hand/agg/src ./examples/rust/hand/agg/src

WORKDIR /app/examples/rust
RUN --mount=type=cache,id=rust-musl-cargo-registry,target=/usr/local/cargo/registry,sharing=locked \
    --mount=type=cache,id=rust-musl-cargo-git,target=/usr/local/cargo/git,sharing=locked \
    if [ "$TARGETARCH" = "arm64" ]; then \
        TARGET="aarch64-unknown-linux-musl"; \
    else \
        TARGET="x86_64-unknown-linux-musl"; \
    fi && \
    cargo build --profile production --target $TARGET --workspace && \
    cp target/$TARGET/production/agg-player /tmp/ && \
    cp target/$TARGET/production/agg-table /tmp/ && \
    cp target/$TARGET/production/agg-hand /tmp/

# ============================================================================
# Runtime bases
# ============================================================================
FROM docker.io/library/debian:bookworm-slim AS runtime-dev-base
RUN apt-get update && apt-get install -y --no-install-recommends ca-certificates \
    && rm -rf /var/lib/apt/lists/*
WORKDIR /app
ENV RUST_LOG=info

FROM gcr.io/distroless/static-debian12:nonroot AS runtime-release-base
WORKDIR /app
USER nonroot:nonroot
ENV RUST_LOG=info

# ============================================================================
# Dev images (fast builds, larger runtime with debug tools)
# ============================================================================
FROM runtime-dev-base AS agg-player-dev
COPY --from=builder-dev /tmp/agg-player ./server
ENV PORT=50001
EXPOSE 50001
ENTRYPOINT ["./server"]

FROM runtime-dev-base AS agg-table-dev
COPY --from=builder-dev /tmp/agg-table ./server
ENV PORT=50002
EXPOSE 50002
ENTRYPOINT ["./server"]

FROM runtime-dev-base AS agg-hand-dev
COPY --from=builder-dev /tmp/agg-hand ./server
ENV PORT=50003
EXPOSE 50003
ENTRYPOINT ["./server"]

# ============================================================================
# Release images (minimal, secure)
# ============================================================================
FROM runtime-release-base AS agg-player
COPY --from=builder-release --chown=nonroot:nonroot /tmp/agg-player ./server
ENV PORT=50001
EXPOSE 50001
ENTRYPOINT ["./server"]

FROM runtime-release-base AS agg-table
COPY --from=builder-release --chown=nonroot:nonroot /tmp/agg-table ./server
ENV PORT=50002
EXPOSE 50002
ENTRYPOINT ["./server"]

FROM runtime-release-base AS agg-hand
COPY --from=builder-release --chown=nonroot:nonroot /tmp/agg-hand ./server
ENV PORT=50003
EXPOSE 50003
ENTRYPOINT ["./server"]
