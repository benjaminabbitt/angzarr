# syntax=docker/dockerfile:1.4
# Rust examples - optimized multi-stage build with cargo-chef and optional UPX
# Build dev: podman build --target customer -t rs-customer -f examples/rust/Containerfile .
# Build prod: podman build --build-arg COMPRESS=true --target customer -t rs-customer -f examples/rust/Containerfile .
# Multi-arch: podman build --platform linux/amd64,linux/arm64 ...
#
# Optimizations:
# 1. cargo-chef for aggressive dependency caching
# 2. Single compilation step for all 9 binaries (shared deps)
# 3. Optional UPX compression (COMPRESS=true for prod, false for dev)
# 4. Scratch runtime - absolute minimal image (~2-3MB compressed)
# 5. MUSL static binaries (no libc dependency)
# 6. Multi-arch support (amd64 + arm64)

ARG COMPRESS=false

# =============================================================================
# Stage 1: Chef - install cargo-chef with musl toolchain
# =============================================================================
FROM docker.io/library/rust:1.92-alpine AS chef

RUN apk add --no-cache \
    musl-dev \
    protobuf-dev \
    protoc \
    openssl-dev \
    openssl-libs-static \
    pkgconfig

RUN rustup target add x86_64-unknown-linux-musl
RUN --mount=type=cache,target=/usr/local/cargo/registry \
    --mount=type=cache,target=/usr/local/cargo/git \
    cargo install cargo-chef --locked

ENV RUSTFLAGS="-C target-feature=+crt-static"
ENV OPENSSL_STATIC=1
ENV OPENSSL_DIR=/usr

WORKDIR /app

# =============================================================================
# Stage 2: Planner - analyze dependencies
# =============================================================================
FROM chef AS planner

COPY Cargo.toml Cargo.lock build.rs ./
COPY proto/ ./proto/
COPY src/ ./src/
COPY examples/rust examples/rust/

# Create stub test files (required by Cargo.toml)
RUN mkdir -p tests && \
    echo "fn main() {}" > tests/acceptance.rs && \
    echo "fn main() {}" > tests/container_integration.rs && \
    echo "fn main() {}" > tests/mongodb_debug.rs

RUN cargo chef prepare --recipe-path recipe.json

# =============================================================================
# Stage 3: Cacher - build dependencies only (heavily cached)
# =============================================================================
FROM chef AS cacher

COPY --from=planner /app/recipe.json recipe.json

RUN --mount=type=cache,target=/usr/local/cargo/registry \
    --mount=type=cache,target=/usr/local/cargo/git \
    cargo chef cook --release --target x86_64-unknown-linux-musl --recipe-path recipe.json

# =============================================================================
# Stage 4: Builder - compile ALL binaries in single invocation
# =============================================================================
FROM chef AS builder

COPY --from=cacher /app/target target
COPY --from=cacher /usr/local/cargo /usr/local/cargo

COPY Cargo.toml Cargo.lock build.rs ./
COPY proto/ ./proto/
COPY src/ ./src/
COPY examples/rust examples/rust/

RUN mkdir -p tests && \
    echo "fn main() {}" > tests/acceptance.rs && \
    echo "fn main() {}" > tests/container_integration.rs && \
    echo "fn main() {}" > tests/mongodb_debug.rs

# Build all 9 binaries in single invocation - maximum cache reuse
RUN --mount=type=cache,target=/usr/local/cargo/registry \
    --mount=type=cache,target=/usr/local/cargo/git \
    cargo build --release --target x86_64-unknown-linux-musl \
    -p customer --bin customer-server \
    -p product --bin product-server \
    -p inventory@0.1.0 --bin inventory-server \
    -p order --bin order-server \
    -p cart --bin cart-server \
    -p fulfillment --bin fulfillment-server \
    -p saga-loyalty-earn --bin saga-loyalty-earn-server \
    -p saga-fulfillment --bin saga-fulfillment-server \
    -p saga-cancellation --bin saga-cancellation-server

# =============================================================================
# Stage 5: UPX compression (conditional)
# =============================================================================
FROM alpine:3.21 AS upx-base
RUN apk add --no-cache upx

FROM upx-base AS compress-customer
ARG COMPRESS
COPY --from=builder /app/target/x86_64-unknown-linux-musl/release/customer-server /server
RUN if [ "$COMPRESS" = "true" ]; then upx --best --lzma /server; fi

FROM upx-base AS compress-product
ARG COMPRESS
COPY --from=builder /app/target/x86_64-unknown-linux-musl/release/product-server /server
RUN if [ "$COMPRESS" = "true" ]; then upx --best --lzma /server; fi

FROM upx-base AS compress-inventory
ARG COMPRESS
COPY --from=builder /app/target/x86_64-unknown-linux-musl/release/inventory-server /server
RUN if [ "$COMPRESS" = "true" ]; then upx --best --lzma /server; fi

FROM upx-base AS compress-order
ARG COMPRESS
COPY --from=builder /app/target/x86_64-unknown-linux-musl/release/order-server /server
RUN if [ "$COMPRESS" = "true" ]; then upx --best --lzma /server; fi

FROM upx-base AS compress-cart
ARG COMPRESS
COPY --from=builder /app/target/x86_64-unknown-linux-musl/release/cart-server /server
RUN if [ "$COMPRESS" = "true" ]; then upx --best --lzma /server; fi

FROM upx-base AS compress-fulfillment
ARG COMPRESS
COPY --from=builder /app/target/x86_64-unknown-linux-musl/release/fulfillment-server /server
RUN if [ "$COMPRESS" = "true" ]; then upx --best --lzma /server; fi

FROM upx-base AS compress-saga-loyalty-earn
ARG COMPRESS
COPY --from=builder /app/target/x86_64-unknown-linux-musl/release/saga-loyalty-earn-server /server
RUN if [ "$COMPRESS" = "true" ]; then upx --best --lzma /server; fi

FROM upx-base AS compress-saga-fulfillment
ARG COMPRESS
COPY --from=builder /app/target/x86_64-unknown-linux-musl/release/saga-fulfillment-server /server
RUN if [ "$COMPRESS" = "true" ]; then upx --best --lzma /server; fi

FROM upx-base AS compress-saga-cancellation
ARG COMPRESS
COPY --from=builder /app/target/x86_64-unknown-linux-musl/release/saga-cancellation-server /server
RUN if [ "$COMPRESS" = "true" ]; then upx --best --lzma /server; fi

# ============================================================================
# Runtime base - scratch (absolute minimal, static binary only)
# ============================================================================
FROM scratch AS runtime
WORKDIR /app

# ============================================================================
# Domain Aggregates
# ============================================================================
FROM runtime AS customer
COPY --from=compress-customer /server ./server
ENV PORT=50055
EXPOSE 50055
ENTRYPOINT ["./server"]

FROM runtime AS product
COPY --from=compress-product /server ./server
ENV PORT=50053
EXPOSE 50053
ENTRYPOINT ["./server"]

FROM runtime AS inventory
COPY --from=compress-inventory /server ./server
ENV PORT=50054
EXPOSE 50054
ENTRYPOINT ["./server"]

FROM runtime AS order
COPY --from=compress-order /server ./server
ENV PORT=50056
EXPOSE 50056
ENTRYPOINT ["./server"]

FROM runtime AS cart
COPY --from=compress-cart /server ./server
ENV PORT=50057
EXPOSE 50057
ENTRYPOINT ["./server"]

FROM runtime AS fulfillment
COPY --from=compress-fulfillment /server ./server
ENV PORT=50058
EXPOSE 50058
ENTRYPOINT ["./server"]

# ============================================================================
# Sagas
# ============================================================================
FROM runtime AS saga-loyalty-earn
COPY --from=compress-saga-loyalty-earn /server ./server
ENV PORT=50060
EXPOSE 50060
ENTRYPOINT ["./server"]

FROM runtime AS saga-fulfillment
COPY --from=compress-saga-fulfillment /server ./server
ENV PORT=50061
EXPOSE 50061
ENTRYPOINT ["./server"]

FROM runtime AS saga-cancellation
COPY --from=compress-saga-cancellation /server ./server
ENV PORT=50062
EXPOSE 50062
ENTRYPOINT ["./server"]
