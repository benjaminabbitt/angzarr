apiVersion: skaffold/v4beta11
kind: Config
metadata:
  name: poker-rust

# Requires base angzarr infrastructure
requires:
  - path: ../../skaffold.yaml

build:
  tagPolicy:
    gitCommit:
      prefix: "dev-"
      variant: AbbrevCommitSha
  local:
    push: true
    useBuildkit: false
    concurrency: 1
  artifacts:
    # Dev targets (fast builds)
    - image: localhost:5001/poker-rust-player
      context: ../..
      docker:
        dockerfile: examples/rust/Containerfile
        target: agg-player-dev

    - image: localhost:5001/poker-rust-table
      context: ../..
      docker:
        dockerfile: examples/rust/Containerfile
        target: agg-table-dev

    - image: localhost:5001/poker-rust-hand
      context: ../..
      docker:
        dockerfile: examples/rust/Containerfile
        target: agg-hand-dev

deploy:
  helm:
    releases:
      - name: poker-rust
        chartPath: ../../deploy/helm/angzarr
        namespace: angzarr
        createNamespace: true
        valuesFiles:
          - values.yaml
        setValues:
          # Player aggregate
          applications.business[0].name: poker-player
          applications.business[0].image.repository: localhost:5001/poker-rust-player
          applications.business[0].image.tag: latest
          applications.business[0].domain: player
          applications.business[0].port: 50001
          # Table aggregate
          applications.business[1].name: poker-table
          applications.business[1].image.repository: localhost:5001/poker-rust-table
          applications.business[1].image.tag: latest
          applications.business[1].domain: table
          applications.business[1].port: 50002
          # Hand aggregate
          applications.business[2].name: poker-hand
          applications.business[2].image.repository: localhost:5001/poker-rust-hand
          applications.business[2].image.tag: latest
          applications.business[2].domain: hand
          applications.business[2].port: 50003

profiles:
  # Release profile - slower builds, minimal images
  - name: release
    build:
      artifacts:
        - image: localhost:5001/poker-rust-player
          context: ../..
          docker:
            dockerfile: examples/rust/Containerfile
            target: agg-player

        - image: localhost:5001/poker-rust-table
          context: ../..
          docker:
            dockerfile: examples/rust/Containerfile
            target: agg-table

        - image: localhost:5001/poker-rust-hand
          context: ../..
          docker:
            dockerfile: examples/rust/Containerfile
            target: agg-hand
