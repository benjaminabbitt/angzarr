# Standalone mode configuration for Python Poker example
# Run with: ANGZARR_CONFIG=examples/python/standalone.yaml ./target/debug/angzarr-standalone
#
# NOTE: Coordinators that need Python client access must expose TCP ports.
# grpc-python 1.57+ has a cross-language interop issue with tonic (Rust)
# over Unix Domain Sockets, causing "RST_STREAM with error code 1".
# See: https://github.com/hyperium/tonic/issues/826
#      https://github.com/grpc/grpc/issues/34760
# UDS works fine for Rust-to-Rust and Python-to-Python communication.

storage:
  type: sqlite

transport:
  type: uds
  uds:
    base_path: ./tmp

messaging:
  type: ipc
  ipc:
    base_path: ./tmp

standalone:
  aggregates:
    - domain: player
      port: 50401
      command: ["uv", "run", "python", "player/agg/main.py"]
      env:
        UDS_BASE_PATH: ./tmp
        SERVICE_NAME: business
        DOMAIN: player
      storage:
        type: sqlite
        sqlite:
          path: ./data/player.db

    - domain: table
      port: 50402
      command: ["uv", "run", "python", "table/agg/main.py"]
      env:
        UDS_BASE_PATH: ./tmp
        SERVICE_NAME: business
        DOMAIN: table
      storage:
        type: sqlite
        sqlite:
          path: ./data/table.db

    - domain: hand
      port: 50403
      command: ["uv", "run", "python", "hand/agg/main.py"]
      env:
        UDS_BASE_PATH: ./tmp
        SERVICE_NAME: business
        DOMAIN: hand
      storage:
        type: sqlite
        sqlite:
          path: ./data/hand.db

  sagas:
    - name: saga-table-hand
      port: 50411
      source_domain: table
      target_domain: hand
      command: ["uv", "run", "python", "table/saga-hand/main.py"]
      env:
        UDS_BASE_PATH: ./tmp

    - name: saga-hand-table
      port: 50412
      source_domain: hand
      target_domain: table
      command: ["uv", "run", "python", "hand/saga-table/main.py"]
      env:
        UDS_BASE_PATH: ./tmp

    - name: saga-table-player
      port: 50413
      source_domain: table
      target_domain: player
      command: ["uv", "run", "python", "table/saga-player/main.py"]
      env:
        UDS_BASE_PATH: ./tmp

    - name: saga-hand-player
      port: 50414
      source_domain: hand
      target_domain: player
      command: ["uv", "run", "python", "hand/saga-player/main.py"]
      env:
        UDS_BASE_PATH: ./tmp

  process_managers:
    - name: hand-flow
      port: 50491
      pm_domain: hand-flow
      input_domains: [table, hand]
      command: ["uv", "run", "python", "hand-flow/main.py"]
      env:
        UDS_BASE_PATH: ./tmp

  projectors:
    - name: prj-output
      port: 50490
      listen_domains: [player, table, hand]
      command: ["uv", "run", "python", "prj-output/main.py"]
      env:
        UDS_BASE_PATH: ./tmp
        SERVICE_NAME: projector
        PROJECTOR_NAME: output
        HAND_LOG_FILE: ./hand_log.txt

  gateway:
    enabled: true
    port: 9084
