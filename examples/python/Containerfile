# syntax=docker/dockerfile:1.4
# Python examples - multi-stage build with uv
# Build: podman build -t py-customer --target customer -f examples/python/Containerfile .
# Context must be repo root for generated proto access
# Cache mounts persist uv packages across builds

# ============================================================================
# Builder stage - installs dependencies with uv
# ============================================================================
FROM docker.io/library/python:3.12-slim AS builder

COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv

WORKDIR /app

# Copy generated proto files from repo root
COPY generated/angzarr angzarr/proto/
COPY generated/examples proto/
RUN touch angzarr/__init__.py angzarr/proto/__init__.py proto/__init__.py

# ============================================================================
# Build each service with uv cache mounts
# ============================================================================
FROM builder AS build-customer
COPY examples/python/customer/pyproject.toml .
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --no-dev
COPY examples/python/customer/*.py ./

FROM builder AS build-transaction
COPY examples/python/transaction/pyproject.toml .
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --no-dev
COPY examples/python/transaction/*.py ./

FROM builder AS build-saga-loyalty
COPY examples/python/saga-loyalty/pyproject.toml .
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --no-dev
COPY examples/python/saga-loyalty/*.py ./

FROM builder AS build-projector-receipt
COPY examples/python/projector-receipt/pyproject.toml .
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --no-dev
COPY examples/python/projector-receipt/*.py ./

FROM builder AS build-projector-log-customer
COPY examples/python/projector-log-customer/pyproject.toml .
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --no-dev
COPY examples/python/projector-log-customer/*.py ./

FROM builder AS build-projector-log-transaction
COPY examples/python/projector-log-transaction/pyproject.toml .
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --no-dev
COPY examples/python/projector-log-transaction/*.py ./

# ============================================================================
# Runtime base
# ============================================================================
FROM docker.io/library/python:3.12-slim AS runtime
COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv
WORKDIR /app

# ============================================================================
# Service-specific images
# ============================================================================
FROM runtime AS customer
COPY --from=build-customer /app ./
ENV PORT=50300
EXPOSE 50300
CMD ["uv", "run", "python", "server.py"]

FROM runtime AS transaction
COPY --from=build-transaction /app ./
ENV PORT=50301
EXPOSE 50301
CMD ["uv", "run", "python", "server.py"]

FROM runtime AS saga-loyalty
COPY --from=build-saga-loyalty /app ./
ENV PORT=50302
EXPOSE 50302
CMD ["uv", "run", "python", "server.py"]

FROM runtime AS projector-receipt
COPY --from=build-projector-receipt /app ./
ENV PORT=50303
EXPOSE 50303
CMD ["uv", "run", "python", "server.py"]

FROM runtime AS projector-log-customer
COPY --from=build-projector-log-customer /app ./
ENV PORT=50304
EXPOSE 50304
CMD ["uv", "run", "python", "server.py"]

FROM runtime AS projector-log-transaction
COPY --from=build-projector-log-transaction /app ./
ENV PORT=50305
EXPOSE 50305
CMD ["uv", "run", "python", "server.py"]
