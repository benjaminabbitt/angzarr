# syntax=docker/dockerfile:1.4
# Python examples - optimized multi-stage build with distroless runtime
# Build: podman build -t py-customer --target customer -f examples/python/Containerfile .
# Multi-arch: podman build --platform linux/amd64,linux/arm64 ...
# Context must be repo root for generated proto access
#
# Optimizations:
# 1. Single shared venv with all common deps (grpcio, protobuf, structlog)
# 2. Distroless runtime - minimal attack surface (~50MB vs ~150MB)
# 3. Named cache IDs for uv persistence
# 4. Pre-compiled Python bytecode
# 5. Multi-arch support (amd64 + arm64)

ARG PYTHON_VERSION=3.11

# ============================================================================
# Base builder - common tooling and settings
# ============================================================================
FROM ghcr.io/astral-sh/uv:0.6 AS uv-binary

FROM docker.io/library/python:${PYTHON_VERSION}-slim AS base

# Install uv for fast package management
COPY --from=uv-binary /uv /usr/local/bin/uv

# Optimize Python
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    UV_COMPILE_BYTECODE=1 \
    UV_LINK_MODE=copy

WORKDIR /app

# ============================================================================
# Library layer - copy angzarr library (includes protos in angzarr/angzarr/)
# ============================================================================
FROM base AS with-protos

# Copy angzarr library - includes handlers AND protos (angzarr/angzarr/)
COPY examples/python/angzarr angzarr/
COPY generated/python/examples examples_proto/
RUN touch examples_proto/__init__.py && chmod -R a+r angzarr examples_proto

# ============================================================================
# Shared venv - single virtual environment with ALL common dependencies
# This is the key optimization - install expensive deps once, copy to all services
# ============================================================================
FROM with-protos AS shared-venv

RUN --mount=type=cache,id=uv-cache,target=/root/.cache/uv,sharing=locked \
    uv venv /shared-venv && \
    uv pip install --python /shared-venv \
    "grpcio>=1.60.0" \
    "grpcio-tools>=1.60.0" \
    "grpcio-health-checking>=1.60.0" \
    "protobuf>=4.25.0" \
    "structlog>=24.0.0"

# Pre-compile bytecode for shared deps
RUN /shared-venv/bin/python -m compileall -q /shared-venv 2>/dev/null || true

# ============================================================================
# Service builds - copy shared venv, add service-specific deps if needed
# ============================================================================
FROM shared-venv AS build-order
WORKDIR /service
RUN cp -r /shared-venv .venv
COPY examples/python/order/ ./
RUN chmod -R a+r . && .venv/bin/python -m compileall -q . 2>/dev/null || true

FROM shared-venv AS build-inventory
WORKDIR /service
RUN cp -r /shared-venv .venv
COPY examples/python/inventory/ ./
RUN chmod -R a+r . && .venv/bin/python -m compileall -q . 2>/dev/null || true

FROM shared-venv AS build-fulfillment
WORKDIR /service
RUN cp -r /shared-venv .venv
COPY examples/python/fulfillment/ ./
RUN chmod -R a+r . && .venv/bin/python -m compileall -q . 2>/dev/null || true

FROM shared-venv AS build-saga-fulfillment
WORKDIR /service
RUN cp -r /shared-venv .venv
COPY examples/python/saga-fulfillment/ ./
RUN chmod -R a+r . && .venv/bin/python -m compileall -q . 2>/dev/null || true

FROM shared-venv AS build-saga-inventory-reservation
WORKDIR /service
RUN cp -r /shared-venv .venv
COPY examples/python/saga-inventory-reservation/ ./
RUN chmod -R a+r . && .venv/bin/python -m compileall -q . 2>/dev/null || true

FROM shared-venv AS build-sag-fulfillment-inventory
WORKDIR /service
RUN cp -r /shared-venv .venv
COPY examples/python/sag-fulfillment-inventory/ ./
RUN chmod -R a+r . && .venv/bin/python -m compileall -q . 2>/dev/null || true

FROM shared-venv AS build-projector-inventory
WORKDIR /service
RUN cp -r /shared-venv .venv
COPY examples/python/projector-inventory/ ./
RUN chmod -R a+r . && .venv/bin/python -m compileall -q . 2>/dev/null || true

FROM shared-venv AS build-process-manager-fulfillment
WORKDIR /service
RUN cp -r /shared-venv .venv
COPY examples/python/process-manager-fulfillment/ ./
RUN chmod -R a+r . && .venv/bin/python -m compileall -q . 2>/dev/null || true

# ============================================================================
# Runtime base - distroless Python (minimal, secure)
# ============================================================================
FROM gcr.io/distroless/python3-debian12:nonroot AS runtime
WORKDIR /app
USER nonroot:nonroot

# ============================================================================
# Domain Aggregates
# Structure: /app/angzarr/ (library), /app/service/ (main.py, handlers/)
# This matches local dev where main.py uses parent.parent to find angzarr
# ============================================================================
FROM runtime AS order
COPY --from=build-order --chown=nonroot:nonroot /service ./service/
COPY --from=with-protos --chown=nonroot:nonroot /app/angzarr ./angzarr
COPY --from=with-protos --chown=nonroot:nonroot /app/examples_proto ./examples_proto
ENV PORT=50303 PYTHONPATH=/app/service/.venv/lib/python3.11/site-packages:/app/service:/app
EXPOSE 50303
WORKDIR /app/service
CMD ["main.py"]

FROM runtime AS inventory
COPY --from=build-inventory --chown=nonroot:nonroot /service ./service/
COPY --from=with-protos --chown=nonroot:nonroot /app/angzarr ./angzarr
COPY --from=with-protos --chown=nonroot:nonroot /app/examples_proto ./examples_proto
ENV PORT=50304 PYTHONPATH=/app/service/.venv/lib/python3.11/site-packages:/app/service:/app
EXPOSE 50304
WORKDIR /app/service
CMD ["main.py"]

FROM runtime AS fulfillment
COPY --from=build-fulfillment --chown=nonroot:nonroot /service ./service/
COPY --from=with-protos --chown=nonroot:nonroot /app/angzarr ./angzarr
COPY --from=with-protos --chown=nonroot:nonroot /app/examples_proto ./examples_proto
ENV PORT=50305 PYTHONPATH=/app/service/.venv/lib/python3.11/site-packages:/app/service:/app
EXPOSE 50305
WORKDIR /app/service
CMD ["main.py"]

# ============================================================================
# Sagas
# ============================================================================
FROM runtime AS saga-fulfillment
COPY --from=build-saga-fulfillment --chown=nonroot:nonroot /service ./service/
COPY --from=with-protos --chown=nonroot:nonroot /app/angzarr ./angzarr
COPY --from=with-protos --chown=nonroot:nonroot /app/examples_proto ./examples_proto
ENV PORT=50310 PYTHONPATH=/app/service/.venv/lib/python3.11/site-packages:/app/service:/app
EXPOSE 50310
WORKDIR /app/service
CMD ["main.py"]

FROM runtime AS saga-inventory-reservation
COPY --from=build-saga-inventory-reservation --chown=nonroot:nonroot /service ./service/
COPY --from=with-protos --chown=nonroot:nonroot /app/angzarr ./angzarr
COPY --from=with-protos --chown=nonroot:nonroot /app/examples_proto ./examples_proto
ENV PORT=50313 PYTHONPATH=/app/service/.venv/lib/python3.11/site-packages:/app/service:/app
EXPOSE 50313
WORKDIR /app/service
CMD ["main.py"]

FROM runtime AS sag-fulfillment-inventory
COPY --from=build-sag-fulfillment-inventory --chown=nonroot:nonroot /service ./service/
COPY --from=with-protos --chown=nonroot:nonroot /app/angzarr ./angzarr
COPY --from=with-protos --chown=nonroot:nonroot /app/examples_proto ./examples_proto
ENV PORT=50314 PYTHONPATH=/app/service/.venv/lib/python3.11/site-packages:/app/service:/app
EXPOSE 50314
WORKDIR /app/service
CMD ["main.py"]

# ============================================================================
# Projectors
# ============================================================================
FROM runtime AS projector-inventory
COPY --from=build-projector-inventory --chown=nonroot:nonroot /service ./service/
COPY --from=with-protos --chown=nonroot:nonroot /app/angzarr ./angzarr
COPY --from=with-protos --chown=nonroot:nonroot /app/examples_proto ./examples_proto
ENV PORT=50320 PYTHONPATH=/app/service/.venv/lib/python3.11/site-packages:/app/service:/app
EXPOSE 50320
WORKDIR /app/service
CMD ["main.py"]

# ============================================================================
# Process Managers
# ============================================================================
FROM runtime AS process-manager-fulfillment
COPY --from=build-process-manager-fulfillment --chown=nonroot:nonroot /service ./service/
COPY --from=with-protos --chown=nonroot:nonroot /app/angzarr ./angzarr
COPY --from=with-protos --chown=nonroot:nonroot /app/examples_proto ./examples_proto
ENV PORT=50330 PYTHONPATH=/app/service/.venv/lib/python3.11/site-packages:/app/service:/app
EXPOSE 50330
WORKDIR /app/service
CMD ["main.py"]

