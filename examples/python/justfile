# Poker engine justfile

TOP := `git rev-parse --show-toplevel`

# Default: list available commands
default:
    @just --list

# Generate Python protobuf files from proto definitions
proto:
    uv run python -m grpc_tools.protoc \
        -I{{TOP}}/proto \
        -I{{TOP}}/../angzarr/proto \
        --python_out={{TOP}}/agg-player/proto \
        --grpc_python_out={{TOP}}/agg-player/proto \
        {{TOP}}/proto/poker/*.proto
    uv run python -m grpc_tools.protoc \
        -I{{TOP}}/proto \
        -I{{TOP}}/../angzarr/proto \
        --python_out={{TOP}}/agg-table/proto \
        --grpc_python_out={{TOP}}/agg-table/proto \
        {{TOP}}/proto/poker/*.proto
    uv run python -m grpc_tools.protoc \
        -I{{TOP}}/proto \
        -I{{TOP}}/../angzarr/proto \
        --python_out={{TOP}}/agg-hand/proto \
        --grpc_python_out={{TOP}}/agg-hand/proto \
        {{TOP}}/proto/poker/*.proto
    uv run python -m grpc_tools.protoc \
        -I{{TOP}}/proto \
        -I{{TOP}}/../angzarr/proto \
        --python_out={{TOP}}/prj-output/proto \
        --grpc_python_out={{TOP}}/prj-output/proto \
        {{TOP}}/proto/poker/*.proto
    # Fix imports in generated files - rewrite poker -> proto.poker
    for f in {{TOP}}/agg-*/proto/poker/*_pb2*.py {{TOP}}/prj-*/proto/poker/*_pb2*.py; do \
        sed -i 's/from poker import/from proto.poker import/g' "$$f" 2>/dev/null || true; \
        sed -i 's/import poker\b/import proto.poker/g' "$$f" 2>/dev/null || true; \
    done
    @echo "Proto files generated"

# Run unit tests
test:
    uv run pytest -v

# Run BDD/Gherkin tests
test-bdd:
    cd "{{TOP}}/examples/python" && uv run behave features/

# Run all tests (unit + BDD)
test-all: test test-bdd

# Run player aggregate server
run-player:
    cd agg-player && uv run python main.py

# Run table aggregate server
run-table:
    cd agg-table && uv run python main.py

# Run hand aggregate server
run-hand:
    cd agg-hand && uv run python main.py

# Run output projector
run-output:
    cd prj-output && uv run python main.py

# Install dependencies
install:
    uv sync

# Format code
fmt:
    uv run black .

# Lint code
lint:
    uv run ruff check .

# Type check
typecheck:
    uv run mypy . --ignore-missing-imports
