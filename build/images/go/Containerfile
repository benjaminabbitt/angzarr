# syntax=docker/dockerfile:1.4
# Go build image for angzarr
#
# Build: podman build -t ghcr.io/angzarr-io/angzarr-go .
#
# Provides: Go toolchain, protoc-gen-go, protoc-gen-go-grpc
# Based on: ghcr.io/angzarr-io/angzarr-base

ARG BASE_IMAGE=ghcr.io/angzarr-io/angzarr-base:latest
FROM ${BASE_IMAGE}

ARG GO_VERSION=1.23.6

# Install protoc (needed for protoc-gen-go plugins)
RUN apt-get update && apt-get install -y --no-install-recommends \
    protobuf-compiler \
    && rm -rf /var/lib/apt/lists/*

# Install Go
RUN ARCH=$(dpkg --print-architecture) && \
    curl -Lo /tmp/go.tar.gz \
        "https://go.dev/dl/go${GO_VERSION}.linux-${ARCH}.tar.gz" && \
    tar -C /usr/local -xzf /tmp/go.tar.gz && \
    rm /tmp/go.tar.gz

ENV PATH=/usr/local/go/bin:/root/go/bin:$PATH \
    GOPATH=/root/go

# Install protobuf code generators for Go
RUN go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.36.0 && \
    go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@v1.5.1

# Verify installations
RUN go version && protoc-gen-go --version

WORKDIR /workspace
