# Protobuf generation container
# Generates proto files for Rust, Python, and Go

FROM golang:1.23-bookworm AS base

# Install protoc and base dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    protobuf-compiler \
    libprotobuf-dev \
    python3 \
    python3-pip \
    python3-venv \
    unzip \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Install Go protoc plugins (pinned versions compatible with Go 1.23)
RUN go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.36.0 && \
    go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@v1.5.1

# Install Python grpcio-tools
RUN python3 -m venv /opt/venv && \
    /opt/venv/bin/pip install --no-cache-dir grpcio-tools

# Install Rust (for tonic/prost generation)
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
ENV PATH="/root/.cargo/bin:${PATH}"

# Install protoc-gen-prost plugins
RUN cargo install protoc-gen-prost protoc-gen-tonic protoc-gen-prost-crate

# Set up paths
ENV PATH="/go/bin:/opt/venv/bin:${PATH}"

WORKDIR /workspace

# Copy the generation script
COPY generate.sh /usr/local/bin/generate-protos
RUN chmod +x /usr/local/bin/generate-protos

ENTRYPOINT ["/usr/local/bin/generate-protos"]
